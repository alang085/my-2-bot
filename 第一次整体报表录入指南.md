# 第一次整体报表录入指南

## 重要说明

**基准日期**是增量报表系统的关键设置。设置后，该日期**之前**的数据不会出现在增量报表中，只有该日期**之后**的数据才会作为增量数据。

## 设置基准日期的时机

### 场景1: 全新系统（推荐）
- **时机**：系统首次运行
- **操作**：系统会自动设置当前日期为基准日期
- **说明**：之后的所有数据都是增量数据

### 场景2: 已有历史数据（需要手动设置）
- **时机**：历史数据已全部录入完成后
- **操作**：手动设置基准日期为最后一次录入数据的日期
- **说明**：基准日期之后的数据才是增量数据

## 设置步骤

### 方法1: 通过数据库直接设置（推荐）

#### 步骤1: 确认历史数据完整性
```sql
-- 检查订单数据
SELECT COUNT(*) as total_orders, 
       MIN(date) as earliest_date, 
       MAX(date) as latest_date 
FROM orders;

-- 检查利息数据
SELECT COUNT(*) as total_interest, 
       MIN(date) as earliest_date, 
       MAX(date) as latest_date 
FROM income_records 
WHERE type = 'interest';

-- 检查开销数据
SELECT COUNT(*) as total_expenses, 
       MIN(date) as earliest_date, 
       MAX(date) as latest_date 
FROM expense_records;
```

#### 步骤2: 确定基准日期
**基准日期应该是最后一次完整录入数据的日期**

例如：
- 历史数据录入到：2025-12-15
- 基准日期设置为：2025-12-15
- 之后从 2025-12-16 开始的数据将作为增量数据

#### 步骤3: 设置基准日期
```sql
-- 如果表已存在，更新
UPDATE baseline_report 
SET baseline_date = '2025-12-15', 
    updated_at = CURRENT_TIMESTAMP 
WHERE id = 1;

-- 如果表不存在，插入
INSERT INTO baseline_report (id, baseline_date) 
VALUES (1, '2025-12-15');
```

#### 步骤4: 验证设置
```python
# 运行测试脚本
python test_all_excel_reports.py

# 或使用命令
# /preview_incremental
```

### 方法2: 通过Python脚本设置

创建 `set_baseline_date.py`:

```python
import asyncio
import sys
from pathlib import Path

project_root = Path(__file__).parent.absolute()
if str(project_root) not in sys.path:
    sys.path.insert(0, str(project_root))

import init_db
import db_operations

async def set_baseline():
    init_db.init_database()
    
    # 设置基准日期（修改为实际日期）
    baseline_date = '2025-12-15'
    
    success = await db_operations.save_baseline_date(baseline_date)
    if success:
        print(f"✅ 基准日期已设置为: {baseline_date}")
        
        # 验证
        retrieved = await db_operations.get_baseline_date()
        print(f"✅ 验证: {retrieved}")
    else:
        print("❌ 设置失败")

if __name__ == "__main__":
    asyncio.run(set_baseline())
```

## 验证准备情况

### 检查清单

- [ ] **历史数据完整性**
  - [ ] 所有历史订单已录入
  - [ ] 所有历史利息已录入
  - [ ] 所有历史开销已录入
  - [ ] 数据统计正确

- [ ] **基准日期设置**
  - [ ] 基准日期已设置
  - [ ] 基准日期是最后一次录入数据的日期
  - [ ] 基准日期格式正确（YYYY-MM-DD）

- [ ] **功能测试**
  - [ ] Excel报表生成正常
  - [ ] 增量数据查询正常
  - [ ] 权限设置正确

### 测试命令

```bash
# 1. 运行完整测试
python test_all_excel_reports.py

# 2. 在Telegram中测试
# /preview_incremental - 预览增量报表
# /daily_changes - 查看每日数据变更
# /ordertable - 导出订单总表
```

## 第一次增量报表生成

### 自动生成（推荐）
- **时间**：每天11:05自动生成
- **发送**：自动发送给所有管理员
- **内容**：包含从基准日期到当前日期的所有增量数据

### 手动生成
```
/preview_incremental - 预览增量报表
```

## 第一次合并操作

### 合并时机
- 确认增量报表数据正确后
- 点击Excel报表的"合并到总表"按钮
- 或使用命令：`/merge_incremental`

### 合并流程
1. 点击"合并到总表"按钮
2. 系统检查是否已合并过
3. 如果未合并，直接合并
4. 如果已合并，提示确认
5. 合并成功后更新全局数据
6. 保存合并记录

### 合并后验证
- 检查全局统计数据是否更新
- 使用 `/report` 查看报表
- 确认数据一致性

## 常见问题

### Q1: 基准日期设置错误怎么办？

**A:** 可以直接修改数据库：
```sql
UPDATE baseline_report 
SET baseline_date = '正确的日期', 
    updated_at = CURRENT_TIMESTAMP 
WHERE id = 1;
```

### Q2: 基准日期之前的数据会丢失吗？

**A:** 不会丢失。基准日期只是用来区分"历史数据"和"增量数据"：
- 基准日期之前的数据：历史数据，不会出现在增量报表中
- 基准日期之后的数据：增量数据，会出现在增量报表中
- 所有数据都保存在数据库中，可以通过其他报表查看

### Q3: 如何查看基准日期？

**A:** 有几种方法：
1. 使用命令：`/preview_incremental`（会显示基准日期）
2. 查询数据库：
   ```sql
   SELECT * FROM baseline_report WHERE id = 1;
   ```
3. 运行测试脚本：`python test_all_excel_reports.py`

### Q4: 基准日期可以修改吗？

**A:** 可以，但不建议频繁修改。如果必须修改：
1. 确认修改后的影响
2. 修改数据库
3. 验证增量数据查询是否正确

### Q5: 第一次录入后，增量报表是空的？

**A:** 这是正常的，因为：
- 如果基准日期是今天，今天之前的数据不会显示
- 只有基准日期之后的数据才会显示
- 等待明天有新数据后，增量报表就会有内容

## 最佳实践

1. **设置时机**
   - 在历史数据全部录入完成后设置
   - 选择一个明确的日期（如月末、周末）

2. **日期选择**
   - 选择最后一次完整录入数据的日期
   - 建议选择月末或周末，便于后续管理

3. **验证步骤**
   - 设置后立即验证
   - 生成测试Excel检查
   - 确认增量数据查询正常

4. **文档记录**
   - 记录基准日期设置时间
   - 记录设置原因
   - 记录相关数据统计

## 当前状态检查

运行以下命令检查当前准备情况：

```bash
python test_all_excel_reports.py
```

检查输出：
- ✅ 基准日期是否已设置
- ✅ 基准日期是否正确
- ✅ Excel报表生成是否正常
- ✅ 增量数据查询是否正常

## 下一步

1. ✅ 确认历史数据完整性
2. ✅ 设置基准日期
3. ✅ 验证设置正确
4. ✅ 测试Excel报表生成
5. ✅ 等待第一次增量报表自动生成
6. ✅ 合并第一次增量报表

