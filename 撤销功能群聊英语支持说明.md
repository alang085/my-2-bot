# æ’¤é”€åŠŸèƒ½ç¾¤èŠè‹±è¯­æ”¯æŒè¯´æ˜

## ğŸ“‹ åŠŸèƒ½è¯´æ˜

`/undo` å‘½ä»¤ç°åœ¨æ”¯æŒï¼š
1. **ç¾¤èŠä¸­çš„æ‰€æœ‰å›å¤ä½¿ç”¨è‹±è¯­**
2. **æ’¤é”€æ“ä½œåçš„ç®¡ç†å‘˜é€šçŸ¥åŒ…å«ç¾¤å**

## ğŸ”§ å®ç°ç»†èŠ‚

### 1. ç¾¤èŠå›å¤è‹±è¯­åŒ–

æ‰€æœ‰åœ¨ç¾¤èŠä¸­æ‰§è¡Œçš„ `/undo` å‘½ä»¤å›å¤éƒ½ä½¿ç”¨è‹±è¯­ï¼š

- âœ… é”™è¯¯æç¤ºï¼ˆè‹±è¯­ï¼‰
- âœ… æˆåŠŸæ¶ˆæ¯ï¼ˆè‹±è¯­ï¼‰
- âœ… æ“ä½œç±»å‹æè¿°ï¼ˆè‹±è¯­ï¼‰

### 2. ç®¡ç†å‘˜é€šçŸ¥åŒ…å«ç¾¤å

æ’¤é”€æ“ä½œæ‰§è¡Œåï¼Œå‘ç®¡ç†å‘˜å‘é€çš„é€šçŸ¥ä¸­åŒ…å«ï¼š
- **ç¾¤èŠ**ï¼šæ˜¾ç¤ºç¾¤åå’Œç¾¤èŠ ID
- **ç§èŠ**ï¼šæ˜¾ç¤º"ç§èŠ (ç”¨æˆ·ID: xxx)"

### 3. ä»£ç å®ç°

#### åˆ¤æ–­ç¾¤èŠ/ç§èŠ

```python
from utils.chat_helpers import is_group_chat

is_group = is_group_chat(update)
```

#### è·å–ç¾¤å

```python
group_name = None
if is_group and update.effective_chat:
    group_name = update.effective_chat.title
```

#### åŒè¯­æ¶ˆæ¯

æ¯ç§æ“ä½œç±»å‹éƒ½æœ‰ä¸­æ–‡å’Œè‹±æ–‡ä¸¤ä¸ªç‰ˆæœ¬çš„æ¶ˆæ¯ï¼š

```python
undo_message = f"âœ… å·²æ’¤é”€åˆ©æ¯æ”¶å…¥ {amount:.2f}"  # ä¸­æ–‡ï¼ˆç§èŠï¼‰
undo_message_en = f"âœ… Undone interest income {amount:.2f}"  # è‹±æ–‡ï¼ˆç¾¤èŠï¼‰

# å‘é€æ—¶æ ¹æ®èŠå¤©ç±»å‹é€‰æ‹©
if is_group:
    await update.message.reply_text(undo_message_en)
else:
    await update.message.reply_text(undo_message)
```

#### ç®¡ç†å‘˜é€šçŸ¥æ ¼å¼

```python
chat_info = ""
if is_group and group_name:
    chat_info = f"ç¾¤å: {group_name}\n"
elif is_group:
    chat_info = f"ç¾¤èŠ ID: {chat_id}\n"
else:
    chat_info = f"ç§èŠ (ç”¨æˆ·ID: {user_id})\n"

admin_message = (
    f"âš ï¸ æ’¤é”€æ“ä½œé€šçŸ¥\n\n"
    f"ç”¨æˆ·: {user_full_name} (@{user_name})\n"
    f"ç”¨æˆ·ID: {user_id}\n"
    f"{chat_info}"  # åŒ…å«ç¾¤åæˆ–ç§èŠä¿¡æ¯
    f"æ“ä½œç±»å‹: {operation_type}\n"
    f"æ’¤é”€è¯¦æƒ…: {undo_message if not is_group else undo_message_en}\n"
    f"è¿ç»­æ’¤é”€æ¬¡æ•°: {undo_count + 1}/{MAX_UNDO_COUNT}\n"
    f"æ“ä½œæ—¶é—´: {last_operation.get('created_at', 'N/A')}"
)
```

## âœ… æ”¯æŒçš„æ“ä½œç±»å‹

æ‰€æœ‰æ“ä½œç±»å‹éƒ½æ”¯æŒåŒè¯­ï¼š

1. âœ… **åˆ©æ¯æ”¶å…¥** (`interest`)
   - ä¸­æ–‡ï¼š`âœ… å·²æ’¤é”€åˆ©æ¯æ”¶å…¥ {amount:.2f}`
   - è‹±æ–‡ï¼š`âœ… Undone interest income {amount:.2f}`

2. âœ… **æœ¬é‡‘å‡å°‘** (`principal_reduction`)
   - ä¸­æ–‡ï¼š`âœ… å·²æ’¤é”€æœ¬é‡‘å‡å°‘ {amount:.2f}`
   - è‹±æ–‡ï¼š`âœ… Undone principal reduction {amount:.2f}`

3. âœ… **å¼€é”€è®°å½•** (`expense`)
   - ä¸­æ–‡ï¼š`âœ… å·²æ’¤é”€å…¬å¸å¼€é”€ {amount:.2f}` / `âœ… å·²æ’¤é”€å…¶ä»–å¼€é”€ {amount:.2f}`
   - è‹±æ–‡ï¼š`âœ… Undone company expense {amount:.2f}` / `âœ… Undone other expense {amount:.2f}`

4. âœ… **è®¢å•å®Œæˆ** (`order_completed`)
   - ä¸­æ–‡ï¼š`âœ… å·²æ’¤é”€è®¢å•å®Œæˆæ“ä½œ`
   - è‹±æ–‡ï¼š`âœ… Undone order completion`

5. âœ… **è¿çº¦å®Œæˆ** (`order_breach_end`)
   - ä¸­æ–‡ï¼š`âœ… å·²æ’¤é”€è¿çº¦å®Œæˆæ“ä½œ`
   - è‹±æ–‡ï¼š`âœ… Undone breach order completion`

6. âœ… **è®¢å•åˆ›å»º** (`order_created`)
   - ä¸­æ–‡ï¼š`âœ… å·²æ’¤é”€è®¢å•åˆ›å»ºï¼š{order_id}`
   - è‹±æ–‡ï¼š`âœ… Undone order creation: {order_id}`

7. âœ… **è®¢å•çŠ¶æ€å˜æ›´** (`order_state_change`)
   - ä¸­æ–‡ï¼š`âœ… å·²æ’¤é”€è®¢å•çŠ¶æ€å˜æ›´ï¼š{new_state} â†’ {old_state}`
   - è‹±æ–‡ï¼š`âœ… Undone order state change: {new_state} â†’ {old_state}`

## ğŸ“ é”™è¯¯æ¶ˆæ¯

æ‰€æœ‰é”™è¯¯æ¶ˆæ¯ä¹Ÿæ”¯æŒåŒè¯­ï¼š

- **æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯**
  - ç¾¤èŠï¼š`âŒ Unable to get user information`
  - ç§èŠï¼š`âŒ æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯`

- **æ— æ³•è·å–èŠå¤©ç¯å¢ƒä¿¡æ¯**
  - ç¾¤èŠï¼š`âŒ Unable to get chat environment information`
  - ç§èŠï¼š`âŒ æ— æ³•è·å–èŠå¤©ç¯å¢ƒä¿¡æ¯`

- **å·²è¾¾åˆ°æœ€å¤§è¿ç»­æ’¤é”€æ¬¡æ•°**
  - ç¾¤èŠï¼š`âŒ Maximum consecutive undo count reached ({MAX_UNDO_COUNT} times).\nPlease enter correct data again before using undo.`
  - ç§èŠï¼š`âŒ å·²è¾¾åˆ°æœ€å¤§è¿ç»­æ’¤é”€æ¬¡æ•°ï¼ˆ{MAX_UNDO_COUNT}æ¬¡ï¼‰ã€‚\nè¯·é‡æ–°è¾“å…¥æ­£ç¡®æ•°æ®åï¼Œå†ä½¿ç”¨æ’¤é”€åŠŸèƒ½ã€‚`

- **æ²¡æœ‰å¯æ’¤é”€çš„æ“ä½œ**
  - ç¾¤èŠï¼š`âŒ No undoable operation in this group chat.\n\nNote: /undo command can only undo the last operation executed in the current chat environment.`
  - ç§èŠï¼š`âŒ åœ¨å½“å‰ç§èŠç¯å¢ƒä¸­æ²¡æœ‰å¯æ’¤é”€çš„æ“ä½œ\n\næç¤ºï¼š/undo å‘½ä»¤åªèƒ½æ’¤é”€åœ¨å½“å‰èŠå¤©ç¯å¢ƒï¼ˆç§èŠæˆ–ç¾¤èŠï¼‰ä¸­æ‰§è¡Œçš„ä¸Šä¸€ä¸ªæ“ä½œã€‚`

- **æ’¤é”€æ“ä½œå¤±è´¥**
  - ç¾¤èŠï¼š`âŒ Undo operation failed. Please check data status.`
  - ç§èŠï¼š`âŒ æ’¤é”€æ“ä½œå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ•°æ®çŠ¶æ€`

- **æ’¤é”€æ“ä½œæ—¶å‡ºé”™**
  - ç¾¤èŠï¼š`âŒ Error during undo operation: {error}`
  - ç§èŠï¼š`âŒ æ’¤é”€æ“ä½œæ—¶å‡ºé”™: {error}`

## ğŸ“Š ç®¡ç†å‘˜é€šçŸ¥ç¤ºä¾‹

### ç¾¤èŠé€šçŸ¥

```
âš ï¸ æ’¤é”€æ“ä½œé€šçŸ¥

ç”¨æˆ·: å¼ ä¸‰ (@zhangsan)
ç”¨æˆ·ID: 123456789
ç¾¤å: è®¢å•ç¾¤ç»„ A
æ“ä½œç±»å‹: order_completed
æ’¤é”€è¯¦æƒ…: âœ… Undone order completion
è¿ç»­æ’¤é”€æ¬¡æ•°: 1/3
æ“ä½œæ—¶é—´: 2025-12-02 15:30:00
```

### ç§èŠé€šçŸ¥

```
âš ï¸ æ’¤é”€æ“ä½œé€šçŸ¥

ç”¨æˆ·: å¼ ä¸‰ (@zhangsan)
ç”¨æˆ·ID: 123456789
ç§èŠ (ç”¨æˆ·ID: 123456789)
æ“ä½œç±»å‹: expense
æ’¤é”€è¯¦æƒ…: âœ… å·²æ’¤é”€å…¬å¸å¼€é”€ 100.00
è¿ç»­æ’¤é”€æ¬¡æ•°: 1/3
æ“ä½œæ—¶é—´: 2025-12-02 15:30:00
```

## ğŸ” æŠ€æœ¯ç»†èŠ‚

### æ–‡ä»¶ä¿®æ”¹

- **`handlers/undo_handlers.py`**
  - å¯¼å…¥ `is_group_chat` å‡½æ•°
  - æ‰€æœ‰å›å¤æ¶ˆæ¯æ ¹æ® `is_group` åˆ¤æ–­ä½¿ç”¨ä¸­æ–‡æˆ–è‹±æ–‡
  - ç®¡ç†å‘˜é€šçŸ¥åŒ…å«ç¾¤åä¿¡æ¯

### ä¾èµ–

- `utils.chat_helpers.is_group_chat()` - åˆ¤æ–­æ˜¯å¦æ˜¯ç¾¤èŠ

---

**æ›´æ–°æ—¥æœŸ**: 2025-12-02  
**çŠ¶æ€**: âœ… å·²å®Œæˆ

