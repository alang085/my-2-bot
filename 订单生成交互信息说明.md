# è®¢å•ç”Ÿæˆåçš„äº¤äº’ä¿¡æ¯å†…å®¹

## ğŸ“‹ æ¦‚è¿°

è®¢å•åˆ›å»ºæˆåŠŸåï¼Œæœºå™¨äººä¼šå‘ç”¨æˆ·å‘é€**ä¸¤æ¡æ¶ˆæ¯**ï¼š

1. **è®¢å•åˆ›å»ºç¡®è®¤æ¶ˆæ¯** - æ˜¾ç¤ºè®¢å•è¯¦ç»†ä¿¡æ¯
2. **è‡ªåŠ¨æ’­æŠ¥æ¶ˆæ¯** - æé†’ä¸‹ä¸€æœŸè¿˜æ¬¾ï¼ˆä»…æ­£å¸¸è®¢å•ï¼‰

---

## 1ï¸âƒ£ è®¢å•åˆ›å»ºç¡®è®¤æ¶ˆæ¯

### æ­£å¸¸è®¢å•ï¼ˆéå†å²è®¢å•ï¼‰

**æ¶ˆæ¯æ ¼å¼**ï¼š
```
âœ… Order Created Successfully

ğŸ“‹ Order ID: 2511210110
ğŸ·ï¸ Group ID: S01
ğŸ“… Date: 2025-11-21 12:00:00
ğŸ‘¥ Week Group: å››
ğŸ‘¤ Customer: Returning
ğŸ’° Amount: 10000.00
ğŸ“ˆ Status: normal
```

**å­—æ®µè¯´æ˜**ï¼š
- âœ… **Order Created Successfully** - è®¢å•åˆ›å»ºæˆåŠŸæç¤º
- ğŸ“‹ **Order ID** - è®¢å•IDï¼ˆä»ç¾¤åè§£æï¼‰
- ğŸ·ï¸ **Group ID** - å½’å±IDï¼ˆé»˜è®¤ï¼šS01ï¼‰
- ğŸ“… **Date** - è®¢å•æ—¥æœŸï¼ˆæ ¼å¼ï¼šYYYY-MM-DD HH:MM:SSï¼‰
- ğŸ‘¥ **Week Group** - æ˜ŸæœŸåˆ†ç»„ï¼ˆä¸€ã€äºŒã€ä¸‰ã€å››ã€äº”ã€å…­ã€æ—¥ï¼‰
- ğŸ‘¤ **Customer** - å®¢æˆ·ç±»å‹
  - `New` - æ–°å®¢æˆ·ï¼ˆç¾¤åä»¥ A å¼€å¤´ï¼‰
  - `Returning` - è€å®¢æˆ·ï¼ˆç¾¤åæ˜¯10ä½æ•°å­—ï¼‰
- ğŸ’° **Amount** - è®¢å•é‡‘é¢ï¼ˆä¿ç•™2ä½å°æ•°ï¼‰
- ğŸ“ˆ **Status** - è®¢å•åˆå§‹çŠ¶æ€
  - `normal` - æ­£å¸¸
  - `overdue` - é€¾æœŸ
  - `breach` - è¿çº¦
  - `end` - ç»“æŸ

---

### å†å²è®¢å•ï¼ˆ2025-11-28ä¹‹å‰çš„è®¢å•ï¼‰

**æ¶ˆæ¯æ ¼å¼**ï¼š
```
âœ… Historical Order Imported

ğŸ“‹ Order ID: 2511210110
ğŸ·ï¸ Group ID: S01
ğŸ“… Date: 2025-11-21 12:00:00
ğŸ‘¤ Customer: Returning (Historical)
ğŸ’° Amount: 10000.00
ğŸ“ˆ Status: normal
âš ï¸ Funds Update: Skipped (Historical Data Only)
ğŸ“¢ Broadcast: Skipped (Historical Data Only)
```

**ä¸æ­£å¸¸è®¢å•çš„åŒºåˆ«**ï¼š
- âœ… æ ‡é¢˜æ”¹ä¸º `Historical Order Imported`
- ğŸ‘¤ å®¢æˆ·ç±»å‹åæ·»åŠ  `(Historical)` æ ‡è®°
- âŒ **ä¸æ˜¾ç¤º** `Week Group`ï¼ˆæ˜ŸæœŸåˆ†ç»„ï¼‰
- âš ï¸ æ·»åŠ  `Funds Update: Skipped` æç¤ºï¼ˆä¸æ‰£æ¬¾ï¼‰
- ğŸ“¢ æ·»åŠ  `Broadcast: Skipped` æç¤ºï¼ˆä¸æ’­æŠ¥ï¼‰

---

## 2ï¸âƒ£ è‡ªåŠ¨æ’­æŠ¥æ¶ˆæ¯ï¼ˆä»…æ­£å¸¸è®¢å•ï¼‰

**è§¦å‘æ¡ä»¶**ï¼š
- âœ… ä»…æ­£å¸¸è®¢å•ï¼ˆéå†å²è®¢å•ï¼‰ä¼šå‘é€
- âŒ å†å²è®¢å•ä¸å‘é€è‡ªåŠ¨æ’­æŠ¥

**æ¶ˆæ¯æ ¼å¼**ï¼š
```
Your next payment is due on December 02,2025 (Tuesday) for 10,000 or 1,200 to defer the principal payment for one week.

Your outstanding interest is 0
```

**å­—æ®µè¯´æ˜**ï¼š
- **next payment is due on** - ä¸‹ä¸€ä¸ªä»˜æ¬¾æ—¥æœŸ
  - æ—¥æœŸæ ¼å¼ï¼š`Month DD,YYYY`ï¼ˆä¾‹å¦‚ï¼šDecember 02,2025ï¼‰
  - æ˜ŸæœŸæ ¼å¼ï¼š`(Weekday)`ï¼ˆä¾‹å¦‚ï¼š(Tuesday)ï¼‰
- **for 10,000** - æœ¬é‡‘é‡‘é¢ï¼ˆè®¢å•é‡‘é¢ï¼‰
- **or 1,200** - æœ¬é‡‘12%ï¼ˆç”¨äºå»¶æœŸä¸€å‘¨ï¼‰
- **outstanding interest is 0** - æœªä»˜åˆ©æ¯ï¼ˆæ–°è®¢å•é»˜è®¤ä¸º0ï¼‰

**æ—¥æœŸè®¡ç®—é€»è¾‘**ï¼š
- åŸºäºè®¢å•æ—¥æœŸè®¡ç®—
- æ‰¾åˆ°è®¢å•æ—¥æœŸå¯¹åº”çš„æ˜ŸæœŸå‡ 
- ä»å½“å‰æ—¥æœŸå¼€å§‹ï¼Œæ‰¾åˆ°ä¸‹ä¸€ä¸ªç›¸åŒçš„æ˜ŸæœŸå‡ 
- å¦‚æœä»Šå¤©æ˜¯ç›®æ ‡æ˜ŸæœŸå‡ ï¼Œåˆ™ä¸‹ä¸ªä»˜æ¬¾æ—¥æœŸæ˜¯7å¤©å

**ç¤ºä¾‹**ï¼š
- è®¢å•æ—¥æœŸï¼š2025-11-21ï¼ˆå‘¨äº”ï¼‰
- å½“å‰æ—¥æœŸï¼š2025-11-25ï¼ˆå‘¨äºŒï¼‰
- ä¸‹ä¸ªä»˜æ¬¾æ—¥æœŸï¼š2025-11-28ï¼ˆå‘¨äº”ï¼Œ7å¤©åï¼‰

---

## ğŸ“ æ¶ˆæ¯å‘é€æµç¨‹

### æ­£å¸¸è®¢å•æµç¨‹

```
1. åˆ›å»ºè®¢å•ï¼ˆæ•°æ®åº“ï¼‰
   â””â”€ æˆåŠŸ

2. æ›´æ–°ç»Ÿè®¡æ•°æ®
   â”œâ”€ æ›´æ–°è®¢å•ç»Ÿè®¡ï¼ˆvalid/breachï¼‰
   â”œâ”€ æ‰£é™¤æµåŠ¨èµ„é‡‘
   â””â”€ æ›´æ–°å®¢æˆ·ç»Ÿè®¡

3. å‘é€è®¢å•ç¡®è®¤æ¶ˆæ¯
   â””â”€ build_order_creation_message()
      â””â”€ æ˜¾ç¤ºè®¢å•è¯¦ç»†ä¿¡æ¯

4. å‘é€è‡ªåŠ¨æ’­æŠ¥æ¶ˆæ¯
   â””â”€ send_auto_broadcast()
      â””â”€ æé†’ä¸‹ä¸€æœŸè¿˜æ¬¾
```

### å†å²è®¢å•æµç¨‹

```
1. åˆ›å»ºè®¢å•ï¼ˆæ•°æ®åº“ï¼‰
   â””â”€ æˆåŠŸ

2. æ›´æ–°ç»Ÿè®¡æ•°æ®
   â””â”€ ä»…æ›´æ–°è®¢å•ç»Ÿè®¡ï¼ˆvalid/breachï¼‰
   â””â”€ ä¸æ‰£æ¬¾ï¼Œä¸æ›´æ–°å®¢æˆ·ç»Ÿè®¡

3. å‘é€è®¢å•ç¡®è®¤æ¶ˆæ¯
   â””â”€ build_order_creation_message(is_historical=True)
      â””â”€ æ˜¾ç¤ºè®¢å•è¯¦ç»†ä¿¡æ¯ï¼ˆå«å†å²æ ‡è®°ï¼‰

4. è·³è¿‡è‡ªåŠ¨æ’­æŠ¥
   â””â”€ å†å²è®¢å•ä¸æ’­æŠ¥
```

---

## ğŸ” ä»£ç ä½ç½®

### è®¢å•ç¡®è®¤æ¶ˆæ¯

**æ–‡ä»¶**: `utils/message_builders.py`
**å‡½æ•°**: `build_order_creation_message()`

```python
def build_order_creation_message(
    order_id: str,
    group_id: str,
    created_at: str,
    weekday_group: Optional[str],
    customer: str,
    amount: float,
    initial_state: str,
    is_historical: bool = False
) -> str:
```

**è°ƒç”¨ä½ç½®**: `utils/order_helpers.py::try_create_order_from_title()`

```python
msg = build_order_creation_message(
    order_id=order_id,
    group_id=group_id,
    created_at=created_at,
    weekday_group=weekday_group,
    customer=customer,
    amount=amount,
    initial_state=initial_state,
    is_historical=is_historical
)
await update.message.reply_text(msg)
```

---

### è‡ªåŠ¨æ’­æŠ¥æ¶ˆæ¯

**æ–‡ä»¶**: `utils/order_helpers.py`
**å‡½æ•°**: `send_auto_broadcast()`

```python
async def send_auto_broadcast(
    update: Update,
    context: ContextTypes.DEFAULT_TYPE,
    chat_id: int,
    amount: float,
    order_date: str = None
):
```

**è°ƒç”¨ä½ç½®**: `utils/order_helpers.py::try_create_order_from_title()`

```python
if not is_historical:
    # è‡ªåŠ¨æ’­æŠ¥ä¸‹ä¸€æœŸè¿˜æ¬¾
    await send_auto_broadcast(update, context, chat_id, amount, created_at)
```

**æ¶ˆæ¯æ„å»º**: `utils/broadcast_helpers.py`

```python
from utils.broadcast_helpers import format_broadcast_message, calculate_next_payment_date

_, date_str, weekday_str = calculate_next_payment_date(order_date)
message = format_broadcast_message(
    principal=amount,
    principal_12=amount * 0.12,
    outstanding_interest=0,
    date_str=date_str,
    weekday_str=weekday_str
)
```

---

## ğŸ“Š æ¶ˆæ¯ç¤ºä¾‹å¯¹æ¯”

### ç¤ºä¾‹1ï¼šæ­£å¸¸è®¢å•ï¼ˆæ–°å®¢æˆ·ï¼‰

**è®¢å•ä¿¡æ¯**ï¼š
- è®¢å•ID: `A2511210110`
- é‡‘é¢: `10,000`
- æ—¥æœŸ: `2025-11-21`ï¼ˆå‘¨äº”ï¼‰
- çŠ¶æ€: `normal`

**ç¡®è®¤æ¶ˆæ¯**ï¼š
```
âœ… Order Created Successfully

ğŸ“‹ Order ID: A2511210110
ğŸ·ï¸ Group ID: S01
ğŸ“… Date: 2025-11-21 12:00:00
ğŸ‘¥ Week Group: äº”
ğŸ‘¤ Customer: New
ğŸ’° Amount: 10000.00
ğŸ“ˆ Status: normal
```

**è‡ªåŠ¨æ’­æŠ¥æ¶ˆæ¯**ï¼š
```
Your next payment is due on November 28,2025 (Friday) for 10,000 or 1,200 to defer the principal payment for one week.

Your outstanding interest is 0
```

---

### ç¤ºä¾‹2ï¼šå†å²è®¢å•ï¼ˆè€å®¢æˆ·ï¼‰

**è®¢å•ä¿¡æ¯**ï¼š
- è®¢å•ID: `2511200110`
- é‡‘é¢: `10,000`
- æ—¥æœŸ: `2025-11-20`ï¼ˆ2025-11-28ä¹‹å‰ï¼‰
- çŠ¶æ€: `normal`

**ç¡®è®¤æ¶ˆæ¯**ï¼š
```
âœ… Historical Order Imported

ğŸ“‹ Order ID: 2511200110
ğŸ·ï¸ Group ID: S01
ğŸ“… Date: 2025-11-20 12:00:00
ğŸ‘¤ Customer: Returning (Historical)
ğŸ’° Amount: 10000.00
ğŸ“ˆ Status: normal
âš ï¸ Funds Update: Skipped (Historical Data Only)
ğŸ“¢ Broadcast: Skipped (Historical Data Only)
```

**è‡ªåŠ¨æ’­æŠ¥æ¶ˆæ¯**ï¼š
```
ï¼ˆä¸å‘é€ï¼‰
```

---

### ç¤ºä¾‹3ï¼šè¿çº¦è®¢å•

**è®¢å•ä¿¡æ¯**ï¼š
- è®¢å•ID: `2511210110`
- é‡‘é¢: `10,000`
- æ—¥æœŸ: `2025-11-21`
- çŠ¶æ€: `breach`ï¼ˆç¾¤ååŒ…å«è¿çº¦æ ‡å¿—ï¼‰

**ç¡®è®¤æ¶ˆæ¯**ï¼š
```
âœ… Order Created Successfully

ğŸ“‹ Order ID: 2511210110
ğŸ·ï¸ Group ID: S01
ğŸ“… Date: 2025-11-21 12:00:00
ğŸ‘¥ Week Group: äº”
ğŸ‘¤ Customer: Returning
ğŸ’° Amount: 10000.00
ğŸ“ˆ Status: breach
```

**è‡ªåŠ¨æ’­æŠ¥æ¶ˆæ¯**ï¼š
```
Your next payment is due on November 28,2025 (Friday) for 10,000 or 1,200 to defer the principal payment for one week.

Your outstanding interest is 0
```

---

## âš™ï¸ é…ç½®è¯´æ˜

### å†å²è®¢å•é˜ˆå€¼

**ä½ç½®**: `constants.py`

```python
HISTORICAL_THRESHOLD_DATE = (2025, 11, 28)
```

**è¯´æ˜**ï¼š
- 2025-11-28ä¹‹å‰çš„è®¢å•è§†ä¸ºå†å²è®¢å•
- å†å²è®¢å•ä¸æ‰£æ¬¾ï¼Œä¸æ’­æŠ¥

---

### é»˜è®¤å½’å±ID

**ä½ç½®**: `utils/order_helpers.py`

```python
group_id = 'S01'  # é»˜è®¤å½’å±
```

**è¯´æ˜**ï¼š
- æ‰€æœ‰æ–°è®¢å•é»˜è®¤å½’å±åˆ° `S01`
- å¯ä»¥é€šè¿‡å…¶ä»–åŠŸèƒ½ä¿®æ”¹å½’å±

---

## ğŸ”§ ä¿®æ”¹æ¶ˆæ¯æ ¼å¼

å¦‚æœéœ€è¦ä¿®æ”¹æ¶ˆæ¯æ ¼å¼ï¼Œè¯·ç¼–è¾‘ä»¥ä¸‹æ–‡ä»¶ï¼š

1. **è®¢å•ç¡®è®¤æ¶ˆæ¯**: `utils/message_builders.py::build_order_creation_message()`
2. **è‡ªåŠ¨æ’­æŠ¥æ¶ˆæ¯**: `utils/broadcast_helpers.py::format_broadcast_message()`

---

**æœ€åæ›´æ–°**: 2024å¹´ï¼ˆæœ€æ–°ç‰ˆæœ¬ï¼‰




