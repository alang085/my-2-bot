# Zeabur 部署计划

本文档提供从旧容器迁移到新Git仓库部署的完整步骤。

## 📋 部署前准备清单

- [x] 代码已整理完成
  - [x] `.dockerignore` 已创建
  - [x] `.gitignore` 已更新
  - [x] `Dockerfile` 已优化
  - [x] 代码格式已整理
  - [x] 支持从Volume读取 `database_backup.sql`

- [ ] 数据备份准备
  - [ ] 从旧容器Volume下载 `loan_bot.db` 或 `database_backup.sql`
  - [ ] 备份文件已保存到本地

- [ ] Git仓库准备
  - [ ] Git仓库已创建
  - [ ] 代码已提交
  - [ ] 已推送到远程仓库

## 🚀 部署步骤

### 第一步：备份旧数据

⚠️ **重要提示**：SQLite数据库在容器运行时会被持续写入，直接下载正在运行的数据库文件可能导致：
- 数据不一致
- 文件损坏
- 备份失败

#### 推荐方法：停止容器后备份（最安全）

1. **停止旧容器**（在Zeabur Dashboard中）
   - 这样可以确保数据库文件处于一致状态
   - 停止后不会有新的写入操作

2. **下载数据库文件**
   - 登录 [Zeabur Dashboard](https://dash.zeabur.com)
   - 进入旧容器所在项目
   - 打开 "Storage" 或 "Volumes" 标签页
   - 找到挂载到 `/data` 的Volume
   - 下载 `loan_bot.db` 文件到本地

3. **验证备份文件**
   - 检查文件大小是否合理（不为0字节）
   - 保存备份文件到安全位置

4. **重新启动旧容器**（如果需要继续使用）

#### 备选方法：容器运行时备份（有风险，不推荐）

如果必须在容器运行时备份：

1. **使用数据库备份命令**（如果已实现）
   - 在Telegram中向机器人发送 `/backup` 命令
   - 机器人会生成SQL备份文件
   - 但这需要代码中实现了备份功能

2. **直接下载Volume文件**（风险较高）
   - ⚠️ 可能导致数据不一致
   - ⚠️ 建议在低峰期操作
   - ⚠️ 备份后验证数据完整性

#### 选项B：使用已有的SQL备份文件

如果旧容器Volume中已有 `database_backup.sql` 文件：

1. 这个文件通常是通过备份命令生成的
2. 下载到本地保存
3. 这个文件是静态的，不会在运行时更新

**重要**：
- ✅ **最安全的方式**：停止容器 → 下载文件 → 重启容器
- ⚠️ **运行时下载**：可能不完整，需要验证
- ✅ **SQL备份文件**：如果存在，使用这个更安全

---

### 第二步：准备Git仓库

```bash
# 1. 初始化Git（如果还没有）
git init

# 2. 添加所有文件（.gitignore会自动排除敏感文件）
git add .

# 3. 创建初始提交
git commit -m "Initial commit for Zeabur deployment"

# 4. 添加远程仓库
git remote add origin <你的仓库地址>

# 5. 推送到远程
git push -u origin main
```

**检查**：确认 `user_config.py`、`*.db`、`database_backup.sql` 等文件未被提交

---

### 第三步：在Zeabur创建新项目

1. 访问 [Zeabur Dashboard](https://dash.zeabur.com)
2. 点击 **"New Project"**
3. 选择 **"Import from Git"**
4. 连接你的Git仓库（GitHub/GitLab/Bitbucket）
5. 选择仓库和分支（通常是 `main` 或 `master`）
6. 确认根目录为项目根目录

---

### 第四步：配置Volume（持久化存储）

1. 在新项目设置中找到 **"Storage"** 或 **"Volumes"** 标签页
2. 点击 **"Add Volume"** 或 **"Create Volume"**
3. 配置Volume：
   - **Mount Path**: `/data`
   - **Size**: 1GB（可根据数据大小调整，建议至少500MB）
4. 保存配置

---

### 第五步：配置环境变量

在Zeabur项目设置的 **"Environment Variables"** 中添加：

```env
BOT_TOKEN=你的机器人Token
ADMIN_USER_IDS=你的用户ID（多个用逗号分隔，无空格）
DATA_DIR=/data
```

**获取方式**：
- `BOT_TOKEN`: 在Telegram搜索 @BotFather → 发送 `/token`
- `ADMIN_USER_IDS`: 在Telegram搜索 @userinfobot → 发送消息获取ID

---

### 第六步：上传数据库文件

#### 方式一：上传数据库文件（.db文件）

1. 在Zeabur Dashboard中，找到新项目的Volume设置
2. 点击Volume的文件管理或上传选项
3. 上传之前下载的 `loan_bot.db` 文件
4. 确保文件路径为 `/data/loan_bot.db`

#### 方式二：上传SQL备份文件（备选）

1. 将 `database_backup.sql` 文件上传到Volume的 `/data` 目录
2. 确保文件路径为 `/data/database_backup.sql`
3. 容器启动时会自动检测并导入（如果数据库为空）

---

### 第七步：部署并启动

1. 点击 **"Deploy"** 按钮
2. 等待构建完成（查看构建日志）
3. 等待容器启动（查看运行日志）

**预期日志输出**：
- `数据库 初始化完成！`
- `机器人启动中...`
- `机器人已启动，等待消息...`

**如果有备份文件**：
- `[INFO] 检测到数据库备份文件，开始导入（原因：数据库不存在）...`
- `[OK] 数据库备份导入成功`

---

### 第八步：验证部署

#### 8.1 检查日志

在Zeabur Dashboard的 **"Logs"** 标签页：
- ✅ 确认没有错误信息
- ✅ 确认数据库初始化成功
- ✅ 确认机器人启动成功

#### 8.2 Telegram功能测试

在Telegram中测试：

1. **基础功能**
   ```
   /start - 应该收到欢迎消息
   ```

2. **数据验证**
   ```
   /report - 查看报表（应该显示原有数据）
   /list_attributions - 查看归属ID列表
   /list_employees - 查看员工列表
   ```

3. **功能测试**
   - 测试创建订单（如果有测试群组）
   - 测试查询功能
   - 验证数据完整性

#### 8.3 数据完整性检查

- [ ] 流动资金余额是否正确
- [ ] 订单数据是否完整
- [ ] 统计数据是否一致
- [ ] 用户权限是否保留

---

### 第九步：切换流量（可选）

如果你使用的是同一个Bot Token：

1. **停止旧容器**
   - 在Zeabur Dashboard中找到旧项目
   - 停止容器运行

2. **确认新容器正常运行**
   - 继续监控新容器的日志
   - 确认功能正常

如果你使用的是不同的Bot Token：

1. 新容器应该已经独立运行
2. 在Telegram中切换到新的机器人
3. 停止旧容器

---

## ⚠️ 重要注意事项

### 数据安全

- ✅ **备份是必须的**：确保在部署前已备份数据
- ⚠️ **备份时机**：建议停止容器后再备份，确保数据一致性
- ✅ **保留旧容器**：在新部署完全验证后再停止旧容器
- ✅ **验证备份**：下载后检查文件大小，确保备份完整
- ✅ **测试环境优先**：如果可能，先在测试环境验证

### Volume配置

- ✅ **路径必须一致**：确保Volume挂载路径为 `/data`
- ✅ **环境变量**：确保 `DATA_DIR=/data` 已设置
- ✅ **文件权限**：确保数据库文件有读写权限

### 数据库兼容性

- ✅ **自动迁移**：代码使用 `CREATE TABLE IF NOT EXISTS`，会自动处理Schema迁移
- ✅ **向后兼容**：新字段会自动添加，不会删除现有字段
- ✅ **数据保护**：只在数据库为空时导入备份，不会覆盖现有数据

### 监控和维护

- 📊 **日志监控**：定期查看Zeabur日志，确保运行正常
- 🔄 **自动重启**：已配置自动重启策略（最多10次）
- 💾 **定期备份**：建议定期备份数据库文件

---

## 🔧 故障排查

### 问题1：部署失败

**检查**：
- 查看构建日志中的错误信息
- 确认 `requirements.txt` 正确
- 确认 `Dockerfile` 配置正确
- 确认Python版本兼容（3.11）

**解决**：
- 修复代码错误
- 检查依赖包版本
- 重新部署

### 问题2：机器人无法启动

**检查**：
- 环境变量是否正确设置（BOT_TOKEN, ADMIN_USER_IDS）
- 查看运行日志中的错误信息
- 确认Token格式正确

**解决**：
- 检查并更新环境变量
- 验证Token有效性
- 检查日志中的具体错误

### 问题3：数据丢失或不正确

**检查**：
- Volume是否正确挂载
- 数据库文件是否存在（`/data/loan_bot.db`）
- `DATA_DIR` 环境变量是否正确

**解决**：
- 重新上传数据库文件
- 检查Volume挂载配置
- 查看数据库导入日志

### 问题4：权限错误

**检查**：
- `ADMIN_USER_IDS` 是否正确设置
- 用户ID格式是否正确（数字，逗号分隔，无空格）

**解决**：
- 更新 `ADMIN_USER_IDS` 环境变量
- 验证用户ID是否正确

---

## 📚 相关文档

- [DEPLOY.md](DEPLOY.md) - 详细部署指南
- [DATA_MIGRATION.md](DATA_MIGRATION.md) - 数据迁移详细步骤
- [README.md](README.md) - 项目说明文档

---

## ✅ 部署完成检查清单

### 代码准备
- [x] 代码已整理
- [x] 配置文件已准备
- [x] Git仓库已推送

### 数据准备
- [ ] 旧数据已备份
- [ ] 备份文件已保存

### Zeabur配置
- [ ] 新项目已创建
- [ ] Volume已配置（Mount Path: `/data`）
- [ ] 环境变量已设置
- [ ] 数据库文件已上传

### 验证测试
- [ ] 容器启动成功
- [ ] 日志无错误
- [ ] Telegram功能正常
- [ ] 数据完整性验证通过

### 切换完成
- [ ] 新部署运行正常
- [ ] 旧容器已停止（如适用）
- [ ] 监控和日志检查正常

---

## 📞 需要帮助？

如果遇到问题：

1. 查看Zeabur容器日志
2. 检查环境变量配置
3. 验证Volume挂载状态
4. 参考故障排查部分
5. 查看相关文档（DEPLOY.md, DATA_MIGRATION.md）

---

**最后更新**：2025-01-XX
**部署环境**：Zeabur
**Python版本**：3.11
**数据库**：SQLite（存储在Volume中）

