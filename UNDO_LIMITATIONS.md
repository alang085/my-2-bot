# 撤回（Undo）命令的限制说明

## 📋 撤回命令：`/undo`

### 核心限制定义

1. **只能撤销当天的操作**
   - 只能撤销当天（根据日切时间）执行的操作
   - 不能撤销昨天或更早的操作
   - 使用 `get_daily_period_date()` 判断当天日期

2. **不限制操作类型**
   - 可以撤销任何类型的操作
   - 对于不支持数据回滚的操作类型，会标记为已撤销但不进行数据回滚
   - 系统会提示用户该操作类型不支持数据回滚

3. **撤销只针对当前的聊天环境**
   - 只能撤销在当前聊天环境（群组或私聊）中执行的操作
   - 不能跨聊天环境撤销操作
   - 系统会验证操作的 chat_id 必须与当前聊天环境匹配

### 基本限制

#### 1. 连续撤销次数限制
- **最大连续撤销次数**: 3次
- **说明**: 连续使用 `/undo` 命令最多只能撤销3次
- **重置条件**: 执行新的操作后，连续撤销次数会自动重置为0
- **提示信息**: 达到限制后会提示"已达到最大连续撤销次数（3次）"

#### 2. 聊天环境限制
- **只能撤销当前聊天环境的操作**
- **群聊**: 只能撤销在当前群组中执行的操作
- **私聊**: 只能撤销在当前私聊中执行的操作
- **安全验证**: 系统会验证操作的 chat_id 必须与当前聊天环境完全匹配

#### 3. 操作顺序限制
- **只能撤销上一个操作**: 只能撤销当前聊天环境中最后一个操作
- **不能选择性撤销**: 不能撤销指定ID的操作，只能撤销最近的一个
- **只能撤销当天的操作**: 只能撤销当天执行的操作，不能撤销昨天或更早的操作

#### 4. 操作类型限制（已移除）
- **不限制操作类型**: 可以撤销任何类型的操作
- **支持数据回滚的操作类型**:
  - ✅ `interest` - 利息收入（完整数据回滚）
  - ✅ `principal_reduction` - 本金减少（完整数据回滚）
  - ✅ `expense` - 开销记录（完整数据回滚）
  - ✅ `order_completed` - 订单完成（完整数据回滚）
  - ✅ `order_breach_end` - 违约完成（完整数据回滚）
  - ✅ `order_created` - 订单创建（完整数据回滚）
  - ✅ `order_state_change` - 订单状态变更（完整数据回滚）
- **不支持数据回滚的操作类型**:
  - ⚠️ 其他操作类型：会标记为已撤销，但不进行数据回滚
  - 系统会提示用户该操作类型不支持数据回滚

#### 5. 数据状态限制
- **订单必须存在**: 撤销订单相关操作时，订单必须仍然存在
- **订单ID必须匹配**: 撤销订单操作时，订单ID必须与操作记录中的ID匹配
- **订单必须属于当前群组**: 撤销订单操作时，订单的 chat_id 必须与当前群组匹配

#### 6. 归属ID变更处理
- **归属ID已变更**: 如果订单的归属ID在操作后已变更，撤销时会正确处理：
  - 从原归属ID减少相关统计
  - 从新归属ID恢复相关统计

## 🔒 安全机制

### 双重验证
1. **用户ID验证**: 只能撤销自己执行的操作
2. **聊天环境验证**: 操作的 chat_id 必须与当前聊天环境完全匹配

### 操作记录
- 所有撤销操作都会记录在操作历史中
- 撤销操作会标记原操作为"已撤销"（不删除，保留历史）
- 撤销操作会向所有管理员发送通知

## 📊 撤销效果

### 利息收入撤销
- ✅ 减少利息收入统计
- ✅ 减少流动资金
- ✅ 标记收入记录为已撤销（不删除）

### 本金减少撤销
- ✅ 恢复订单金额
- ✅ 恢复有效金额统计
- ✅ 减少完成金额统计
- ✅ 减少流动资金

### 开销记录撤销
- ✅ 恢复日结数据
- ✅ 恢复流动资金
- ✅ 删除开销记录

### 订单完成撤销
- ✅ 恢复订单状态
- ✅ 回滚完成订单统计
- ✅ 恢复有效订单统计
- ✅ 减少流动资金

### 违约完成撤销
- ✅ 恢复订单状态为 breach
- ✅ 回滚违约完成订单统计
- ✅ 恢复违约订单统计
- ✅ 减少流动资金

### 订单创建撤销
- ✅ 删除订单
- ✅ 回滚订单统计
- ✅ 恢复流动资金（非历史订单）
- ✅ 恢复客户统计（非历史订单）

### 订单状态变更撤销
- ✅ 恢复订单状态
- ✅ 回滚相关统计变更

## ⚠️ 注意事项

1. **撤销后需要重新操作**: 达到最大连续撤销次数后，需要重新执行正确的操作，然后才能继续使用撤销功能

2. **统计数据一致性**: 撤销操作会自动回滚统计数据，但建议撤销后检查数据是否正确

3. **历史记录保留**: 撤销操作不会删除原始记录，只是标记为"已撤销"，保留完整历史

4. **管理员通知**: 每次撤销操作都会向所有管理员发送通知，包含：
   - 用户信息
   - 聊天环境信息
   - 操作类型
   - 撤销详情
   - 连续撤销次数

5. **不支持的操作**: 某些操作类型不支持撤销，会提示"不支持撤销此类型的操作"

## 🔄 重置撤销次数

撤销次数会在以下情况重置为0：
- 成功执行新的操作（如创建订单、记录利息等）
- 系统会自动调用 `reset_undo_count()` 函数

## 📝 使用建议

1. **及时撤销**: 发现错误后立即使用 `/undo` 撤销
2. **检查数据**: 撤销后检查统计数据是否正确
3. **必要时修复**: 如果统计数据有问题，使用 `/fix_statistics` 修复
4. **避免连续撤销**: 尽量避免连续撤销多次，建议撤销后重新执行正确操作

---

**总结**: `/undo` 命令是一个安全、有限制的撤销机制，主要用于快速纠正最近的操作错误，而不是作为数据修正工具。

