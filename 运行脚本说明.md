# 运行脚本说明

## 批量更新订单星期分组脚本

### 脚本文件
- `update_all_weekday_groups.py` - 强制更新所有订单的星期分组
- `fix_weekday_groups.py` - 修复错误的星期分组（只更新错误的）

---

## 部署环境运行方式

### 方式1: 通过 Zeabur 控制台运行

1. **进入 Zeabur 控制台**
   - 登录 Zeabur 平台
   - 选择对应的项目和服务

2. **打开终端/Shell**
   - 在服务详情页面找到 "Terminal" 或 "Shell" 选项
   - 点击进入容器终端

3. **运行脚本**
   ```bash
   python update_all_weekday_groups.py
   ```

---

### 方式2: 通过 SSH 连接运行

如果部署环境支持 SSH：

```bash
# 连接到服务器
ssh user@your-server

# 进入项目目录
cd /path/to/loan005.bot

# 运行脚本
python update_all_weekday_groups.py
```

---

### 方式3: 通过 Docker 执行

如果使用 Docker 部署：

```bash
# 进入容器
docker exec -it <container_name> bash

# 进入项目目录
cd /app

# 运行脚本
python update_all_weekday_groups.py
```

---

### 方式4: 通过 Telegram Bot 命令（最方便，推荐）

**已添加管理员命令**：`/update_weekday_groups`

**使用方法**：
1. 在 Telegram 中私聊机器人
2. 发送命令：`/update_weekday_groups`
3. 等待更新完成，机器人会返回结果

**权限要求**：仅管理员可以使用

**返回信息**：
```
✅ 更新完成！

已更新: 168 个订单
跳过: 0 个订单
错误: 0 个订单
总计: 168 个订单
```

---

## 脚本说明

### `update_all_weekday_groups.py`

**功能**：
- 强制重新计算所有订单的星期分组
- 根据订单日期更新数据库
- 即使值相同也会更新（确保数据一致性）

**运行结果**：
- 显示每个订单的更新情况
- 统计更新、跳过、错误的数量
- 最后显示总结信息

**输出示例**：
```
开始更新所有订单的星期分组...
============================================================
找到 168 个订单
------------------------------------------------------------
[UPDATED] Order 2509030207: 2025-09-03 (Wednesday)
          '六' -> '三'
...
============================================================
更新完成！
  已更新: 168 个订单
  跳过: 0 个订单（无法解析日期）
  错误: 0 个订单
  总计: 168 个订单
============================================================
SUCCESS: 所有订单的星期分组已成功更新！
```

---

### `fix_weekday_groups.py`

**功能**：
- 只修复错误的星期分组
- 跳过已经正确的订单
- 更轻量级的修复脚本

**使用场景**：
- 日常维护
- 只修复有问题的订单

---

## 注意事项

1. **数据库备份**：
   - 运行脚本前建议备份数据库
   - 脚本会直接修改数据库，请谨慎操作

2. **运行权限**：
   - 确保有数据库读写权限
   - 确保 Python 环境正确配置

3. **运行时间**：
   - 脚本会处理所有订单，可能需要一些时间
   - 建议在低峰期运行

4. **日志查看**：
   - 脚本会输出详细的更新日志
   - 可以保存日志用于后续检查

---

## 验证更新结果

运行脚本后，可以通过以下方式验证：

1. **查看脚本输出**：脚本会显示更新统计
2. **查询数据库**：直接查询订单表检查 weekday_group 字段
3. **使用 Bot 命令**：通过 `/search` 命令按星期分组查询订单

---

## 常见问题

**Q: 脚本运行失败怎么办？**
A: 检查：
- Python 环境是否正确
- 数据库连接是否正常
- 文件路径是否正确

**Q: 如何只更新特定订单？**
A: 可以修改脚本，添加订单ID过滤条件

**Q: 脚本可以定期自动运行吗？**
A: 可以设置定时任务（cron job）定期运行脚本

