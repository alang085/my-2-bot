# 撤销命令不能使用的情况

## ❌ 撤销命令无法使用的所有情况

### 0. 权限不足（未授权用户）
**情况**: 用户不在授权列表中（既不是管理员也不是员工）
**提示信息**: 无提示（装饰器直接返回，不执行命令）
**原因**: `@authorized_required` 装饰器检查失败
**解决方法**: 联系管理员将用户ID添加到授权列表

---

### 1. 用户信息获取失败
**情况**: 系统无法获取用户ID
**提示信息**:
- 群聊: `❌ Unable to get user information`
- 私聊: `❌ 无法获取用户信息`
**原因**: Telegram API 无法识别用户身份

---

### 2. 连续撤销次数达到上限
**情况**: 连续使用 `/undo` 已达到最大次数（3次）
**提示信息**:
- 群聊: `❌ Maximum consecutive undo count reached (3 times). Please enter correct data again before using undo.`
- 私聊: `❌ 已达到最大连续撤销次数（3次）。请重新输入正确数据后，再使用撤销功能。`
**解决方法**: 执行新的操作后，撤销次数会自动重置为0

---

### 3. 无法获取聊天环境信息
**情况**: 系统无法获取当前聊天环境的 chat_id
**提示信息**:
- 群聊: `❌ Unable to get chat environment information`
- 私聊: `❌ 无法获取聊天环境信息`
**原因**: Telegram API 无法识别当前聊天环境

---

### 4. 当前聊天环境中今天没有可撤销的操作
**情况**: 在当前聊天环境（群聊或私聊）中今天没有任何操作记录
**提示信息**:
- 群聊: `❌ No undoable operation in this group chat today (<日期>). Note: /undo command can only undo today's operations executed in the current chat environment.`
- 私聊: `❌ 在当前私聊环境中今天（<日期>）没有可撤销的操作。提示：/undo 命令只能撤销当天在当前聊天环境（私聊或群聊）中执行的上一个操作。`
**常见场景**:
- 刚加入的群组，今天还没有执行过任何操作
- 新创建的私聊，今天还没有执行过任何操作
- 今天的所有操作都已被撤销
- 尝试撤销昨天或更早的操作（只能撤销当天的操作）

---

### 5. 安全验证失败（操作不属于当前聊天环境）
**情况**: 操作的 chat_id 与当前聊天环境的 chat_id 不匹配
**提示信息**:
- 群聊: `❌ Security check failed: Operation does not belong to this group chat. Note: /undo command can only undo operations executed in the current chat environment.`
- 私聊: `❌ 安全验证失败：操作不属于当前聊天环境。提示：/undo 命令只能撤销在当前聊天环境（私聊或群聊）中执行的操作。`
**常见场景**:
- 在群组A中执行操作，但在群组B中使用撤销
- 在私聊中执行操作，但在群组中使用撤销
- 在群组中执行操作，但在私聊中使用撤销

---

### 6. 不支持数据回滚的操作类型（已更新）
**情况**: 最后一个操作的类型不支持数据回滚（但可以标记为已撤销）
**提示信息**:
- 群聊: `✅ Operation marked as undone: <操作类型> (Note: Data rollback not supported for this operation type)`
- 私聊: `✅ 已标记操作已撤销：<操作类型>（注意：此操作类型不支持数据回滚）`
**支持完整数据回滚的操作类型**:
- ✅ `interest` - 利息收入（完整数据回滚）
- ✅ `principal_reduction` - 本金减少（完整数据回滚）
- ✅ `expense` - 开销记录（完整数据回滚）
- ✅ `order_completed` - 订单完成（完整数据回滚）
- ✅ `order_breach_end` - 违约完成（完整数据回滚）
- ✅ `order_created` - 订单创建（完整数据回滚）
- ✅ `order_state_change` - 订单状态变更（完整数据回滚）
**不支持数据回滚但可以标记为已撤销的操作类型**:
- ⚠️ 其他操作类型：会标记为已撤销，但不进行数据回滚
- 系统会提示用户该操作类型不支持数据回滚

---

### 7. 撤销操作执行失败（数据状态问题）
**情况**: 撤销操作在执行过程中失败
**提示信息**:
- 群聊: `❌ Undo operation failed. Please check data status.`
- 私聊: `❌ 撤销操作失败，请检查数据状态`
**可能原因**:
- 数据库操作失败
- 统计数据不一致
- 订单状态已变更
- 数据已被其他操作修改

---

### 8. 订单相关操作的特殊限制

#### 8.1 撤销本金减少失败
**失败情况**:
- ❌ 缺少必要参数（chat_id 或 old_amount）
- ❌ 订单不存在（订单已被删除）
**日志信息**: `撤销本金减少：订单不存在 (chat_id: <chat_id>)`

#### 8.2 撤销订单完成失败
**失败情况**:
- ❌ 缺少必要参数（chat_id 或 old_state）
- ❌ 订单不存在（订单已被删除）
**日志信息**: `撤销订单完成：订单不存在 (chat_id: <chat_id>)`

#### 8.3 撤销违约完成失败
**失败情况**:
- ❌ 缺少必要参数（chat_id 或 order_id）
- ❌ 订单不存在（订单已被删除）
- ❌ 订单ID不匹配（订单ID与操作记录中的ID不一致）
**日志信息**:
- `撤销违约完成：订单不存在 (chat_id: <chat_id>, order_id: <order_id>)`
- `撤销违约完成：订单ID不匹配 (期望: <order_id>, 实际: <实际ID>)`

#### 8.4 撤销订单创建失败
**失败情况**:
- ❌ 缺少必要参数（chat_id 或 order_id）
- ❌ 订单不存在或已被删除
- ❌ 订单ID不匹配（订单ID与操作记录中的ID不一致）
**日志信息**:
- `撤销订单创建：订单不存在或已被删除 (chat_id: <chat_id>, order_id: <order_id>)`
- `撤销订单创建：订单ID不匹配 (期望: <order_id>, 实际: <实际ID>)`

#### 8.5 撤销订单状态变更失败
**失败情况**:
- ❌ 缺少必要参数（chat_id 或 old_state）
- ❌ 订单不存在（订单已被删除）
**日志信息**: `撤销订单状态变更：订单不存在 (chat_id: <chat_id>)`

---

### 9. 开销记录撤销失败
**失败情况**:
- ❌ 缺少开销记录ID
**日志信息**: `撤销开销：缺少开销记录ID`
**原因**: 操作记录中缺少 `expense_record_id` 字段

---

### 10. 系统异常
**情况**: 撤销操作执行过程中发生未预期的错误
**提示信息**:
- 群聊: `❌ Error during undo operation: <错误信息>`
- 私聊: `❌ 撤销操作时出错: <错误信息>`
**可能原因**:
- 数据库连接失败
- 网络问题
- 代码逻辑错误
- 其他系统异常

---

## 🔍 常见场景总结

### 场景1: 在错误的聊天环境中使用撤销
**问题**: 在群组A中执行操作，但在群组B中使用撤销
**结果**: 安全验证失败，无法撤销

### 场景2: 订单已被删除后尝试撤销
**问题**: 订单创建后，订单被手动删除，然后尝试撤销订单创建
**结果**: 撤销失败，提示订单不存在

### 场景3: 连续撤销次数用尽
**问题**: 连续撤销3次后，再次尝试撤销
**结果**: 提示已达到最大连续撤销次数

### 场景4: 撤销不支持的操作
**问题**: 最后一个操作是"删除操作记录"，尝试撤销
**结果**: 提示不支持撤销此类型的操作

### 场景5: 数据已被其他操作修改
**问题**: 订单状态在撤销前已被其他操作修改
**结果**: 撤销可能失败，提示数据状态问题

---

## 💡 解决方法

### 方法1: 重置撤销次数
执行新的操作（如创建订单、记录利息等），撤销次数会自动重置为0

### 方法2: 在正确的聊天环境中使用
确保在操作执行的同一个聊天环境（群组或私聊）中使用撤销

### 方法3: 检查数据状态
如果撤销失败，检查：
- 订单是否仍然存在
- 订单状态是否已变更
- 统计数据是否一致

### 方法4: 使用数据修复工具
如果撤销失败导致数据不一致，可以使用：
- `/fix_statistics` - 修复统计数据
- `/fix_income_statistics` - 修复收入统计

---

## ⚠️ 重要提示

1. **撤销只能撤销最近的一个操作**，不能选择性撤销
2. **撤销必须在同一个聊天环境中使用**，不能跨聊天环境撤销
3. **撤销有连续次数限制**，达到上限后需要执行新操作才能继续使用
4. **撤销不会删除原始记录**，只是标记为"已撤销"，保留完整历史
5. **撤销操作会通知所有管理员**，确保操作可追溯

---

**总结**: 撤销命令有严格的安全限制和数据验证机制，确保数据安全性和一致性。如果遇到无法撤销的情况，请根据提示信息检查相应的条件。

