# 11:05增量报表 - 数据变化表设计预览

## 表格结构预览

### 主表：增量订单报表

| 日期 | 订单号 | 会员 | 订单金额 | 利息总数 | 归还本金 | 订单状态 | 备注 |
|------|--------|------|----------|----------|----------|----------|------|
| 2024-01-15 | ORD001 | A | 10,000.00 | 1,000.00 | 0.00 | 正常 | 新订单 |
| 2024-01-16 | ORD001 | A | 10,000.00 | 1,500.00 | 2,000.00 | 正常 | 归还本金 |
| 2024-01-17 | ORD002 | B | 20,000.00 | 1,000.00 | 0.00 | 正常 | 新订单 |
| 2024-01-18 | ORD001 | A | 10,000.00 | 1,500.00 | 2,000.00 | 完成 | 订单完成 |
| 2024-01-19 | ORD003 | A | 15,000.00 | 0.00 | 0.00 | 正常 | 新订单 |
| 汇总 | - | - | 45,000.00 | 4,000.00 | 2,000.00 | - | - |

### 利息明细（可展开查看）

点击"利息总数"列可以展开查看每期利息明细：

**ORD001订单的利息明细：**
```
利息总数: 1,500.00
  ├─ 利息1: 500.00 (2024-01-15)
  ├─ 利息2: 500.00 (2024-01-16)
  └─ 利息3: 500.00 (2024-01-17)
```

**ORD002订单的利息明细：**
```
利息总数: 1,000.00
  └─ 利息1: 1,000.00 (2024-01-17)
```

## 数据来源说明

### 1. 订单基本信息（来自 orders 表）

| 字段 | 说明 | 示例 |
|------|------|------|
| 日期 | 订单创建日期 | 2024-01-15 |
| 订单号 | 唯一订单编号 | ORD001 |
| 会员 | 客户类型（A=新客户，B=老客户） | A |
| 订单金额 | 订单原始金额 | 10,000.00 |
| 订单状态 | 订单当前状态 | 正常/逾期/违约/完成/违约完成 |

### 2. 利息记录（来自 income_records 表，type='interest'）

| 字段 | 说明 | 示例 |
|------|------|------|
| 利息日期 | 利息产生日期 | 2024-01-15 |
| 利息金额 | 单笔利息金额 | 500.00 |
| 利息总数 | 该订单所有利息累计 | 1,500.00 |

**查询逻辑：**
- 查询基准日期之后的所有利息记录
- 按订单号分组，计算每笔利息
- 利息明细按日期排序

### 3. 本金归还（来自 income_records 表，type='principal_reduction'）

| 字段 | 说明 | 示例 |
|------|------|------|
| 归还日期 | 本金归还日期 | 2024-01-16 |
| 归还金额 | 单笔归还金额 | 2,000.00 |
| 归还本金 | 该订单累计归还本金 | 2,000.00 |

**查询逻辑：**
- 查询基准日期之后的所有本金归还记录
- 按订单号分组，累计归还金额

### 4. 订单完成（来自 income_records 表，type='completed'）

| 字段 | 说明 | 示例 |
|------|------|------|
| 完成日期 | 订单完成日期 | 2024-01-18 |
| 完成金额 | 订单完成金额 | 10,000.00 |

### 5. 违约完成（来自 income_records 表，type='breach_end'）

| 字段 | 说明 | 示例 |
|------|------|------|
| 完成日期 | 违约完成日期 | 2024-01-20 |
| 完成金额 | 违约完成金额 | 15,000.00 |

### 6. 开销记录（来自 expense_records 表）

**单独的工作表：开销明细**

| 日期 | 类型 | 金额 | 备注 |
|------|------|------|------|
| 2024-01-15 | 公司开销 | 500.00 | 办公用品 |
| 2024-01-16 | 其他开销 | 200.00 | 差旅费 |
| 汇总 | - | 700.00 | - |

## Excel工作表结构

### 工作表1：增量订单报表（主表）

**列定义：**
1. **日期** (A列) - 订单日期或操作日期
2. **订单号** (B列) - 唯一订单编号
3. **会员** (C列) - 客户类型（A/B）
4. **订单金额** (D列) - 订单原始金额
5. **利息总数** (E列) - 累计利息金额（可展开查看明细）
6. **归还本金** (F列) - 累计归还本金
7. **订单状态** (G列) - 当前订单状态
8. **备注** (H列) - 操作说明

**数据行规则：**
- 每个订单在基准日期之后有变化时，显示一行
- 如果订单有多笔利息，利息总数列可以展开查看明细
- 如果订单有多次本金归还，累计显示在归还本金列
- 最后一行是汇总行

### 工作表2：开销明细（可选）

**列定义：**
1. **日期** - 开销日期
2. **类型** - 开销类型（公司开销/其他开销）
3. **金额** - 开销金额
4. **备注** - 开销说明

## 增量数据查询逻辑

### 1. 基准日期管理

- **第一次执行**：记录当前日期为基准日期
- **后续执行**：查询基准日期之后的所有数据

### 2. 增量订单查询

```sql
-- 获取基准日期之后创建或更新的订单
SELECT * FROM orders 
WHERE date >= ? OR updated_at >= ?
ORDER BY date ASC, order_id ASC
```

### 3. 增量利息查询

```sql
-- 获取基准日期之后的利息记录
SELECT * FROM income_records 
WHERE date >= ? AND type = 'interest'
ORDER BY order_id, date ASC
```

### 4. 增量本金归还查询

```sql
-- 获取基准日期之后的本金归还记录
SELECT * FROM income_records 
WHERE date >= ? AND type = 'principal_reduction'
ORDER BY order_id, date ASC
```

### 5. 增量开销查询

```sql
-- 获取基准日期之后的开销记录
SELECT * FROM expense_records 
WHERE date >= ?
ORDER BY date ASC
```

## 数据合并逻辑

### 订单数据合并

对于每个订单，合并以下数据：
1. **订单基本信息**：从 orders 表获取
2. **利息记录**：从 income_records 表获取（type='interest'）
   - 计算利息总数
   - 保存每笔利息明细（用于展开查看）
3. **本金归还**：从 income_records 表获取（type='principal_reduction'）
   - 累计归还本金
4. **订单状态**：从 orders 表获取当前状态
5. **备注**：根据操作类型生成
   - 新订单：显示"新订单"
   - 有本金归还：显示"归还本金 X元"
   - 订单完成：显示"订单完成"
   - 违约完成：显示"违约完成"

## 汇总行计算

### 订单汇总

- **订单金额总和**：所有增量订单的金额总和
- **利息总数总和**：所有订单的利息累计总和
- **归还本金总和**：所有订单的归还本金总和
- **订单数量**：增量订单总数

### 开销汇总

- **公司开销总和**：所有公司开销的累计
- **其他开销总和**：所有其他开销的累计
- **总开销**：公司开销 + 其他开销

## 示例数据预览

### 完整示例

假设基准日期是 2024-01-14，当前日期是 2024-01-20：

**增量订单报表：**

| 日期 | 订单号 | 会员 | 订单金额 | 利息总数 | 归还本金 | 订单状态 | 备注 |
|------|--------|------|----------|----------|----------|----------|------|
| 2024-01-15 | ORD001 | A | 10,000.00 | 1,500.00 | 2,000.00 | 完成 | 新订单→归还本金→完成 |
| 2024-01-17 | ORD002 | B | 20,000.00 | 1,000.00 | 0.00 | 正常 | 新订单 |
| 2024-01-19 | ORD003 | A | 15,000.00 | 0.00 | 0.00 | 正常 | 新订单 |
| 汇总 | - | - | 45,000.00 | 2,500.00 | 2,000.00 | - | 3个订单 |

**ORD001订单的利息明细（展开后）：**
```
利息总数: 1,500.00
  ├─ 利息1: 500.00 (2024-01-15)
  ├─ 利息2: 500.00 (2024-01-16)
  └─ 利息3: 500.00 (2024-01-17)
```

**开销明细：**

| 日期 | 类型 | 金额 | 备注 |
|------|------|------|------|
| 2024-01-15 | 公司开销 | 500.00 | 办公用品 |
| 2024-01-18 | 其他开销 | 200.00 | 差旅费 |
| 汇总 | - | 700.00 | - |

## 关键特性

1. **增量数据**：只显示基准日期之后的数据变化
2. **利息明细可展开**：利息总数列可以展开查看每期明细
3. **数据完整性**：包含订单、利息、本金归还、开销等所有变化
4. **易于合并**：表格格式便于手动合并到总报表
5. **自动汇总**：最后一行自动计算汇总数据

