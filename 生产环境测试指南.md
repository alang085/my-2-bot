# 生产环境测试指南

## ⚠️ 重要提示

在生产环境中运行测试脚本需要格外小心。本文档提供安全的生产环境测试方法。

---

## 📋 可用的测试脚本

### 1. `test_production_safe.py` - 生产环境安全测试脚本（推荐）

**特点**：
- ✅ **只读模式**：不会修改任何数据
- ✅ **安全检查**：显示数据库路径和文件信息
- ✅ **完整测试**：覆盖所有核心功能验证
- ✅ **详细报告**：提供完整的测试结果

**测试内容**：
1. 数据库连接测试
2. 数据库信息检查
3. 数据一致性验证（只读）
4. 数据正确性验证（只读）

**安全性保证**：
- 不执行任何写入操作
- 不创建、修改或删除数据
- 不执行统计更新
- 不记录操作历史

---

## 🚀 使用方法

### 方法一：直接运行（推荐）

```bash
python test_production_safe.py
```

### 方法二：使用环境变量指定数据库路径

```bash
# 如果数据库在不同路径
export DATA_DIR=/data
python test_production_safe.py
```

### 方法三：在容器中运行

```bash
# SSH 进入容器
docker exec -it <container_name> bash

# 运行测试
cd /app
python test_production_safe.py
```

---

## 📊 测试输出示例

```
================================================================================
生产环境安全测试脚本（只读模式）
================================================================================

⚠️  警告: 此脚本运行在生产环境
✅ 安全: 只读模式，不会修改任何数据

测试时间: 2025-12-02 22:50:00
测试日期: 2025-12-02

数据库路径: /data/loan_bot.db
数据库文件大小: 12.34 MB

================================================================================
数据库连接测试
================================================================================

数据库路径: /data/loan_bot.db
数据库文件存在: True

[PASS] 数据库连接测试

当前流动资金: 1,234,567.89 元

================================================================================
数据库信息检查
================================================================================

总订单数: 533
订单状态分布:
  breach: 14
  breach_end: 3
  end: 13
  normal: 350
  overdue: 153

财务数据概览:
  有效订单: 503 个
  有效金额: 3,204,006.00 元
  流动资金: 1,234,567.89 元
  利息收入: 15,000.00 元

今日收入记录: 51 条

[PASS] 数据库信息检查

================================================================================
数据一致性验证（只读模式）
================================================================================

[1] 验证财务数据一致性...
[PASS] 财务数据一致性检查

[2] 验证订单状态一致性...
[PASS] 订单状态一致性检查

[3] 验证收入记录完整性...
[PASS] 收入记录完整性检查

================================================================================
数据正确性验证（只读模式）
================================================================================

[1] 验证订单统计正确性...
[WARN] 订单统计正确性: 违约订单数不匹配: 统计=16, 实际=14
[WARN] 订单统计正确性: 完成订单金额不匹配: 统计=257994.00, 实际=62000.00

[2] 验证收入记录金额正确性...
[PASS] 收入记录金额正确性检查

================================================================================
测试总结
================================================================================
[PASS] 通过: 8
[FAIL] 失败: 0
[WARN] 警告: 2

警告列表:
  - 订单统计正确性: 违约订单数不匹配: 统计=16, 实际=14
  - 订单统计正确性: 完成订单金额不匹配: 统计=257994.00, 实际=62000.00

================================================================================
测试完成 - 生产环境只读模式
================================================================================
✅ 所有测试均为只读操作，未修改任何数据
================================================================================
```

---

## ⚠️ 安全注意事项

### 1. 只读模式

✅ **安全操作**：
- 查询数据库
- 读取统计数据
- 验证数据一致性
- 生成报告

❌ **不会执行**：
- 写入数据库
- 修改统计数据
- 创建操作记录
- 更新订单状态
- 记录收入或开销

### 2. 数据库路径

脚本会自动识别数据库路径：
- 如果设置了 `DATA_DIR` 环境变量，使用该路径
- 否则使用脚本所在目录

**验证数据库路径**：
脚本会显示数据库路径和文件大小，请确认是正确的生产数据库。

### 3. 测试时间

建议在以下时间运行：
- 非业务高峰期
- 维护窗口期
- 低流量时段

---

## 🔍 测试内容详解

### 1. 数据库连接测试

- 检查数据库文件是否存在
- 测试数据库连接
- 显示数据库路径和大小
- 获取基本财务数据

### 2. 数据库信息检查

- 统计订单总数
- 按状态分类订单
- 显示财务数据概览
- 统计今日收入记录

### 3. 数据一致性验证

- **财务数据一致性**：验证所有金额字段类型正确
- **订单状态一致性**：验证所有订单状态有效
- **收入记录完整性**：验证收入记录字段完整

### 4. 数据正确性验证

- **订单统计正确性**：对比实际订单统计与数据库统计
- **收入记录金额正确性**：验证所有金额为正数

---

## 📝 问题处理

### 发现数据不一致

如果测试发现数据不一致（如统计不匹配）：

1. **记录问题**：保存测试报告
2. **分析原因**：检查是否有未完成的操作
3. **修复方案**：使用 `/fix_statistics` 命令修复（在 Bot 中执行）

### 测试失败

如果测试失败：

1. **检查数据库路径**：确认 `DATA_DIR` 环境变量正确
2. **检查文件权限**：确认有读取权限
3. **检查数据库完整性**：数据库文件可能损坏
4. **查看详细错误**：错误信息会显示在输出中

---

## 🔄 定期测试建议

### 建议频率

- **每日检查**：数据完整性检查
- **每周检查**：完整功能测试
- **部署前后**：验证数据一致性

### 自动化

可以设置定时任务自动运行测试：

```bash
# 添加到 crontab
0 2 * * * cd /app && python test_production_safe.py >> /var/log/test.log 2>&1
```

---

## 📊 测试报告

测试完成后会生成：

1. **控制台输出**：实时显示测试进度和结果
2. **测试总结**：通过/失败/警告统计
3. **详细信息**：数据不一致的具体内容

**保存报告**：
```bash
python test_production_safe.py > test_report_$(date +%Y%m%d_%H%M%S).txt 2>&1
```

---

## 🚫 不推荐的测试脚本

### ❌ `test_complete_local.py`

**不推荐原因**：
- 包含写入操作（创建测试数据）
- 会修改统计数据（虽然会恢复）
- 不适合生产环境

### ❌ `test_data_integrity.py`

**不推荐原因**：
- 没有明确标注只读模式
- 可能包含写入操作

---

## ✅ 最佳实践

1. **使用只读测试脚本**：`test_production_safe.py`
2. **定期运行测试**：建议每天一次
3. **保存测试报告**：记录历史测试结果
4. **及时处理问题**：发现数据不一致立即修复
5. **备份数据**：测试前确保有数据备份（虽然测试不会修改数据）

---

## 📞 支持

如果遇到问题：

1. 查看测试输出中的错误信息
2. 检查数据库路径和权限
3. 确认环境变量设置正确
4. 联系开发团队获取支持

---

**更新日期**: 2025-12-02  
**版本**: 1.0  
**状态**: ✅ 可用

