# 增量报表系统测试指南

## 测试结果

✅ **所有核心功能测试通过！**

### 测试项目

1. ✅ 基准日期管理 - 正常
2. ✅ 增量数据准备 - 正常
3. ✅ 增量统计计算 - 正常
4. ✅ 增量报表预览 - 正常
5. ✅ Excel报表导出 - 正常（已生成文件）
6. ✅ 合并记录管理 - 正常

## 快速测试

### 方法1: 运行测试脚本

```bash
# 基础功能测试
python test_incremental_report.py

# 完整流程测试
python test_incremental_with_data.py
```

### 方法2: 在Telegram中测试

1. **启动机器人**
   ```bash
   python main.py
   ```

2. **预览增量报表**
   ```
   /preview_incremental
   ```

3. **手动合并报表**
   ```
   /merge_incremental
   ```

4. **等待定时任务**
   - 每天11:05自动发送增量报表Excel
   - Excel附带"合并到总表"按钮

## 完整测试流程

### 步骤1: 准备测试数据

1. **设置基准日期**
   - 系统首次运行会自动设置
   - 或手动设置：修改数据库 `baseline_report` 表

2. **创建测试订单**（在基准日期之后）
   ```
   在Telegram群组中：
   /create S01 A 10000
   /create S02 B 20000
   ```

3. **记录利息**
   ```
   在订单群组中：
   +500
   +1000
   ```

4. **记录开销**
   ```
   在Telegram私聊中：
   /expense company 500 办公用品
   /expense other 200 其他费用
   ```

### 步骤2: 测试报表生成

1. **运行测试脚本**
   ```bash
   python test_incremental_report.py
   ```

2. **检查Excel文件**
   - 文件位置: `temp/增量订单报表_YYYY-MM-DD.xlsx`
   - 打开Excel文件，检查：
     - 订单数据是否正确
     - 利息明细是否可以展开/折叠
     - 汇总行是否正确

### 步骤3: 测试合并功能

1. **在Telegram中测试**
   - 等待11:05自动发送报表
   - 或手动触发：`/merge_incremental`
   - 点击Excel报表的"合并到总表"按钮

2. **测试重复合并**
   - 再次点击合并按钮
   - 应该提示"已合并过，是否继续？"
   - 确认后执行合并

3. **验证合并结果**
   - 检查全局统计数据是否更新
   - 检查合并记录是否保存

## 测试检查清单

### 功能测试

- [x] 基准日期自动创建
- [x] 基准日期查询和更新
- [x] 增量订单查询
- [x] 增量开销查询
- [x] 增量统计计算
- [x] Excel报表生成
- [x] 利息明细展开/折叠
- [x] 合并记录管理
- [x] 重复合并检测
- [x] 全局数据更新

### Excel报表测试

- [x] 报表文件生成成功
- [x] 表头格式正确
- [x] 数据行格式正确
- [x] 汇总行计算正确
- [x] 利息明细可以展开/折叠
- [x] 列宽自动调整
- [x] 样式应用正确

### 定时任务测试

- [ ] 11:05自动执行（需要等待到指定时间）
- [ ] Excel文件自动生成
- [ ] 自动发送给所有管理员
- [ ] 合并按钮正确显示

### 合并功能测试

- [ ] 首次合并成功
- [ ] 重复合并提示正确
- [ ] 确认合并后执行成功
- [ ] 全局数据正确更新
- [ ] 合并记录正确保存

## 常见问题

### Q1: 测试时没有增量数据？

**A:** 这是正常的，因为：
- 如果基准日期是今天，今天之前的数据不会显示
- 需要创建一些在基准日期之后的订单和记录

**解决方法：**
1. 将基准日期设置为几天前
2. 创建一些测试订单
3. 记录一些利息和开销

### Q2: Excel文件在哪里？

**A:** Excel文件保存在 `temp/` 目录下：
- 文件名格式: `增量订单报表_YYYY-MM-DD.xlsx`
- 完整路径: `项目根目录/temp/增量订单报表_YYYY-MM-DD.xlsx`

### Q3: 如何测试定时任务？

**A:** 有几种方法：
1. **等待到11:05** - 最真实，但需要等待
2. **修改代码临时调整时间** - 用于快速测试
3. **手动调用函数** - 在Python中直接调用 `send_incremental_orders_report()`

### Q4: 合并后数据没有更新？

**A:** 检查以下几点：
1. 合并是否成功执行（查看返回消息）
2. 合并的数据是否在基准日期之后
3. 全局统计数据是否正确更新（使用 `/report` 查看）

## 测试数据示例

### 创建测试订单

```sql
-- 在数据库中插入测试订单（示例）
INSERT INTO orders (order_id, group_id, group_name, customer, amount, date, state, created_at)
VALUES 
  ('TEST001', 123456, '测试群组1', 'A', 10000.00, '2025-12-15', 'normal', '2025-12-15 10:00:00'),
  ('TEST002', 123457, '测试群组2', 'B', 20000.00, '2025-12-15', 'normal', '2025-12-15 11:00:00');
```

### 记录测试利息

```sql
-- 在数据库中插入测试利息记录（示例）
INSERT INTO income_records (order_id, type, amount, date, created_at)
VALUES 
  ('TEST001', 'interest', 500.00, '2025-12-15', '2025-12-15 12:00:00'),
  ('TEST001', 'interest', 500.00, '2025-12-16', '2025-12-16 12:00:00'),
  ('TEST002', 'interest', 1000.00, '2025-12-15', '2025-12-15 13:00:00');
```

### 记录测试开销

```sql
-- 在数据库中插入测试开销记录（示例）
INSERT INTO expense_records (type, amount, date, note, created_at)
VALUES 
  ('company', 500.00, '2025-12-15', '测试公司开销', '2025-12-15 14:00:00'),
  ('other', 200.00, '2025-12-15', '测试其他开销', '2025-12-15 15:00:00');
```

## 下一步

1. ✅ 所有核心功能已实现并通过测试
2. 📝 可以开始使用系统
3. 🔄 等待11:05自动发送报表
4. 📊 查看生成的Excel报表
5. 🔗 测试合并功能

## 相关文件

- `test_incremental_report.py` - 基础功能测试脚本
- `test_incremental_with_data.py` - 完整流程测试脚本
- `增量报表功能说明.md` - 功能说明文档
- `temp/增量订单报表_*.xlsx` - 生成的Excel报表文件

