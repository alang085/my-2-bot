# 生产环境部署检查清单

## 代码优化检查

### 1. Excel报表权限 ✅
- [x] 增量报表预览权限已扩展到员工
- [x] 每日数据变更表权限已扩展到员工
- [x] 订单总表权限已扩展到员工
- [x] 合并功能保持管理员权限

### 2. 代码质量检查
- [ ] 运行所有测试脚本
- [ ] 检查语法错误
- [ ] 检查导入错误
- [ ] 检查日志记录

## Excel报表功能测试

### 1. 增量订单报表
- [ ] 测试生成Excel文件
- [ ] 验证表头格式
- [ ] 验证数据行格式
- [ ] 验证汇总行
- [ ] 验证利息明细分组
- [ ] 验证开销明细工作表

### 2. 每日数据变更报表
- [ ] 测试生成Excel文件
- [ ] 验证数据汇总
- [ ] 验证格式正确

### 3. 订单总表
- [ ] 测试生成Excel文件
- [ ] 验证所有工作表
- [ ] 验证数据完整性

## 基准日期准备

### 第一次整体报表录入准备

#### 步骤1: 确认基准日期
- [ ] 确认基准日期设置
- [ ] 基准日期应该是第一次录入的日期
- [ ] 使用 `/preview_incremental` 检查基准日期

#### 步骤2: 数据准备
- [ ] 确认所有历史订单已录入
- [ ] 确认所有历史利息已录入
- [ ] 确认所有历史开销已录入
- [ ] 确认数据完整性

#### 步骤3: 设置基准日期
**方法1: 自动设置（推荐）**
- 系统首次运行会自动设置当前日期为基准日期
- 如果已有数据，需要手动设置基准日期

**方法2: 手动设置**
```sql
-- 在数据库中设置基准日期
UPDATE baseline_report 
SET baseline_date = '2025-12-16', updated_at = CURRENT_TIMESTAMP 
WHERE id = 1;

-- 如果不存在，插入
INSERT INTO baseline_report (id, baseline_date) 
VALUES (1, '2025-12-16');
```

#### 步骤4: 验证准备情况
- [ ] 运行 `test_all_excel_reports.py` 测试
- [ ] 检查基准日期是否正确
- [ ] 检查增量数据查询是否正常
- [ ] 生成测试Excel验证格式

## 部署前检查

### 1. 数据库检查
- [ ] 确认所有表已创建
- [ ] 确认 `baseline_report` 表存在
- [ ] 确认 `incremental_merge_records` 表存在
- [ ] 确认索引已创建

### 2. 配置文件检查
- [ ] 确认 `BOT_TOKEN` 已设置
- [ ] 确认 `ADMIN_IDS` 已设置
- [ ] 确认时区设置正确（Asia/Shanghai）

### 3. 定时任务检查
- [ ] 确认增量报表定时任务已设置（11:05）
- [ ] 确认日切报表定时任务已设置（23:00）
- [ ] 确认其他定时任务正常

### 4. 权限检查
- [ ] 确认员工权限配置正确
- [ ] 确认管理员权限配置正确
- [ ] 测试权限是否正常工作

## 部署步骤

### 1. 代码部署
```bash
# 1. 备份当前代码
git commit -am "准备部署Excel报表功能"

# 2. 推送到远程仓库
git push origin main

# 3. 在生产环境拉取最新代码
git pull origin main
```

### 2. 数据库迁移
```bash
# 1. 备份数据库
cp loan_bot.db loan_bot.db.backup

# 2. 运行数据库初始化（会创建新表，不会删除数据）
python init_db.py
```

### 3. 设置基准日期
```python
# 方法1: 通过命令设置（推荐）
# 在Telegram中使用 /preview_incremental 查看基准日期
# 如果需要修改，直接修改数据库

# 方法2: 直接修改数据库
# 使用SQLite工具或Python脚本
```

### 4. 测试验证
```bash
# 1. 运行完整测试
python test_all_excel_reports.py

# 2. 测试命令
# 在Telegram中测试：
# - /preview_incremental
# - /daily_changes
# - /ordertable
```

### 5. 监控检查
- [ ] 检查日志输出
- [ ] 检查定时任务是否正常执行
- [ ] 检查Excel文件是否正常生成
- [ ] 检查错误日志

## 第一次整体报表录入流程

### 场景：已有历史数据，需要设置基准日期

#### 步骤1: 确认数据完整性
1. 检查所有历史订单是否已录入
2. 检查所有历史利息是否已录入
3. 检查所有历史开销是否已录入
4. 验证数据统计是否正确

#### 步骤2: 设置基准日期
**重要：基准日期应该是最后一次录入历史数据的日期**

例如：
- 如果历史数据录入到 2025-12-15
- 那么基准日期应该设置为 2025-12-15
- 之后从 2025-12-16 开始的数据将作为增量数据

#### 步骤3: 验证设置
```python
# 运行测试脚本
python test_all_excel_reports.py

# 检查输出：
# - 基准日期是否正确
# - 增量数据查询是否正常
# - Excel生成是否正常
```

#### 步骤4: 生成第一次增量报表
1. 等待第二天11:05自动生成
2. 或手动触发：`/preview_incremental`
3. 检查Excel报表内容
4. 确认数据正确

#### 步骤5: 合并到总表
1. 点击Excel报表的"合并到总表"按钮
2. 或使用命令：`/merge_incremental`
3. 确认合并成功
4. 验证全局数据已更新

## 注意事项

### 1. 基准日期设置
- ⚠️ **重要**：基准日期设置后，该日期之前的数据不会出现在增量报表中
- ⚠️ **建议**：基准日期设置为最后一次完整录入数据的日期
- ⚠️ **注意**：如果设置错误，需要手动修改数据库

### 2. 数据一致性
- 确保所有历史数据已完整录入
- 确保数据统计正确
- 确保没有遗漏的数据

### 3. 权限管理
- 员工可以查看和导出Excel报表
- 只有管理员可以合并增量报表
- 确保权限配置正确

### 4. 定时任务
- 增量报表：每天11:05自动发送
- 日切报表：每天23:00自动发送
- 确保时区设置正确（Asia/Shanghai）

### 5. 文件管理
- Excel文件保存在 `temp/` 目录
- 建议定期清理旧文件
- 或设置自动清理机制

## 回滚方案

如果部署出现问题：

1. **代码回滚**
```bash
git checkout <previous_commit>
git push origin main
```

2. **数据库回滚**
```bash
# 恢复数据库备份
cp loan_bot.db.backup loan_bot.db
```

3. **功能禁用**
- 可以临时禁用定时任务
- 或删除相关表（如果不需要）

## 验证清单

部署后验证：

- [ ] 所有Excel报表功能正常
- [ ] 权限设置正确
- [ ] 定时任务正常执行
- [ ] 基准日期设置正确
- [ ] 增量数据查询正常
- [ ] Excel文件格式正确
- [ ] 合并功能正常
- [ ] 日志记录正常
- [ ] 错误处理正常

## 相关文件

- `test_all_excel_reports.py` - 完整测试脚本
- `test_incremental_report.py` - 增量报表测试
- `test_excel_reports.py` - Excel报表测试
- `verify_excel_content.py` - Excel内容验证
- `init_db.py` - 数据库初始化
- `handlers/command_handlers.py` - 命令处理器
- `handlers/daily_changes_handlers.py` - 每日变更处理器
- `handlers/order_table_handlers.py` - 订单总表处理器
- `utils/excel_export.py` - Excel导出功能
- `utils/incremental_report_generator.py` - 增量报表生成器

