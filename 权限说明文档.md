# 权限说明文档

## 📋 权限角色定义

系统中有三种权限角色：

1. **管理员 (Admin)**
   - 定义：在 `config.py` 的 `ADMIN_IDS` 中配置的用户ID
   - 权限：拥有所有功能的完全访问权限

2. **授权员工 (Authorized Employee)**
   - 定义：在数据库 `authorized_users` 表中的用户ID
   - 权限：可以使用大部分业务功能，但不能进行系统管理操作

3. **受限用户 (Restricted User)**
   - 定义：在数据库 `user_group_mapping` 表中分配了归属ID的用户
   - 权限：只能查看指定归属ID的报表，不能进行其他操作

4. **普通用户 (Regular User)**
   - 定义：未授权的用户
   - 权限：无任何操作权限

---

## 🔐 权限层级

```
管理员 (Admin)
  ├─ 所有管理员功能
  └─ 所有员工功能
      └─ 所有受限用户功能

授权员工 (Authorized Employee)
  ├─ 所有员工功能
  └─ 受限用户功能（如果被分配了归属ID）

受限用户 (Restricted User)
  └─ 仅查看指定归属ID的报表

普通用户 (Regular User)
  └─ 无权限
```

---

## 📝 命令权限列表

### 基础命令（私聊，需要授权）

| 命令 | 权限要求 | 场景 | 功能说明 |
|------|---------|------|---------|
| `/start` | 管理员 + 员工 | 私聊 | 显示帮助信息 |
| `/report [归属ID]` | 管理员 + 员工 | 私聊 | 查看报表（可指定归属ID） |
| `/myreport` | 受限用户 | 私聊 | 查看自己归属ID的报表（不显示开销与余额） |
| `/search` | 管理员 + 员工 | 私聊 | 搜索订单 |
| `/accounts` | 管理员 + 员工 | 私聊 | 查看所有支付账户 |
| `/gcash` | 管理员 + 员工 | 私聊 | 查看/管理 GCash 账户 |
| `/paymaya` | 管理员 + 员工 | 私聊 | 查看/管理 PayMaya 账户 |
| `/schedule` | 管理员 + 员工 | 私聊 | 管理定时播报 |

### 订单操作命令（群组，需要授权）

| 命令 | 权限要求 | 场景 | 功能说明 |
|------|---------|------|---------|
| `/create` | 管理员 + 员工 | 群组 | 从群名创建订单 |
| `/order` | 管理员 + 员工 | 群组 | 查看当前订单信息 |
| `/normal` | 管理员 + 员工 | 群组 | 设置订单为正常状态 |
| `/overdue` | 管理员 + 员工 | 群组 | 设置订单为逾期状态 |
| `/end` | 管理员 + 员工 | 群组 | 设置订单为完成状态 |
| `/breach` | 管理员 + 员工 | 群组 | 设置订单为违约状态 |
| `/breach_end` | 管理员 + 员工 | 群组 | 设置订单为违约完成状态 |
| `/broadcast` | 管理员 + 员工 | 群组 | 播报付款提醒 |

### 快捷操作（群组，需要授权）

| 操作 | 权限要求 | 场景 | 功能说明 |
|------|---------|------|---------|
| `+金额` | 管理员 + 员工 | 群组 | 快捷本金减少操作 |

### 管理命令（私聊，仅管理员）

| 命令 | 权限要求 | 场景 | 功能说明 |
|------|---------|------|---------|
| `/adjust <金额> [备注]` | 仅管理员 | 私聊 | 调整流动资金余额 |
| `/create_attribution <归属ID>` | 仅管理员 | 私聊 | 创建新的归属ID |
| `/list_attributions` | 仅管理员 | 私聊 | 列出所有归属ID |
| `/add_employee <用户ID>` | 仅管理员 | 私聊 | 添加授权员工 |
| `/remove_employee <用户ID>` | 仅管理员 | 私聊 | 移除授权员工 |
| `/list_employees` | 仅管理员 | 私聊 | 列出所有授权员工 |
| `/update_weekday_groups` | 仅管理员 | 私聊 | 更新所有订单的星期分组 |
| `/fix_statistics` | 仅管理员 | 私聊 | 修复统计数据 |
| `/find_tail_orders` | 仅管理员 | 私聊 | 查找金额尾数异常的订单 |
| `/set_user_group_id <用户ID> <归属ID>` | 仅管理员 | 私聊 | 设置用户可查看的归属ID |
| `/remove_user_group_id <用户ID>` | 仅管理员 | 私聊 | 移除用户的归属ID权限 |
| `/list_user_group_mappings` | 仅管理员 | 私聊 | 列出所有用户-归属ID映射 |

---

## 🎯 功能权限列表

### 报表功能

| 功能 | 管理员 | 员工 | 受限用户 | 普通用户 |
|------|--------|------|----------|----------|
| 查看全局报表 | ✅ | ✅ | ❌ | ❌ |
| 查看归属ID报表 | ✅ | ✅ | ✅（仅自己） | ❌ |
| 查看开销与余额 | ✅ | ✅ | ❌ | ❌ |
| 录入公司开销 | ✅ | ✅ | ❌ | ❌ |
| 录入其他开销 | ✅ | ✅ | ❌ | ❌ |
| 按归属查询 | ✅ | ✅ | ❌ | ❌ |
| 查找订单 | ✅ | ✅ | ❌ | ❌ |

### 订单管理功能

| 功能 | 管理员 | 员工 | 受限用户 | 普通用户 |
|------|--------|------|----------|----------|
| 创建订单 | ✅ | ✅ | ❌ | ❌ |
| 查看订单信息 | ✅ | ✅ | ❌ | ❌ |
| 更改订单状态 | ✅ | ✅ | ❌ | ❌ |
| 更改订单归属 | ✅ | ✅ | ❌ | ❌ |
| 本金减少 | ✅ | ✅ | ❌ | ❌ |
| 利息收入 | ✅ | ✅ | ❌ | ❌ |

### 搜索功能

| 功能 | 管理员 | 员工 | 受限用户 | 普通用户 |
|------|--------|------|----------|----------|
| 搜索订单 | ✅ | ✅ | ❌ | ❌ |
| 按总有效金额查找 | ✅ | ✅ | ❌ | ❌ |
| 批量更改归属 | ✅ | ✅ | ❌ | ❌ |

### 支付账户管理

| 功能 | 管理员 | 员工 | 受限用户 | 普通用户 |
|------|--------|------|----------|----------|
| 查看账户列表 | ✅ | ✅ | ❌ | ❌ |
| 添加账户 | ✅ | ✅ | ❌ | ❌ |
| 编辑账户 | ✅ | ✅ | ❌ | ❌ |
| 删除账户 | ✅ | ✅ | ❌ | ❌ |
| 更新余额 | ✅ | ✅ | ❌ | ❌ |

### 定时播报功能

| 功能 | 管理员 | 员工 | 受限用户 | 普通用户 |
|------|--------|------|----------|----------|
| 查看定时任务 | ✅ | ✅ | ❌ | ❌ |
| 创建定时任务 | ✅ | ✅ | ❌ | ❌ |
| 编辑定时任务 | ✅ | ✅ | ❌ | ❌ |
| 删除定时任务 | ✅ | ✅ | ❌ | ❌ |
| 启用/禁用任务 | ✅ | ✅ | ❌ | ❌ |

### 系统管理功能

| 功能 | 管理员 | 员工 | 受限用户 | 普通用户 |
|------|--------|------|----------|----------|
| 调整资金 | ✅ | ❌ | ❌ | ❌ |
| 创建归属ID | ✅ | ❌ | ❌ | ❌ |
| 管理员工 | ✅ | ❌ | ❌ | ❌ |
| 管理用户权限 | ✅ | ❌ | ❌ | ❌ |
| 修复统计数据 | ✅ | ❌ | ❌ | ❌ |
| 诊断工具 | ✅ | ❌ | ❌ | ❌ |

---

## 🔒 权限检查机制

### 装饰器说明

1. **`@admin_required`**
   - 检查用户是否在 `ADMIN_IDS` 中
   - 仅管理员可以使用

2. **`@authorized_required`**
   - 检查用户是否是管理员或授权员工
   - 管理员和员工都可以使用

3. **`@private_chat_only`**
   - 检查是否在私聊中使用
   - 群组中会显示错误提示

4. **`@group_chat_only`**
   - 检查是否在群组中使用
   - 私聊中会显示错误提示

### 特殊权限检查

1. **开销录入权限**
   - 位置：`callbacks/report_callbacks.py::_check_expense_permission()`
   - 检查：管理员或授权员工
   - 应用：公司开销、其他开销的录入

2. **归属ID查看权限**
   - 位置：`callbacks/report_callbacks.py::handle_report_callback()`
   - 检查：受限用户只能查看分配的归属ID
   - 应用：报表查看、归属查询

---

## 📊 权限矩阵总结

### 完整权限矩阵

| 功能类别 | 管理员 | 员工 | 受限用户 | 普通用户 |
|---------|--------|------|----------|----------|
| **订单管理** | | | | |
| 创建订单 | ✅ | ✅ | ❌ | ❌ |
| 查看订单 | ✅ | ✅ | ❌ | ❌ |
| 状态变更 | ✅ | ✅ | ❌ | ❌ |
| 金额操作 | ✅ | ✅ | ❌ | ❌ |
| **报表功能** | | | | |
| 全局报表 | ✅ | ✅ | ❌ | ❌ |
| 归属报表 | ✅ | ✅ | ✅（仅自己） | ❌ |
| 开销录入 | ✅ | ✅ | ❌ | ❌ |
| 开销查看 | ✅ | ✅ | ❌ | ❌ |
| **搜索功能** | ✅ | ✅ | ❌ | ❌ |
| **账户管理** | ✅ | ✅ | ❌ | ❌ |
| **定时播报** | ✅ | ✅ | ❌ | ❌ |
| **系统管理** | ✅ | ❌ | ❌ | ❌ |

---

## 🛠️ 权限管理命令

### 添加员工权限
```bash
/add_employee <用户ID>
```
- 权限：仅管理员
- 功能：将用户添加到授权员工列表

### 移除员工权限
```bash
/remove_employee <用户ID>
```
- 权限：仅管理员
- 功能：从授权员工列表中移除用户

### 设置用户归属ID权限
```bash
/set_user_group_id <用户ID> <归属ID>
```
- 权限：仅管理员
- 功能：设置用户只能查看指定归属ID的报表

### 移除用户归属ID权限
```bash
/remove_user_group_id <用户ID>
```
- 权限：仅管理员
- 功能：移除用户的归属ID限制，恢复为普通用户

### 查看所有员工
```bash
/list_employees
```
- 权限：仅管理员
- 功能：列出所有授权员工

### 查看所有用户-归属ID映射
```bash
/list_user_group_mappings
```
- 权限：仅管理员
- 功能：列出所有受限用户及其分配的归属ID

---

## ⚠️ 注意事项

1. **权限继承**
   - 管理员自动拥有所有员工权限
   - 员工如果被分配了归属ID，仍然可以使用所有员工功能

2. **受限用户限制**
   - 受限用户只能查看报表，不能进行任何操作
   - 受限用户看不到开销与余额信息
   - 受限用户不能使用搜索、查找等功能

3. **开销录入权限**
   - 只有管理员和授权员工可以录入开销
   - 普通用户和受限用户都无法录入开销

4. **场景限制**
   - 某些命令只能在私聊中使用（如 `/report`）
   - 某些命令只能在群组中使用（如 `/order`）
   - 违反场景限制会显示错误提示

5. **权限检查顺序**
   - 先检查场景限制（私聊/群组）
   - 再检查权限要求（管理员/员工）
   - 最后检查特殊权限（如开销录入、归属ID查看）

---

## 📝 更新日志

- **2025-01-XX**: 初始版本
  - 定义了管理员、员工、受限用户、普通用户四种角色
  - 整理了所有命令和功能的权限要求
  - 添加了开销录入权限检查
  - 添加了用户-归属ID映射功能

