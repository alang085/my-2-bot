# 本地测试脚本使用说明

## 📋 测试脚本列表

### 1. `test_complete_local.py` - 完整功能测试脚本

**功能**：
- 数据库连接测试
- 数据一致性验证
- 数据正确性验证
- 撤销功能隔离测试
- 统计更新功能测试
- 收入记录功能测试

**使用方法**：
```bash
python test_complete_local.py
```

**输出**：
- ✅ 通过的测试
- ❌ 失败的测试
- ⚠️ 警告信息
- 详细的测试总结

---

### 2. `test_data_integrity.py` - 数据完整性检查脚本

**功能**：
- 订单统计数据检查
- 收入记录完整性检查
- 操作历史完整性检查
- 数据不一致问题报告

**使用方法**：
```bash
python test_data_integrity.py
```

**输出**：
- 实际统计数据 vs 数据库统计数据对比
- 数据不一致问题列表
- 修复建议

---

## 🔧 测试覆盖范围

### 数据一致性验证

1. **财务数据一致性**
   - 验证所有金额字段都是数字类型
   - 检查负数金额（除流动资金外）
   - 验证数据结构完整性

2. **订单状态一致性**
   - 验证所有订单状态都在有效范围内
   - 检查无效状态的订单
   - 验证状态转换逻辑

3. **收入记录完整性**
   - 验证必需字段存在
   - 检查数据格式正确性
   - 验证金额有效性

4. **操作历史一致性**
   - 验证操作数据格式（JSON）
   - 检查操作类型有效性
   - 验证操作与数据的关联

### 数据正确性验证

1. **订单统计正确性**
   - 对比实际订单统计 vs 数据库统计
   - 验证有效订单数量和金额
   - 验证违约订单数量和金额
   - 验证完成订单数量和金额

2. **收入记录金额正确性**
   - 验证所有收入金额都是正数
   - 检查金额计算准确性

3. **操作历史完整性**
   - 检查孤立操作（引用的订单不存在）
   - 验证操作数据有效性

### 功能测试

1. **撤销功能隔离测试**
   - 测试不同聊天环境的操作隔离
   - 验证撤销查询按 chat_id 过滤

2. **统计更新功能测试**
   - 测试利息统计更新
   - 测试流动资金更新
   - 验证更新后数据恢复

3. **收入记录功能测试**
   - 测试创建收入记录
   - 验证记录查询和数据正确性

---

## 📊 测试结果解读

### 测试通过 ✅

所有测试通过表示：
- 数据库连接正常
- 数据结构完整
- 数据一致性和正确性良好
- 核心功能正常工作

### 测试失败 ❌

如果测试失败，可能的原因：
1. **数据库连接问题**
   - 检查数据库文件是否存在
   - 检查数据库文件权限

2. **数据不一致**
   - 使用 `/fix_statistics` 命令修复统计数据
   - 检查是否有未完成的操作

3. **数据结构问题**
   - 检查数据库表结构是否完整
   - 运行数据库初始化脚本

### 警告信息 ⚠️

警告信息表示：
- 数据可能存在潜在问题
- 需要进一步检查
- 建议采取预防措施

---

## 🔍 常见问题排查

### 1. 订单统计数据不匹配

**症状**：
- 实际订单数量与数据库统计不一致

**解决方案**：
```bash
# 在 Telegram Bot 中使用
/fix_statistics
```

**手动修复**：
运行 `test_data_integrity.py` 查看具体差异，然后手动修复。

### 2. 收入记录缺失

**症状**：
- 操作执行成功但收入记录不存在

**可能原因**：
- 收入记录函数执行失败
- 日期不匹配

**解决方案**：
- 检查日志文件
- 验证日期格式
- 重新执行操作

### 3. 操作历史格式错误

**症状**：
- 操作历史数据无法解析

**解决方案**：
- 检查 `operation_data` 字段格式
- 验证 JSON 格式正确性
- 删除格式错误的记录

---

## 📝 测试脚本开发建议

### 添加新测试

1. 在 `TestResult` 类中添加新的测试结果
2. 创建测试函数
3. 在 `run_all_tests()` 中调用新测试

### 测试数据隔离

- 使用测试专用的用户ID和聊天ID
- 测试完成后清理测试数据
- 避免影响生产数据

### 错误处理

- 使用 try-except 捕获异常
- 记录详细的错误信息
- 提供有意义的错误消息

---

## 🚀 持续集成建议

### 自动化测试

1. **每次代码提交后运行测试**
   ```bash
   python test_complete_local.py
   ```

2. **定期运行数据完整性检查**
   ```bash
   python test_data_integrity.py
   ```

3. **部署前验证**
   - 运行所有测试脚本
   - 检查测试结果
   - 修复发现的问题

### 测试报告

- 保存测试结果到文件
- 生成测试报告
- 跟踪测试历史

---

**更新日期**: 2025-12-02  
**状态**: ✅ 已完成

