# 本地测试和细微级别检查清单

## 🚀 快速开始

### Windows
```bash
local_test.bat
```

### Linux/Mac
```bash
chmod +x local_test.sh
./local_test.sh
```

## 📋 检查清单

### 阶段一：环境检查 ✅

- [ ] **Python版本检查**
  - 命令: `python --version`
  - 要求: Python 3.9+
  - 状态: ___

- [ ] **必要文件检查**
  - [ ] `main.py` 存在
  - [ ] `requirements.txt` 存在
  - [ ] `init_db.py` 存在
  - [ ] `config.py` 存在
  - [ ] `Dockerfile` 存在（部署用）

- [ ] **配置文件检查**
  - [ ] `user_config.py` 存在 或 环境变量已设置
  - [ ] `BOT_TOKEN` 已配置
  - [ ] `ADMIN_USER_IDS` 已配置

- [ ] **依赖安装检查**
  - 命令: `pip install -r requirements.txt`
  - 检查: 所有依赖安装成功
  - 状态: ___

### 阶段二：代码质量检查 ✅

- [ ] **语法检查**
  - 命令: `python -m py_compile main.py`
  - 检查: 无语法错误
  - 状态: ___

- [ ] **模块导入检查**
  - 命令: `python -c "import config; import db_operations; import handlers; import callbacks; import utils"`
  - 检查: 所有模块可正常导入
  - 状态: ___

- [ ] **配置加载检查**
  - 命令: `python -c "from config import load_config; load_config()"`
  - 检查: 配置加载成功
  - 状态: ___

- [ ] **代码质量检查（可选）**
  - 命令: `flake8 --max-line-length=100 --ignore=E203,E501,W503 main.py`
  - 检查: 无严重代码质量问题
  - 状态: ___

### 阶段三：数据库检查 ✅

- [ ] **数据库初始化**
  - 命令: `python init_db.py`
  - 检查: 数据库文件创建成功
  - 检查: 所有表结构创建成功
  - 状态: ___

- [ ] **数据库连接测试**
  - 命令: `python -c "import db_operations; import asyncio; asyncio.run(db_operations.get_financial_data())"`
  - 检查: 数据库连接正常
  - 状态: ___

- [ ] **表结构验证**
  - 检查表是否存在:
    - [ ] `orders`
    - [ ] `financial_data`
    - [ ] `grouped_data`
    - [ ] `daily_data`
    - [ ] `income_records`
    - [ ] `expense_records`
    - [ ] `operation_history`
    - [ ] `payment_accounts`
    - [ ] `user_permissions`
    - [ ] `company_promotion_messages`
    - [ ] `company_announcements`
    - [ ] `anti_fraud_messages`
    - [ ] `group_configs`
    - [ ] `daily_summary`

### 阶段四：功能测试 ✅

#### 4.1 基础功能

- [ ] **机器人启动**
  - 命令: `python main.py`
  - 检查: 无错误启动
  - 检查: 日志显示"机器人启动中..."
  - 状态: ___

- [ ] **权限检查命令**
  - 命令: `/check_permission`
  - 检查: 正确显示用户权限
  - 状态: ___

- [ ] **帮助命令**
  - 命令: `/start`
  - 检查: 显示帮助信息
  - 状态: ___

#### 4.2 订单功能

- [ ] **创建订单**
  - 命令: `/create` (在群组中)
  - 检查: 订单创建成功
  - 检查: 订单ID正确生成
  - 检查: 统计数据更新
  - 状态: ___

- [ ] **查看订单**
  - 命令: `/order` (在群组中)
  - 检查: 显示当前订单信息
  - 状态: ___

- [ ] **订单状态变更**
  - [ ] `/normal` - 设为正常
  - [ ] `/overdue` - 设为逾期
  - [ ] `/breach` - 设为违约
  - [ ] `/end` - 标记完成
  - [ ] `/breach_end` - 违约完成
  - 检查: 状态变更成功
  - 检查: 统计数据正确更新
  - 状态: ___

#### 4.3 金额操作

- [ ] **利息收入**
  - 命令: `+1000` (在群组中)
  - 检查: 收入记录创建
  - 检查: 统计数据更新
  - 检查: 订单完成/违约状态下默认为补利息
  - 状态: ___

- [ ] **本金减少**
  - 命令: `+500b` (在群组中)
  - 检查: 本金减少成功
  - 检查: 订单金额更新
  - 状态: ___

#### 4.4 报表功能

- [ ] **全局报表**
  - 命令: `/report`
  - 检查: 显示全局统计数据
  - 检查: 数据正确性
  - 状态: ___

- [ ] **归属报表**
  - 命令: `/report S01`
  - 检查: 显示归属ID统计数据
  - 检查: 盈余计算正确
  - 状态: ___

- [ ] **我的报表**
  - 命令: `/myreport`
  - 检查: 显示用户相关报表
  - 状态: ___

#### 4.5 搜索功能

- [ ] **搜索订单**
  - 命令: `/search order_id 0001`
  - 检查: 显示搜索结果
  - 状态: ___

- [ ] **搜索归属ID**
  - 命令: `/search group_id S01`
  - 检查: 显示该归属ID的所有订单
  - 状态: ___

#### 4.6 支付账户

- [ ] **查看所有账户**
  - 命令: `/accounts`
  - 检查: 显示账户表格
  - 状态: ___

- [ ] **查看GCash**
  - 命令: `/gcash`
  - 检查: 显示GCash账户信息
  - 状态: ___

- [ ] **查看PayMaya**
  - 命令: `/paymaya`
  - 检查: 显示PayMaya账户信息
  - 状态: ___

- [ ] **余额历史**
  - 命令: `/balance_history`
  - 检查: 显示总余额（简化版）
  - 状态: ___

#### 4.7 撤销功能

- [ ] **撤销操作**
  - 命令: `/undo`
  - 检查: 撤销上一个操作
  - 检查: 数据正确恢复
  - 状态: ___

### 阶段五：管理员功能测试 ✅

- [ ] **资金调整**
  - 命令: `/adjust +1000`
  - 检查: 流动资金更新
  - 状态: ___

- [ ] **归属ID管理**
  - [ ] `/create_attribution S01` - 创建归属ID
  - [ ] `/list_attributions` - 列出所有归属ID
  - 检查: 功能正常
  - 状态: ___

- [ ] **员工管理**
  - [ ] `/add_employee <user_id> <group_id>` - 添加员工
  - [ ] `/list_employees` - 列出所有员工
  - [ ] `/remove_employee <user_id>` - 移除员工
  - 检查: 功能正常
  - 状态: ___

- [ ] **数据修复**
  - [ ] `/fix_statistics` - 修复统计数据
  - [ ] `/fix_income_statistics` - 修复收入统计
  - 检查: 修复成功
  - 状态: ___

- [ ] **管理员数据修正**
  - [ ] `/admin_correct` - 打开修正菜单
  - [ ] 查看操作历史
  - [ ] 修改操作记录
  - [ ] 删除操作记录
  - 检查: 功能正常
  - 状态: ___

### 阶段六：群组消息功能 ✅

- [ ] **群组消息管理**
  - [ ] `/groupmsg` - 管理群组消息
  - [ ] `/announcement` - 管理公告
  - [ ] `/antifraud` - 管理防诈骗语录
  - [ ] `/promotion` - 管理宣传语录（英文界面）
  - 检查: 所有功能正常
  - 检查: 宣传语录界面为英文
  - 状态: ___

### 阶段七：数据一致性检查 ✅

- [ ] **运行数据一致性检查**
  - 命令: `python tests/test_data_consistency.py`
  - 检查: 无数据不一致问题
  - 状态: ___

- [ ] **检查项目**
  - [ ] 订单表与统计表一致性
  - [ ] 收入明细与统计数据一致性
  - [ ] 归属ID数据一致性
  - [ ] 日结数据一致性
  - [ ] 流动资金计算正确性

## 🔍 细微级别检查

### 代码层面

- [ ] **导入检查**
  - [ ] 无循环导入
  - [ ] 所有导入的模块都存在
  - [ ] 无未使用的导入

- [ ] **函数检查**
  - [ ] 所有函数都有错误处理
  - [ ] 异步函数正确使用 await
  - [ ] 数据库操作使用事务

- [ ] **配置检查**
  - [ ] 环境变量正确读取
  - [ ] 默认值设置合理
  - [ ] 错误提示清晰

### 数据库层面

- [ ] **表结构**
  - [ ] 所有字段类型正确
  - [ ] 索引创建正确
  - [ ] 外键约束正确

- [ ] **数据完整性**
  - [ ] 无孤立记录
  - [ ] 统计数据与明细数据一致
  - [ ] 订单状态转换正确

### 功能层面

- [ ] **边界条件**
  - [ ] 空数据正确处理
  - [ ] 极大值/极小值处理
  - [ ] 特殊字符处理

- [ ] **错误处理**
  - [ ] 网络错误处理
  - [ ] 数据库错误处理
  - [ ] 用户输入错误处理

## 📝 测试记录

### 测试日期: ___________

### 测试人员: ___________

### 测试环境:
- Python版本: ___________
- 操作系统: ___________
- 数据库路径: ___________

### 发现的问题:

1. ___________
2. ___________
3. ___________

### 修复状态:

- [ ] 所有问题已修复
- [ ] 部分问题待修复
- [ ] 需要进一步调查

## ✅ 测试完成确认

- [ ] 所有检查项已完成
- [ ] 所有功能测试通过
- [ ] 数据一致性检查通过
- [ ] 代码质量检查通过
- [ ] 准备部署到生产环境

**测试签名**: ___________

**日期**: ___________

