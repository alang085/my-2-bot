name: 测试

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # 每天凌晨2点（UTC时间）运行测试
    - cron: '0 2 * * *'

env:
  PYTHON_VERSION: '3.9'

jobs:
  test:
    name: 运行测试
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 设置Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: 缓存pip依赖
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov pytest-html pytest-asyncio
        pip install python-telegram-bot
        pip install openpyxl
        # 如果有requirements.txt，取消注释下一行
        # pip install -r requirements.txt

    - name: 设置测试环境变量
      env:
        BOT_TOKEN: test_token_12345
        ADMIN_USER_IDS: 12345,67890
        DATA_DIR: ./test_data
      run: |
        mkdir -p test_data
        echo "测试环境已设置"

    - name: 运行单元测试
      working-directory: ./bot3
      run: |
        pytest tests/unit/ -v --cov=. --cov-report=xml --cov-report=term-missing

    - name: 运行集成测试
      working-directory: ./bot3
      run: |
        pytest tests/integration/ -v

    - name: 运行功能测试
      working-directory: ./bot3
      run: |
        pytest tests/functional/ -v || true

    - name: 生成测试报告
      working-directory: ./bot3
      run: |
        pytest tests/ -v --html=test-report.html --self-contained-html --cov=. --cov-report=html || true

    - name: 上传覆盖率报告
      uses: codecov/codecov-action@v3
      with:
        file: ./bot3/coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

    - name: 上传测试报告
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-report-${{ matrix.python-version }}
        path: |
          bot3/test-report.html
          bot3/htmlcov/

  lint:
    name: 代码风格检查
    runs-on: ubuntu-latest

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 设置Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: 安装代码检查工具
      run: |
        python -m pip install --upgrade pip
        pip install black isort pylint flake8

    - name: 运行black检查
      working-directory: ./bot3
      run: |
        black --check . || true

    - name: 运行isort检查
      working-directory: ./bot3
      run: |
        isort --check . || true

    - name: 运行pylint检查
      working-directory: ./bot3
      run: |
        pylint bot3/ --disable=C,R,W || true

    - name: 运行flake8检查
      working-directory: ./bot3
      run: |
        flake8 bot3/ --max-line-length=100 --ignore=E501,W503 || true

  security:
    name: 安全扫描
    runs-on: ubuntu-latest

    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: 设置Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: 安装安全扫描工具
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety

    - name: 运行Bandit安全扫描
      working-directory: ./bot3
      run: |
        bandit -r bot3/ -f json -o bandit-report.json || true

    - name: 上传安全报告
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-report
        path: bot3/bandit-report.json

