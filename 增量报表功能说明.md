# 11:05增量报表功能说明

## 功能概述

系统每天11:05自动生成并发送增量订单报表Excel文件，管理员可以通过按钮将增量数据合并到总报表，系统会自动更新全局统计数据。

## 核心功能

### 1. 自动定时报表

- **执行时间**：每天11:05（北京时间）
- **报表格式**：Excel文件
- **发送对象**：所有管理员
- **报表内容**：
  - 增量订单报表（主表）
  - 开销明细（如果有开销记录）

### 2. Excel报表格式

#### 主表：增量订单报表

| 日期 | 订单号 | 会员 | 订单金额 | 利息总数 | 归还本金 | 订单状态 | 备注 |
|------|--------|------|----------|----------|----------|----------|------|
| 2024-01-15 | ORD001 | A | 10,000.00 | 1,500.00 | 0.00 | 正常 | 新订单 |
| 2024-01-16 | ORD002 | B | 20,000.00 | 1,000.00 | 2,000.00 | 正常 | 新订单→归还本金 |
| 汇总 | - | - | 30,000.00 | 2,500.00 | 2,000.00 | 2个订单 | - |

**利息明细（可展开）**：
- 利息总数列使用Excel分组功能
- 默认隐藏明细行
- 点击展开按钮可以查看每期利息明细
- 明细格式：`└─ 日期: 金额`

#### 开销明细表

| 日期 | 类型 | 金额 | 备注 |
|------|------|------|------|
| 2024-01-15 | 公司开销 | 500.00 | 办公用品 |
| 汇总 | - | 500.00 | - |

### 3. 合并功能

#### 合并按钮

- Excel报表附带"合并到总表"按钮
- 如果已合并过，按钮显示"⚠️ 已合并（再次合并）"
- 如果未合并，按钮显示"✅ 合并到总表"

#### 合并流程

1. **点击合并按钮**
   - 如果未合并过：直接执行合并
   - 如果已合并过：显示确认对话框

2. **重复检测提示**
   ```
   ⚠️ 警告：2024-01-15 的增量报表已经合并过！
   
   上次合并时间: 2024-01-15 11:10:00
   上次合并数据:
     - 订单数: 5
     - 订单金额: 50,000.00
     - 利息: 2,500.00
     - 开销: 700.00
   
   ⚠️ 再次合并会导致数据重复累加！
   确定要继续合并吗？
   ```

3. **确认合并**
   - 合并从上次合并日期+1天到当前日期的增量数据
   - 自动更新全局统计数据：
     - `financial_data` - 全局财务数据
     - `grouped_data` - 分组数据
     - `daily_data` - 日结数据
   - 保存合并记录

4. **合并结果**
   ```
   ✅ 增量报表已合并到全局数据
   
   合并日期: 2024-01-15
   合并范围: 2024-01-14 至 2024-01-15
   基准日期: 2024-01-14
   
   📦 订单统计:
     - 订单数: 5
     - 订单金额: 50,000.00
     - 新客户: 3个, 30,000.00
     - 老客户: 2个, 20,000.00
   
   💰 收入统计:
     - 利息: 2,500.00
     - 归还本金: 2,000.00
     - 完成订单: 2个, 20,000.00
     - 违约完成: 0个, 0.00
   
   💸 开销统计:
     - 公司开销: 500.00
     - 其他开销: 200.00
     - 总开销: 700.00
   ```

### 4. 基准日期管理

- **第一次执行**：自动记录当前日期为基准日期
- **后续执行**：使用已保存的基准日期
- **增量计算**：只包含基准日期之后的数据

### 5. 数据合并逻辑

#### 合并范围

- **首次合并**：从基准日期到合并日期
- **后续合并**：从上次合并日期+1天到当前合并日期
- **避免重复**：每次合并只处理新的增量数据

#### 全局数据更新

合并时会自动更新以下统计数据：

1. **新客户数据**
   - `new_clients` - 新客户数
   - `new_clients_amount` - 新客户订单金额

2. **老客户数据**
   - `old_clients` - 老客户数
   - `old_clients_amount` - 老客户订单金额

3. **完成订单**
   - `completed_orders` - 完成订单数
   - `completed_amount` - 完成订单金额

4. **违约完成订单**
   - `breach_end_orders` - 违约完成订单数
   - `breach_end_amount` - 违约完成订单金额

**注意**：利息收入在业务操作时已经自动更新，合并时不会重复更新。

## 使用流程

### 日常使用

1. **接收报表**：每天11:05自动收到增量报表Excel
2. **查看数据**：打开Excel查看增量订单和开销明细
3. **展开明细**：点击利息总数列左侧的展开按钮，查看每期利息
4. **合并数据**：点击"合并到总表"按钮
5. **确认合并**：如果已合并过，确认后执行合并
6. **查看结果**：系统返回合并结果摘要

### 命令使用（可选）

- `/preview_incremental` - 预览增量报表摘要
- `/merge_incremental` - 手动合并增量报表（命令方式）

## 数据库表结构

### baseline_report 表

存储基准日期：

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键（固定为1） |
| baseline_date | TEXT | 基准日期 |
| created_at | TEXT | 创建时间 |
| updated_at | TEXT | 更新时间 |

### incremental_merge_records 表

存储合并记录：

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键 |
| merge_date | TEXT | 合并日期（唯一） |
| baseline_date | TEXT | 基准日期 |
| orders_count | INTEGER | 订单数 |
| total_amount | REAL | 订单金额 |
| total_interest | REAL | 利息总额 |
| total_expenses | REAL | 开销总额 |
| merged_by | INTEGER | 合并人用户ID |
| merged_at | TEXT | 合并时间 |

## 注意事项

1. **重复合并**：如果同一天的增量已合并过，系统会提示并等待确认
2. **数据一致性**：合并操作会自动更新全局统计数据，确保数据一致性
3. **增量范围**：每次合并只处理新的增量数据，避免重复累加
4. **权限要求**：合并功能仅限管理员使用
5. **利息明细**：Excel中利息总数列可以展开查看每期明细，默认隐藏

## 技术实现

### 关键文件

1. **`init_db.py`** - 数据库表结构
2. **`db_operations.py`** - 数据库操作（基准日期、合并记录、增量查询）
3. **`utils/incremental_report_generator.py`** - 增量数据准备
4. **`utils/incremental_report_merger.py`** - 合并逻辑和统计计算
5. **`utils/excel_export.py`** - Excel报表生成
6. **`utils/schedule_executor.py`** - 定时任务调度
7. **`callbacks/incremental_merge_callbacks.py`** - 合并回调处理
8. **`callbacks/main_callback.py`** - 回调路由
9. **`main.py`** - 命令注册和初始化

### 数据流程

```
每天11:05
    ↓
获取基准日期
    ↓
查询增量数据（基准日期之后）
    ↓
生成Excel报表
    ↓
发送给管理员（附带合并按钮）
    ↓
用户点击合并按钮
    ↓
检查是否已合并
    ↓（已合并）
显示确认对话框 → 等待用户确认
    ↓（未合并/已确认）
合并增量数据到全局统计
    ↓
更新全局数据（financial_data, grouped_data, daily_data）
    ↓
保存合并记录
    ↓
返回合并结果
```

## 功能特性

✅ **自动定时发送** - 每天11:05自动生成并发送报表  
✅ **Excel格式** - 专业的表格格式，易于查看和分析  
✅ **利息明细可展开** - 利息总数列可以展开查看每期明细  
✅ **一键合并** - 点击按钮即可合并到总报表  
✅ **重复检测** - 自动检测重复合并并提示确认  
✅ **自动更新全局数据** - 合并时自动更新所有统计数据  
✅ **合并记录** - 记录每次合并的详细信息  
✅ **增量范围控制** - 只合并新的增量数据，避免重复  

