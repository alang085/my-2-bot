# 应用完整功能列表

## 📋 目录

1. [基础功能](#基础功能)
2. [订单管理](#订单管理)
3. [金额操作](#金额操作)
4. [报表查询](#报表查询)
5. [搜索功能](#搜索功能)
6. [支付账户管理](#支付账户管理)
7. [定时播报](#定时播报)
8. [撤销操作](#撤销操作)
9. [管理员功能](#管理员功能)
10. [群组消息管理](#群组消息管理)
11. [数据管理](#数据管理)
12. [自动功能](#自动功能)
13. [回调功能](#回调功能)

---

## 基础功能

### 权限检查
- **命令**: `/check_permission`
- **权限**: 所有人可用
- **功能**: 检查当前用户的权限状态
- **使用场景**: 调试权限问题

### 帮助信息
- **命令**: `/start`
- **权限**: 私聊，需要授权
- **功能**: 显示完整的命令帮助信息
- **包含内容**: 
  - 员工命令列表
  - 管理员命令列表（可隐藏）

---

## 订单管理

### 创建订单
- **命令**: `/create`
- **权限**: 群组，需要授权
- **功能**: 从群组名称自动创建订单
- **特点**: 
  - 自动解析群名格式
  - 自动生成订单ID
  - 自动更新统计数据

### 查看当前订单
- **命令**: `/order`
- **权限**: 群组，需要授权
- **功能**: 显示当前群组的订单信息

### 订单状态管理
- **命令**: 
  - `/normal` - 设为正常状态
  - `/overdue` - 设为逾期状态
  - `/breach` - 设为违约状态
  - `/end` - 标记为完成
  - `/breach_end` - 违约完成
- **权限**: 群组，需要授权
- **功能**: 更改订单状态并更新相关统计数据

### 订单总表
- **命令**: `/ordertable`
- **权限**: 私聊，仅管理员
- **功能**: 生成并下载订单总表Excel文件
- **包含内容**: 
  - 所有有效订单
  - 当日利息总额
  - 当日完成订单
  - 当日违约完成订单
  - 日切数据汇总

---

## 金额操作

### 利息收入
- **命令**: `+<金额>` (例如: `+1000`)
- **权限**: 群组，需要授权
- **功能**: 记录利息收入
- **特点**: 
  - 如果有订单，自动关联到订单
  - 订单完成/违约状态下默认为补利息
  - 自动更新统计数据

### 本金减少
- **命令**: `+<金额>b` (例如: `+500b`)
- **权限**: 群组，需要授权
- **功能**: 减少订单本金
- **特点**: 
  - 自动更新订单金额
  - 自动更新统计数据
  - 记录操作历史

---

## 报表查询

### 全局报表
- **命令**: `/report`
- **权限**: 私聊，需要授权
- **功能**: 显示全局统计数据
- **包含内容**: 
  - 当前状态（有效订单数、有效订单金额）
  - 周期数据（流动资金、新/老客户、利息收入、完成订单、违约订单等）
  - 开销与余额

### 归属报表
- **命令**: `/report <归属ID>` (例如: `/report S01`)
- **权限**: 私聊，需要授权
- **功能**: 显示指定归属ID的统计数据
- **包含内容**: 
  - 归属ID的累计数据
  - 周期数据
  - 盈余计算（利息收入 + 违约完成金额 - 违约订单金额）

### 我的报表
- **命令**: `/myreport`
- **权限**: 私聊，需要授权
- **功能**: 显示用户有权限查看的归属ID报表
- **特点**: 仅显示用户被授权的归属ID数据

### 收入明细
- **功能**: 通过报表回调查看
- **包含内容**: 
  - 按日期查看收入明细
  - 按归属ID查看收入明细
  - 按订单查看收入明细

---

## 搜索功能

### 搜索订单
- **命令**: `/search <类型> <值>`
- **权限**: 私聊，需要授权
- **搜索类型**: 
  - `order_id` - 按订单ID搜索
  - `group_id` - 按归属ID搜索
  - `customer` - 按客户类型搜索 (A/B)
  - `state` - 按订单状态搜索
  - `date` - 按日期搜索
- **功能**: 显示符合条件的订单列表

---

## 支付账户管理

### 查看所有账户
- **命令**: `/accounts`
- **权限**: 私聊，需要授权
- **功能**: 显示所有支付账户的表格
- **包含内容**: 
  - 账户类型（GCash/PayMaya）
  - 账号号码
  - 余额

### 查看GCash账户
- **命令**: `/gcash`
- **权限**: 私聊，需要授权
- **功能**: 显示所有GCash账户信息
- **包含内容**: 
  - 账户列表
  - 总余额
  - 账户操作按钮（修改余额、编辑信息、批量修改）

### 查看PayMaya账户
- **命令**: `/paymaya`
- **权限**: 私聊，需要授权
- **功能**: 显示所有PayMaya账户信息
- **包含内容**: 
  - 账户列表
  - 总余额
  - 账户操作按钮（修改余额、编辑信息、批量修改）

### 余额历史
- **命令**: `/balance_history`
- **权限**: 私聊，需要授权
- **功能**: 显示GCash和PayMaya的总余额
- **显示格式**: 
  - GCash总余额
  - PayMaya总余额
  - 总计

---

## 定时播报

### 管理定时播报
- **命令**: `/schedule`
- **权限**: 私聊，需要授权
- **功能**: 管理定时播报任务
- **特点**: 
  - 最多3个定时任务
  - 支持设置播报时间
  - 支持启用/禁用任务

---

## 撤销操作

### 撤销上一个操作
- **命令**: `/undo`
- **权限**: 群组或私聊，需要授权
- **功能**: 撤销上一个操作
- **限制**: 
  - 最多连续撤销3次
  - 只能撤销当前聊天环境的操作
- **支持撤销**: 
  - 订单创建
  - 金额操作
  - 状态变更
  - 收入记录

---

## 管理员功能

### 资金管理

#### 调整资金
- **命令**: `/adjust <金额> [备注]`
- **权限**: 私聊，仅管理员
- **功能**: 调整流动资金
- **示例**: `/adjust +1000` 或 `/adjust -500 退款`

### 归属ID管理

#### 创建归属ID
- **命令**: `/create_attribution <ID>`
- **权限**: 私聊，仅管理员
- **功能**: 创建新的归属ID
- **示例**: `/create_attribution S01`

#### 列出归属ID
- **命令**: `/list_attributions`
- **权限**: 私聊，仅管理员
- **功能**: 显示所有归属ID及其统计数据

### 员工管理

#### 添加员工
- **命令**: `/add_employee <用户ID> <归属ID>`
- **权限**: 私聊，仅管理员
- **功能**: 添加员工并设置归属ID权限
- **示例**: `/add_employee 123456789 S01`

#### 移除员工
- **命令**: `/remove_employee <用户ID>`
- **权限**: 私聊，仅管理员
- **功能**: 移除员工权限

#### 列出员工
- **命令**: `/list_employees`
- **权限**: 私聊，仅管理员
- **功能**: 显示所有员工及其权限信息

### 权限管理

#### 设置用户归属ID权限
- **命令**: `/set_user_group_id <用户ID> <归属ID>`
- **权限**: 私聊，仅管理员
- **功能**: 为用户设置归属ID查看权限

#### 移除用户归属ID权限
- **命令**: `/remove_user_group_id <用户ID>`
- **权限**: 私聊，仅管理员
- **功能**: 移除用户的归属ID权限

#### 列出用户归属ID映射
- **命令**: `/list_user_group_mappings`
- **权限**: 私聊，仅管理员
- **功能**: 显示所有用户的归属ID权限映射

### 系统维护

#### 更新星期分组
- **命令**: `/update_weekday_groups`
- **权限**: 私聊，仅管理员
- **功能**: 更新订单的星期分组信息

#### 修复统计数据
- **命令**: `/fix_statistics`
- **权限**: 私聊，仅管理员
- **功能**: 修复订单统计数据不一致问题

#### 修复收入统计数据
- **命令**: `/fix_income_statistics`
- **权限**: 私聊，仅管理员
- **功能**: 修复收入统计数据不一致问题

#### 查找尾数订单
- **命令**: `/find_tail_orders`
- **权限**: 私聊，仅管理员
- **功能**: 查找导致有效金额尾数的订单

#### 检查数据不一致
- **命令**: `/check_mismatch [日期]`
- **权限**: 私聊，仅管理员
- **功能**: 检查收入明细和统计数据的不一致

#### 客户贡献分析
- **命令**: `/customer`
- **权限**: 私聊，仅管理员
- **功能**: 分析新客户(A)和老客户(B)的贡献

### 数据管理

#### 查看操作记录
- **命令**: `/daily_operations [日期]`
- **权限**: 私聊，仅管理员
- **功能**: 查看指定日期的操作记录
- **默认**: 今日操作记录

#### 查看操作汇总
- **命令**: `/daily_operations_summary [日期]`
- **权限**: 私聊，仅管理员
- **功能**: 查看指定日期的操作汇总统计

#### 还原当天数据
- **命令**: `/restore_daily_data [日期]`
- **权限**: 私聊，仅管理员
- **功能**: 还原指定日期的数据到初始状态

#### 每日数据变更表
- **命令**: `/daily_changes`
- **权限**: 私聊，仅管理员
- **功能**: 查看每日数据变更Excel表格

#### 管理员数据修正
- **命令**: `/admin_correct`
- **权限**: 私聊，仅管理员
- **功能**: 查看、修改、删除操作历史记录
- **特点**: 
  - 可以无视规则修改已完成的操作
  - 支持按日期、类型、用户筛选
  - 支持修改操作数据
  - 支持删除操作记录

#### 增量报表
- **命令**: 
  - `/preview_incremental` - 预览增量报表
  - `/merge_incremental` - 合并增量报表到全局
- **权限**: 私聊，仅管理员
- **功能**: 生成和管理增量订单报表

---

## 群组消息管理

### 群组消息配置

#### 管理群组消息
- **命令**: `/groupmsg`
- **权限**: 私聊，仅管理员
- **功能**: 管理群组的开工、收工、欢迎消息

#### 添加总群配置
- **命令**: `/groupmsg_add`
- **权限**: 私聊，仅管理员
- **功能**: 添加总群的消息配置

#### 获取群组ID
- **命令**: `/groupmsg_getid`
- **权限**: 群组中使用
- **功能**: 获取当前群组的ID

#### 一键设置群组自动消息
- **命令**: `/groupmsg_setup`
- **权限**: 群组或频道中使用
- **功能**: 一键设置群组/频道的自动消息功能

#### 批量设置消息
- **命令**: `/groupmsg_batch`
- **权限**: 私聊，仅管理员
- **功能**: 批量设置多个群组的消息

### 公司公告管理

#### 管理公司公告
- **命令**: `/announcement`
- **权限**: 私聊，仅管理员
- **功能**: 管理公司公告消息
- **特点**: 
  - 支持多版本消息（使用 ⸻ 分隔符）
  - 自动轮播不同版本
  - 支持启用/禁用

### 防诈骗消息管理

#### 管理防诈骗语录
- **命令**: `/antifraud`
- **权限**: 私聊，仅管理员
- **功能**: 管理防诈骗消息语录
- **特点**: 
  - 支持多版本消息
  - 自动轮播

### 宣传语录管理

#### 管理宣传轮播语录
- **命令**: `/promotion`
- **权限**: 私聊，仅管理员
- **功能**: 管理公司宣传轮播语录（英文界面）
- **特点**: 
  - 每2小时自动发送
  - 按顺序轮播
  - 支持启用/禁用
  - 支持添加、删除、查看全部

### 消息范本管理

#### 初始化消息范本
- **命令**: `/init_templates [force]`
- **权限**: 私聊，仅管理员
- **功能**: 初始化默认消息范本
- **参数**: 
  - `force` - 强制覆盖已有数据

#### 填充空消息范本
- **命令**: `/fill_empty_messages`
- **权限**: 私聊，仅管理员
- **功能**: 填充空的消息范本

#### 测试发送语录
- **命令**: `/test_broadcast`
- **权限**: 私聊，仅管理员
- **功能**: 测试发送所有类型的语录

---

## 自动功能

### 自动订单创建

#### 新成员入群监听
- **触发**: 新成员加入群组
- **功能**: 自动从群名创建订单
- **条件**: 
  - 群名符合订单格式
  - 用户有创建订单权限

#### 群名变更监听
- **触发**: 群组名称变更
- **功能**: 自动从新群名创建订单或更新订单
- **条件**: 
  - 新群名符合订单格式
  - 用户有创建订单权限

### 定时任务

#### 定时播报
- **功能**: 按设定的时间自动发送付款提醒
- **特点**: 
  - 最多3个定时任务
  - 支持自定义时间

#### 日切报表
- **功能**: 每天自动生成并发送日切报表
- **时间**: 配置的日切时间

#### 群组消息定时发送
- **功能**: 自动发送群组消息
- **包含**: 
  - 开工信息（每天11:00）
  - 收工信息（每天23:00）
  - 公司公告（按配置间隔）
  - 宣传语录（每2小时）
  - 防诈骗消息（按配置间隔）

---

## 回调功能

### 报表回调
- **回调前缀**: `report_`
- **功能**: 
  - 查看收入明细
  - 查看支出明细
  - 切换报表类型
  - 切换日期范围

### 搜索回调
- **回调前缀**: `search_`
- **功能**: 
  - 查看订单详情
  - 分页浏览搜索结果

### 订单回调
- **回调前缀**: `order_action_`, `order_change_to_`
- **功能**: 
  - 订单操作（查看、编辑）
  - 订单状态变更

### 支付账户回调
- **回调前缀**: `payment_`
- **功能**: 
  - 修改账户余额
  - 编辑账户信息
  - 批量修改余额
  - 查看账户详情

### 定时播报回调
- **回调前缀**: `schedule_`
- **功能**: 
  - 添加定时任务
  - 编辑定时任务
  - 删除定时任务
  - 启用/禁用任务

### 群组消息回调
- **回调前缀**: `groupmsg_`, `announcement_`, `antifraud_`, `promotion_`, `batch_set_`, `test_`
- **功能**: 
  - 管理群组消息配置
  - 管理公司公告
  - 管理防诈骗消息
  - 管理宣传语录（英文界面）
  - 批量设置消息
  - 测试发送消息

### 管理员数据修正回调
- **回调前缀**: `admin_correct_`
- **功能**: 
  - 查看操作历史
  - 筛选操作记录
  - 修改操作数据
  - 删除操作记录

---

## 功能统计

### 命令总数
- **基础命令**: 3个
- **订单命令**: 7个
- **报表命令**: 3个
- **搜索命令**: 1个
- **支付账户命令**: 4个
- **定时播报命令**: 1个
- **撤销命令**: 1个
- **管理员命令**: 30+个
- **群组消息命令**: 8个
- **总计**: 58+个命令

### 消息处理器
- **金额操作**: `+<金额>` 格式
- **文本输入**: 处理搜索、群发等输入
- **新成员入群**: 自动创建订单
- **群名变更**: 自动更新订单

### 回调处理器
- **报表回调**: 多种报表操作
- **搜索回调**: 订单搜索和查看
- **订单回调**: 订单管理操作
- **支付回调**: 账户管理操作
- **定时播报回调**: 任务管理
- **群组消息回调**: 消息管理
- **管理员修正回调**: 数据修正

---

## 权限体系

### 权限级别
1. **所有人**: 无需权限
   - `/check_permission`

2. **授权用户**: 需要授权（员工或管理员）
   - 大部分基础功能

3. **管理员**: 仅管理员
   - 系统管理功能
   - 数据修正功能
   - 高级查询功能

### 权限控制
- **私聊限制**: 部分命令只能在私聊中使用
- **群组限制**: 部分命令只能在群组中使用
- **归属ID权限**: 用户可以查看特定归属ID的数据

---

## 数据统计

### 数据库表
- `orders` - 订单表
- `financial_data` - 全局财务数据
- `grouped_data` - 归属ID统计数据
- `daily_data` - 日结数据
- `income_records` - 收入明细
- `expense_records` - 支出明细
- `operation_history` - 操作历史
- `payment_accounts` - 支付账户
- `user_permissions` - 用户权限
- `company_promotion_messages` - 宣传语录
- `company_announcements` - 公司公告
- `anti_fraud_messages` - 防诈骗消息
- `group_configs` - 群组配置
- `daily_summary` - 日切汇总

---

## 更新日志

### 最新更新
- ✅ 移除 force_delete 功能
- ✅ 群组轮播信息英文化
- ✅ 订单完成/违约状态下 +金额 默认为补利息
- ✅ 管理员数据修正功能
- ✅ 批量余额修改功能
- ✅ 简化余额历史显示

---

**文档版本**: 1.0  
**最后更新**: 2025-01-XX

