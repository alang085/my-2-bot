# ğŸ“Š è®¢å•æŠ¥è¡¨å¢é‡åŠŸèƒ½ - ä½œç”¨è¯´æ˜

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

**è®¢å•æŠ¥è¡¨å¢é‡**æ˜¯ä¸€ä¸ªæ•°æ®æ±‡æ€»å’Œåˆå¹¶åŠŸèƒ½ï¼Œç”¨äºå°†**åŸºå‡†æ—¥æœŸä¹‹å**çš„æ‰€æœ‰æ–°å¢è®¢å•ã€æ”¶å…¥è®°å½•å’Œå¼€é”€è®°å½•**åˆå¹¶åˆ°å…¨å±€ç»Ÿè®¡æ•°æ®**ä¸­ã€‚

---

## ğŸ“‹ æ•°æ®æ¥æºï¼ˆè¯»å–å“ªäº›æ•°æ®ï¼‰

å¢é‡æŠ¥è¡¨ä¼šä»ä»¥ä¸‹æ•°æ®è¡¨ä¸­è¯»å–æ•°æ®ï¼š

### 1. **orders è¡¨ï¼ˆè®¢å•è¡¨ï¼‰**
- **æ¡ä»¶**ï¼š`date >= åŸºå‡†æ—¥æœŸ` æˆ– `updated_at >= åŸºå‡†æ—¥æœŸ`
- **è·å–å†…å®¹**ï¼š
  - æ‰€æœ‰åœ¨åŸºå‡†æ—¥æœŸä¹‹ååˆ›å»ºçš„è®¢å•
  - æ‰€æœ‰åœ¨åŸºå‡†æ—¥æœŸä¹‹åæ›´æ–°çš„è®¢å•ï¼ˆçŠ¶æ€å˜æ›´ã€é‡‘é¢ä¿®æ”¹ç­‰ï¼‰

### 2. **income_records è¡¨ï¼ˆæ”¶å…¥æ˜ç»†è¡¨ï¼‰**
- **æ¡ä»¶**ï¼šå…³è”åˆ°ä¸Šè¿°è®¢å•çš„åˆ©æ¯è®°å½•å’Œæœ¬é‡‘å½’è¿˜è®°å½•
- **è·å–å†…å®¹**ï¼š
  - æ¯ä¸ªè®¢å•çš„æ‰€æœ‰åˆ©æ¯æ”¶å…¥è®°å½•ï¼ˆ`type = 'interest'`ï¼‰
  - æ¯ä¸ªè®¢å•çš„æœ¬é‡‘å½’è¿˜è®°å½•ï¼ˆ`type = 'principal_reduction'`ï¼‰
  - æ’é™¤å·²æ’¤é”€çš„è®°å½•ï¼ˆ`is_undone = 0`ï¼‰

### 3. **expense_records è¡¨ï¼ˆå¼€é”€è®°å½•è¡¨ï¼‰**
- **æ¡ä»¶**ï¼š`date >= åŸºå‡†æ—¥æœŸ` ä¸” `date <= ç»“æŸæ—¥æœŸ`
- **è·å–å†…å®¹**ï¼š
  - å…¬å¸å¼€é”€ï¼ˆ`type = 'company'`ï¼‰
  - å…¶ä»–å¼€é”€ï¼ˆ`type = 'other'`ï¼‰

---

## ğŸ¯ ä½œç”¨å¯¹è±¡ï¼ˆæ›´æ–°å“ªäº›æ•°æ®ï¼‰

å½“æ‰§è¡Œ**åˆå¹¶æ“ä½œ**æ—¶ï¼Œå¢é‡æŠ¥è¡¨ä¼šæ›´æ–°ä»¥ä¸‹æ•°æ®è¡¨ï¼š

### 1. **financial_data è¡¨ï¼ˆå…¨å±€è´¢åŠ¡æ•°æ®ï¼‰** â­ä¸»è¦ä½œç”¨å¯¹è±¡

æ›´æ–°ä»¥ä¸‹å­—æ®µï¼š
- `new_clients` - æ–°å®¢æˆ·æ•°
- `new_clients_amount` - æ–°å®¢æˆ·é‡‘é¢
- `old_clients` - è€å®¢æˆ·æ•°
- `old_clients_amount` - è€å®¢æˆ·é‡‘é¢
- `completed_orders` - å®Œæˆè®¢å•æ•°
- `completed_amount` - å®Œæˆè®¢å•é‡‘é¢
- `breach_end_orders` - è¿çº¦å®Œæˆè®¢å•æ•°
- `breach_end_amount` - è¿çº¦å®Œæˆé‡‘é¢

**æ³¨æ„**ï¼š
- `interest`ï¼ˆåˆ©æ¯æ”¶å…¥ï¼‰**ä¸ä¼š**åœ¨è¿™é‡Œæ›´æ–°ï¼Œå› ä¸ºåˆ©æ¯åœ¨è®°å½•æ—¶å·²ç»é€šè¿‡ `record_income` æ›´æ–°è¿‡äº†
- åˆå¹¶æ“ä½œä¸»è¦æ˜¯**ç¡®ä¿æ•°æ®ä¸€è‡´æ€§**ï¼Œé¿å…é—æ¼

### 2. **grouped_data è¡¨ï¼ˆåˆ†ç»„è´¢åŠ¡æ•°æ®ï¼‰**

å¦‚æœè®¢å•æœ‰å½’å±IDï¼ˆ`group_id`ï¼‰ï¼Œä¼šé€šè¿‡ `update_all_stats` å‡½æ•°åŒæ—¶æ›´æ–°å¯¹åº”å½’å±IDçš„ç»Ÿè®¡æ•°æ®ã€‚

### 3. **daily_data è¡¨ï¼ˆæ—¥ç»“æ•°æ®ï¼‰**

é€šè¿‡ `update_all_stats` å‡½æ•°é—´æ¥æ›´æ–°ï¼Œæ›´æ–°å¯¹åº”æ—¥æœŸçš„æ—¥ç»“æ•°æ®ã€‚

### 4. **incremental_merge_records è¡¨ï¼ˆåˆå¹¶è®°å½•è¡¨ï¼‰**

è®°å½•åˆå¹¶æ“ä½œçš„å†å²ï¼š
- `merge_date` - åˆå¹¶æ—¥æœŸ
- `baseline_date` - åŸºå‡†æ—¥æœŸ
- `orders_count` - åˆå¹¶çš„è®¢å•æ•°
- `total_amount` - è®¢å•æ€»é‡‘é¢
- `total_interest` - åˆ©æ¯æ€»é¢
- `total_expenses` - å¼€é”€æ€»é¢
- `merged_by` - æ‰§è¡Œåˆå¹¶çš„ç”¨æˆ·ID

---

## ğŸ”„ å·¥ä½œæµç¨‹

### æ­¥éª¤1ï¼šç”Ÿæˆå¢é‡æŠ¥è¡¨ï¼ˆæ¯å¤©23:05è‡ªåŠ¨æ‰§è¡Œï¼‰

1. è·å–åŸºå‡†æ—¥æœŸï¼ˆ`baseline_date`ï¼‰
2. æŸ¥è¯¢åŸºå‡†æ—¥æœŸä¹‹åçš„æ‰€æœ‰è®¢å•å’Œå¼€é”€
3. ç”ŸæˆExcelæŠ¥è¡¨æ–‡ä»¶
4. å‘é€ç»™æ‰€æœ‰ç®¡ç†å‘˜å’Œæˆæƒå‘˜å·¥

### æ­¥éª¤2ï¼šé¢„è§ˆå¢é‡æŠ¥è¡¨ï¼ˆå¯é€‰ï¼‰

ä½¿ç”¨å‘½ä»¤ `/preview_incremental` å¯ä»¥é¢„è§ˆå¢é‡æ•°æ®ï¼Œä¸æ‰§è¡Œåˆå¹¶ã€‚

### æ­¥éª¤3ï¼šåˆå¹¶åˆ°å…¨å±€æ•°æ®ï¼ˆç®¡ç†å‘˜æ“ä½œï¼‰

1. ç‚¹å‡»æŠ¥è¡¨ä¸­çš„"âœ… åˆå¹¶åˆ°æ€»è¡¨"æŒ‰é’®
2. ç³»ç»Ÿè®¡ç®—å¢é‡ç»Ÿè®¡æ•°æ®
3. æ›´æ–° `financial_data` è¡¨çš„å…¨å±€ç»Ÿè®¡æ•°æ®
4. æ›´æ–° `grouped_data` è¡¨çš„åˆ†ç»„ç»Ÿè®¡æ•°æ®ï¼ˆå¦‚æœæœ‰å½’å±IDï¼‰
5. æ›´æ–° `daily_data` è¡¨çš„æ—¥ç»“æ•°æ®
6. è®°å½•åˆå¹¶æ“ä½œåˆ° `incremental_merge_records` è¡¨

---

## ğŸ“Š ç»Ÿè®¡å†…å®¹

å¢é‡æŠ¥è¡¨ä¼šç»Ÿè®¡ä»¥ä¸‹å†…å®¹ï¼š

### è®¢å•ç»Ÿè®¡
- æ–°å¢è®¢å•æ•°
- æ–°å¢è®¢å•é‡‘é¢
- æ–°å®¢æˆ·æ•°/é‡‘é¢
- è€å®¢æˆ·æ•°/é‡‘é¢

### æ”¶å…¥ç»Ÿè®¡
- åˆ©æ¯æ”¶å…¥æ€»é¢
- å½’è¿˜æœ¬é‡‘æ€»é¢
- å®Œæˆè®¢å•æ•°/é‡‘é¢
- è¿çº¦å®Œæˆè®¢å•æ•°/é‡‘é¢

### å¼€é”€ç»Ÿè®¡
- å…¬å¸å¼€é”€æ€»é¢
- å…¶ä»–å¼€é”€æ€»é¢

---

## âš ï¸ é‡è¦è¯´æ˜

### 1. åŸºå‡†æ—¥æœŸçš„ä½œç”¨

- **åŸºå‡†æ—¥æœŸ**æ˜¯å¢é‡æŠ¥è¡¨çš„èµ·å§‹ç‚¹
- åªæœ‰**åŸºå‡†æ—¥æœŸä¹‹å**çš„æ•°æ®æ‰ä¼šè¢«åŒ…å«åœ¨å¢é‡æŠ¥è¡¨ä¸­
- åŸºå‡†æ—¥æœŸå­˜å‚¨åœ¨ `baseline_report` è¡¨ä¸­
- é¦–æ¬¡ä½¿ç”¨æ—¶ï¼ŒåŸºå‡†æ—¥æœŸä¼šè‡ªåŠ¨è®¾ç½®ä¸ºå½“å‰æ—¥æœŸ

### 2. æ•°æ®ä¸€è‡´æ€§

- å¢é‡æŠ¥è¡¨çš„åˆå¹¶æ“ä½œä¸»è¦æ˜¯**ç¡®ä¿æ•°æ®ä¸€è‡´æ€§**
- å¤§éƒ¨åˆ†æ•°æ®åœ¨ä¸šåŠ¡æ“ä½œæ—¶å·²ç»æ›´æ–°è¿‡äº†ï¼ˆå¦‚è®°å½•åˆ©æ¯æ—¶å·²æ›´æ–°ç»Ÿè®¡ï¼‰
- åˆå¹¶æ“ä½œå¯ä»¥**è¡¥å…¨é—æ¼çš„æ•°æ®**æˆ–**ä¿®å¤æ•°æ®ä¸ä¸€è‡´**çš„æƒ…å†µ

### 3. é‡å¤åˆå¹¶

- å¯ä»¥é‡å¤åˆå¹¶åŒä¸€å¤©çš„å¢é‡æŠ¥è¡¨
- ç³»ç»Ÿä¼šè®°å½•åˆå¹¶å†å²ï¼Œä½†ä¸ä¼šé˜»æ­¢é‡å¤åˆå¹¶
- é‡å¤åˆå¹¶æ—¶ï¼Œæ•°æ®ä¼š**ç´¯åŠ **ï¼ˆå› ä¸º `update_financial_data` æ˜¯ç´¯åŠ æ“ä½œï¼‰

### 4. åˆ©æ¯æ”¶å…¥

- **åˆ©æ¯æ”¶å…¥**åœ¨è®°å½•æ—¶å·²ç»é€šè¿‡ `record_income` æ›´æ–°åˆ°ç»Ÿè®¡è¡¨ä¸­
- åˆå¹¶æ“ä½œæ—¶**ä¸ä¼šé‡å¤æ›´æ–°**åˆ©æ¯æ”¶å…¥
- å¢é‡æŠ¥è¡¨ä¸­çš„åˆ©æ¯æ•°æ®ä¸»è¦ç”¨äº**å±•ç¤ºå’Œæ ¸å¯¹**

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šæ¯æ—¥è‡ªåŠ¨æŠ¥è¡¨ï¼ˆ23:05ï¼‰

ç³»ç»Ÿæ¯å¤©23:05è‡ªåŠ¨ç”Ÿæˆå¢é‡æŠ¥è¡¨ï¼Œå‘é€ç»™ç®¡ç†å‘˜å’Œä¸šåŠ¡å‘˜ï¼Œç”¨äºï¼š
- æŸ¥çœ‹å½“å¤©çš„ä¸šåŠ¡æ•°æ®
- æ ¸å¯¹è®¢å•å’Œæ”¶å…¥æƒ…å†µ
- å‡†å¤‡åˆå¹¶åˆ°æ€»è¡¨

### åœºæ™¯2ï¼šæ•°æ®ä¿®å¤

å¦‚æœå‘ç°ç»Ÿè®¡æ•°æ®ä¸ä¸€è‡´ï¼Œå¯ä»¥ï¼š
1. é¢„è§ˆå¢é‡æŠ¥è¡¨ï¼ŒæŸ¥çœ‹æ•°æ®
2. æ‰§è¡Œåˆå¹¶æ“ä½œï¼Œä¿®å¤ç»Ÿè®¡æ•°æ®

### åœºæ™¯3ï¼šå®šæœŸæ±‡æ€»

å®šæœŸï¼ˆå¦‚æ¯å‘¨æˆ–æ¯æœˆï¼‰æ‰§è¡Œåˆå¹¶æ“ä½œï¼Œå°†å¢é‡æ•°æ®æ±‡æ€»åˆ°å…¨å±€ç»Ÿè®¡ä¸­ã€‚

---

## ğŸ“ ç›¸å…³å‘½ä»¤

### å‘˜å·¥æƒé™
- `/preview_incremental` - é¢„è§ˆå¢é‡æŠ¥è¡¨ï¼ˆä¸åˆå¹¶ï¼‰

### ç®¡ç†å‘˜æƒé™
- `/preview_incremental` - é¢„è§ˆå¢é‡æŠ¥è¡¨
- `/merge_incremental` - åˆå¹¶å¢é‡æŠ¥è¡¨åˆ°å…¨å±€æ•°æ®
- ç‚¹å‡»æŠ¥è¡¨ä¸­çš„"âœ… åˆå¹¶åˆ°æ€»è¡¨"æŒ‰é’®

---

## ğŸ” æ•°æ®è¡¨å…³ç³»å›¾

```
åŸºå‡†æ—¥æœŸ (baseline_report)
    â†“
    â”œâ”€â†’ orders è¡¨ï¼ˆæŸ¥è¯¢å¢é‡è®¢å•ï¼‰
    â”‚       â†“
    â”‚       â””â”€â†’ income_records è¡¨ï¼ˆæŸ¥è¯¢è®¢å•çš„åˆ©æ¯å’Œæœ¬é‡‘å½’è¿˜ï¼‰
    â”‚
    â””â”€â†’ expense_records è¡¨ï¼ˆæŸ¥è¯¢å¢é‡å¼€é”€ï¼‰
            â†“
åˆå¹¶æ“ä½œ â†’ financial_data è¡¨ï¼ˆæ›´æ–°å…¨å±€ç»Ÿè®¡ï¼‰
         â†’ grouped_data è¡¨ï¼ˆæ›´æ–°åˆ†ç»„ç»Ÿè®¡ï¼‰
         â†’ daily_data è¡¨ï¼ˆæ›´æ–°æ—¥ç»“æ•°æ®ï¼‰
         â†’ incremental_merge_records è¡¨ï¼ˆè®°å½•åˆå¹¶å†å²ï¼‰
```

---

## ğŸ’¡ æ€»ç»“

**è®¢å•æŠ¥è¡¨å¢é‡åŠŸèƒ½çš„ä½œç”¨**ï¼š

1. **æ•°æ®æ¥æº**ï¼šä» `orders`ã€`income_records`ã€`expense_records` è¡¨ä¸­è¯»å–åŸºå‡†æ—¥æœŸä¹‹åçš„æ•°æ®
2. **ä¸»è¦ä½œç”¨å¯¹è±¡**ï¼šæ›´æ–° `financial_data` è¡¨çš„å…¨å±€è´¢åŠ¡ç»Ÿè®¡æ•°æ®
3. **æ¬¡è¦ä½œç”¨å¯¹è±¡**ï¼šæ›´æ–° `grouped_data` å’Œ `daily_data` è¡¨çš„ç›¸å…³ç»Ÿè®¡æ•°æ®
4. **ç›®çš„**ï¼šç¡®ä¿ç»Ÿè®¡æ•°æ®çš„ä¸€è‡´æ€§ï¼Œè¡¥å…¨é—æ¼çš„æ•°æ®

**å…³é”®ç‚¹**ï¼š
- âœ… ä¸»è¦ç”¨äº**æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥**å’Œ**æ•°æ®ä¿®å¤**
- âœ… å¤§éƒ¨åˆ†æ•°æ®åœ¨ä¸šåŠ¡æ“ä½œæ—¶å·²ç»æ›´æ–°è¿‡äº†
- âœ… åˆå¹¶æ“ä½œå¯ä»¥**è¡¥å…¨é—æ¼**æˆ–**ä¿®å¤ä¸ä¸€è‡´**
- âœ… å¯ä»¥é‡å¤åˆå¹¶ï¼Œæ•°æ®ä¼šç´¯åŠ 


