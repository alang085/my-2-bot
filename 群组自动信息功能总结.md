# 群组自动信息功能总结

## 功能概述

系统实现了总群/总频道的自动消息发送功能，包括定时发送和触发式发送两种模式。

## 核心功能

### 1. 开工信息 📅

**功能说明：**
- 每天 **11:00** 自动发送开工信息到所有配置的总群
- 支持为每个群组设置独立的开工信息内容

**配置方式：**
- 通过 `/groupmsg` 管理界面设置
- 或通过回调按钮设置消息内容

**执行逻辑：**
- 定时任务：每天11:00（北京时间）自动执行
- 发送对象：所有已配置且激活的总群
- 发送内容：每个群组配置的 `start_work_message`

### 2. 收工信息 🌙

**功能说明：**
- 每天 **23:00** 自动发送收工信息到所有配置的总群
- 支持为每个群组设置独立的收工信息内容

**配置方式：**
- 通过 `/groupmsg` 管理界面设置
- 或通过回调按钮设置消息内容

**执行逻辑：**
- 定时任务：每天23:00（北京时间）自动执行
- 发送对象：所有已配置且激活的总群
- 发送内容：每个群组配置的 `end_work_message`

### 3. 公司公告 📢

**功能说明：**
- 按配置的间隔时间（默认 **3小时**）随机发送公司公告
- 从激活的公告列表中随机选择一条发送
- 支持设置发送间隔和启用/禁用

**配置方式：**
- 通过 `/announcement` 管理界面
- 可以添加多条公告
- 可以激活/禁用单条公告
- 可以设置发送间隔（小时）

**执行逻辑：**
- 定时检查：系统会定期检查是否到达发送时间
- 发送间隔：默认3小时，可配置
- 随机选择：从所有激活的公告中随机选择一条
- 发送对象：所有已配置且激活的总群
- 时间控制：距离上次发送不足间隔时间时跳过

### 4. 欢迎信息 👋

**功能说明：**
- 新成员加入配置的总群时自动发送欢迎信息
- 支持变量替换：`{username}` 和 `{chat_title}`
- 个性化欢迎每个新成员

**配置方式：**
- 通过 `/groupmsg` 管理界面设置
- 或通过回调按钮设置消息内容

**执行逻辑：**
- 触发时机：检测到新成员加入群组时
- 发送对象：每个新加入的成员
- 变量替换：
  - `{username}` → 新成员的用户名或姓名
  - `{chat_title}` → 群组名称
- 个性化：为每个新成员单独发送，内容包含其用户名

## 数据库表结构

### 1. group_message_config - 群组消息配置表

**用途：** 存储总群/总频道的消息配置

**字段：**
- `id` - 主键（自增）
- `chat_id` - 群组/频道ID（唯一，非空）
- `chat_title` - 群组/频道名称（可为NULL）
- `start_work_message` - 开工信息（可为NULL）
- `end_work_message` - 收工信息（可为NULL）
- `welcome_message` - 欢迎信息（可为NULL，支持变量）
- `is_active` - 是否激活（默认1）
- `created_at` - 创建时间
- `updated_at` - 更新时间

**约束：** `UNIQUE(chat_id)` - 每个群组只能有一条配置

### 2. company_announcements - 公司公告表

**用途：** 存储公司公告列表，用于随机发送

**字段：**
- `id` - 主键（自增）
- `message` - 公告内容（非空）
- `is_active` - 是否激活（默认1）
- `created_at` - 创建时间
- `updated_at` - 更新时间

### 3. announcement_schedule - 公告发送计划表

**用途：** 存储公告发送的配置信息

**字段：**
- `id` - 主键（固定为1）
- `interval_hours` - 发送间隔（小时，默认3）
- `is_active` - 是否激活（默认1）
- `last_sent_at` - 最后发送时间（可为NULL）
- `created_at` - 创建时间
- `updated_at` - 更新时间

**约束：** `CHECK(id = 1)` - 只有一条记录

## 管理命令

### 群组消息管理

#### `/groupmsg` - 管理群组消息配置

**权限：** 仅管理员，私聊

**功能：**
- 查看所有已配置的总群
- 显示每个群组的状态和消息配置情况
- 提供管理按钮：
  - ➕ 添加总群
  - 📝 设置消息
  - 🔄 刷新

**显示信息：**
- 群组名称和ID
- 启用/禁用状态
- 开工信息、收工信息、欢迎信息的设置状态

#### `/groupmsg_add <chat_id>` - 添加总群配置

**权限：** 仅管理员，私聊

**功能：**
- 添加新的总群配置
- 自动获取群组名称
- 默认激活状态

**使用示例：**
```
/groupmsg_add -1001234567890
```

#### `/groupmsg_getid` - 获取群组ID

**权限：** 群组中使用

**功能：**
- 在群组中使用，获取当前群组的ID
- 显示群组名称和ID
- 提供复制ID的提示

**使用场景：**
- 需要添加总群配置时，先获取群组ID
- 然后在私聊中使用 `/groupmsg_add <chat_id>` 添加

### 公司公告管理

#### `/announcement` - 管理公司公告

**权限：** 仅管理员，私聊

**功能：**
- 查看所有公告列表
- 显示公告状态（激活/禁用）
- 显示发送间隔和状态
- 提供管理按钮：
  - ➕ 添加公告
  - 📋 查看全部
  - ⚙️ 设置间隔
  - 🔄 刷新

**显示信息：**
- 发送间隔（小时）
- 启用/禁用状态
- 公告列表（前10条）
- 激活公告数量

## 回调按钮功能

### 群组消息管理回调

- `groupmsg_add` - 添加总群
- `groupmsg_set_message` - 设置消息内容
- `groupmsg_refresh` - 刷新列表
- `groupmsg_toggle_<chat_id>` - 启用/禁用群组
- `groupmsg_set_start_<chat_id>` - 设置开工信息
- `groupmsg_set_end_<chat_id>` - 设置收工信息
- `groupmsg_set_welcome_<chat_id>` - 设置欢迎信息

### 公告管理回调

- `announcement_add` - 添加公告
- `announcement_list` - 查看全部公告
- `announcement_set_interval` - 设置发送间隔
- `announcement_refresh` - 刷新列表
- `announcement_toggle_<id>` - 激活/禁用公告
- `announcement_delete_<id>` - 删除公告

## 定时任务配置

### 开工信息任务

- **执行时间：** 每天 11:00（北京时间）
- **任务ID：** `start_work_messages`
- **触发器：** CronTrigger(hour=11, minute=0)
- **执行函数：** `send_start_work_messages()`

### 收工信息任务

- **执行时间：** 每天 23:00（北京时间）
- **任务ID：** `end_work_messages`
- **触发器：** CronTrigger(hour=23, minute=0)
- **执行函数：** `send_end_work_messages()`

### 公告发送任务

- **执行时间：** 按配置间隔（默认3小时）
- **任务ID：** `random_announcements`
- **触发器：** IntervalTrigger（动态配置）
- **执行函数：** `send_random_announcements()`
- **检查逻辑：** 检查距离上次发送时间是否达到间隔

## 工作流程

### 开工/收工信息流程

```
定时任务触发（11:00/23:00）
    ↓
获取所有配置的总群
    ↓
遍历每个群组
    ↓
检查群组是否激活
    ↓
检查是否有对应消息内容
    ↓
发送消息到群组
    ↓
记录发送结果（成功/失败）
```

### 公司公告流程

```
定时检查任务
    ↓
检查公告功能是否激活
    ↓
检查距离上次发送时间
    ↓（未达到间隔）
跳过发送
    ↓（达到间隔）
获取激活的公告列表
    ↓
随机选择一条公告
    ↓
获取所有配置的总群
    ↓
发送到所有群组
    ↓
更新最后发送时间
```

### 欢迎信息流程

```
检测到新成员加入
    ↓
检查群组是否配置了欢迎信息
    ↓
检查群组是否激活
    ↓
为每个新成员发送欢迎信息
    ↓
替换变量（{username}, {chat_title}）
    ↓
发送个性化消息
```

## 使用示例

### 1. 配置总群

```
1. 在目标群组中使用：/groupmsg_getid
2. 复制显示的群组ID
3. 在私聊中使用：/groupmsg_add -1001234567890
4. 使用 /groupmsg 查看配置
```

### 2. 设置开工信息

```
1. 使用 /groupmsg 打开管理界面
2. 点击"设置消息"按钮
3. 选择要设置的群组
4. 选择"设置开工信息"
5. 输入消息内容
```

### 3. 添加公司公告

```
1. 使用 /announcement 打开管理界面
2. 点击"添加公告"按钮
3. 输入公告内容
4. 公告默认激活
```

### 4. 设置公告发送间隔

```
1. 使用 /announcement 打开管理界面
2. 点击"设置间隔"按钮
3. 输入间隔小时数（如：3）
4. 系统会按新间隔发送
```

## 变量支持

### 欢迎信息变量

- `{username}` - 新成员的用户名或姓名
- `{chat_title}` - 群组名称

**示例：**
```
欢迎信息内容：
欢迎 {username} 加入 {chat_title}！

实际发送：
欢迎 张三 加入 总群！
```

## 注意事项

1. **权限要求**
   - 所有管理命令仅限管理员使用
   - 必须在私聊中使用管理命令

2. **群组ID格式**
   - 群组ID通常是负数（如：-1001234567890）
   - 频道ID也是负数
   - 使用 `/groupmsg_getid` 获取准确的ID

3. **消息内容**
   - 开工/收工信息可以为空（不发送）
   - 欢迎信息支持变量替换
   - 公告内容支持多行文本

4. **定时任务**
   - 使用北京时间（Asia/Shanghai时区）
   - 任务在机器人启动时自动初始化
   - 如果机器人重启，任务会重新设置

5. **错误处理**
   - 发送失败会记录日志，不影响其他群组
   - 如果群组不存在或无权限，会跳过该群组
   - 所有错误都会记录到日志中

## 相关文件

### 处理器文件
- `handlers/group_message_handlers.py` - 群组消息管理处理器
- `handlers/message_handlers.py` - 消息处理器（欢迎信息）

### 回调文件
- `callbacks/group_message_callbacks.py` - 群组消息回调处理

### 定时任务文件
- `utils/schedule_executor.py` - 定时任务执行器

### 数据库操作
- `db_operations.py` - 数据库操作函数

### 数据库表
- `init_db.py` - 数据库表结构定义

## 功能特性总结

✅ **定时发送** - 开工/收工信息按固定时间自动发送  
✅ **随机公告** - 公司公告按间隔随机发送  
✅ **个性化欢迎** - 新成员加入时自动发送个性化欢迎信息  
✅ **灵活配置** - 支持为每个群组设置独立的消息内容  
✅ **变量支持** - 欢迎信息支持用户名和群组名变量  
✅ **状态管理** - 支持启用/禁用单个群组或公告  
✅ **间隔控制** - 公告发送间隔可配置  
✅ **错误处理** - 完善的错误处理和日志记录  

