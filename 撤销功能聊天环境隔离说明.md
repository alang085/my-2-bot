# 撤销功能聊天环境隔离说明

## 📋 功能说明

`/undo` 命令现在支持按聊天环境隔离，即：
- **在私聊界面执行 `/undo`**：只能撤回私聊界面上一个执行的动作
- **在群聊界面执行 `/undo`**：只能撤回该群聊上上一个执行的动作

## 🔧 实现原理

### 1. 操作历史记录

所有操作在记录到 `operation_history` 表时，都会记录：
- `user_id`: 执行操作的用户ID
- `chat_id`: **操作发生的聊天环境ID**（私聊或群聊）
- `operation_type`: 操作类型
- `operation_data`: 操作数据（JSON格式）

### 2. 撤销查询逻辑

当执行 `/undo` 命令时：
1. 获取当前聊天环境的 `chat_id`（`update.effective_chat.id`）
2. 查询该用户在**当前聊天环境**中的最后一个未撤销操作
3. 如果找到，执行撤销操作

### 3. SQL 查询

```sql
SELECT * FROM operation_history 
WHERE user_id = ? AND chat_id = ? AND is_undone = 0
ORDER BY created_at DESC, id DESC
LIMIT 1
```

## 📝 代码变更

### 修改的文件

1. **`handlers/undo_handlers.py`**
   - 改进错误提示，明确说明是"当前聊天环境"
   - 使用 `update.effective_chat.id` 获取当前聊天环境ID

2. **`handlers/amount_handlers.py`**
   - 统一使用 `update.effective_chat.id` 获取当前聊天环境ID
   - 明确注释说明 `chat_id` 的用途

3. **`handlers/message_handlers.py`**
   - 统一使用 `update.effective_chat.id` 获取当前聊天环境ID

### 关键代码片段

#### 记录操作（示例：本金减少）

```python
# 记录操作历史（用于撤销）- 使用当前聊天环境的 chat_id
current_chat_id = update.effective_chat.id if update.effective_chat else (order.get('chat_id') if order else None)
if current_chat_id and user_id:
    await db_operations.record_operation(
        user_id=user_id,
        operation_type='principal_reduction',
        operation_data={
            'amount': amount,
            'old_amount': order['amount'],
            'new_amount': new_amount,
            'group_id': group_id,
            'chat_id': order['chat_id'],  # 订单的 chat_id（用于撤销时恢复订单）
            'order_id': order['order_id'],
            'date': get_daily_period_date()
        },
        chat_id=current_chat_id  # 当前操作发生的聊天环境
    )
```

#### 撤销操作

```python
# 获取当前聊天环境的 chat_id
chat_id = update.effective_chat.id if update.effective_chat else None
if not chat_id:
    await update.message.reply_text("❌ 无法获取聊天环境信息")
    return

# 获取当前聊天环境中的最后一个操作
last_operation = await db_operations.get_last_operation(user_id, chat_id)
if not last_operation:
    # 判断是私聊还是群聊
    is_private = chat_id > 0
    chat_type = "私聊" if is_private else "群聊"
    await update.message.reply_text(
        f"❌ 在当前{chat_type}环境中没有可撤销的操作\n\n"
        f"提示：/undo 命令只能撤销在当前聊天环境（私聊或群聊）中执行的上一个操作。"
    )
    return
```

## ✅ 功能验证

### 场景1: 私聊环境

1. 用户在私聊中记录开销：`100 测试开销`
2. 用户在私聊中执行：`/undo`
3. **结果**：撤销私聊中记录的开销操作 ✅

### 场景2: 群聊环境

1. 用户在群聊A中完成订单：`/set_end`
2. 用户在群聊A中执行：`/undo`
3. **结果**：撤销群聊A中完成的订单 ✅

### 场景3: 跨聊天环境隔离

1. 用户在私聊中记录开销：`100 测试开销`
2. 用户在群聊A中完成订单：`/set_end`
3. 用户在群聊A中执行：`/undo`
4. **结果**：只撤销群聊A中完成的订单，不会撤销私聊中的开销操作 ✅

## 🎯 支持的操作类型

所有以下操作类型都支持按聊天环境隔离撤销：

1. ✅ **利息收入** (`interest`)
2. ✅ **本金减少** (`principal_reduction`)
3. ✅ **开销记录** (`expense`)
4. ✅ **订单创建** (`order_created`)
5. ✅ **订单状态变更** (`order_state_change`)
6. ✅ **订单完成** (`order_completed`)
7. ✅ **违约完成** (`order_breach_end`)

## 📌 注意事项

1. **聊天环境隔离**：撤销操作严格按照聊天环境隔离，不会跨聊天环境撤销
2. **用户隔离**：撤销操作按用户ID隔离，不同用户的操作互不影响
3. **连续撤销限制**：每个用户最多连续撤销3次，达到限制后需要重新执行操作才能继续撤销
4. **管理员通知**：每次撤销操作都会向管理员发送通知

## 🔍 数据库结构

`operation_history` 表结构：
- `id`: 操作ID（主键）
- `user_id`: 用户ID
- `chat_id`: **聊天环境ID**（私聊或群聊）
- `operation_type`: 操作类型
- `operation_data`: 操作数据（JSON）
- `created_at`: 创建时间
- `is_undone`: 是否已撤销（0=未撤销，1=已撤销）

## 📊 索引

为了优化查询性能，`operation_history` 表有索引：
```sql
CREATE INDEX IF NOT EXISTS idx_operation_chat_user 
ON operation_history(chat_id, user_id, created_at DESC)
```

---

**更新日期**: 2025-12-02  
**状态**: ✅ 已完成并测试

