# 数据迁移指南：从旧容器迁移到新部署

本文档详细说明如何从旧容器的Volume下载数据库文件，并上传到新部署的Volume。

## 📋 前置条件

- 旧容器在Zeabur上运行，Volume已挂载
- 新部署项目已在Zeabur创建（或准备创建）
- 访问Zeabur Dashboard的权限

## 🔽 步骤1：从旧容器下载数据库文件

⚠️ **重要提示**：SQLite数据库在运行时会持续写入数据。直接从正在运行的容器下载数据库文件可能导致数据不一致或文件损坏。

### ⭐ 推荐方法：停止容器后备份（最安全）

**最佳实践**：在备份前停止容器，确保数据库处于一致状态。

1. **停止旧容器**
   - 在Zeabur Dashboard中找到旧容器项目
   - 点击 "Stop" 或 "暂停" 按钮停止容器
   - 等待容器完全停止（通常几秒钟）

2. **下载数据库文件**
   - 登录 [Zeabur Dashboard](https://dash.zeabur.com)
   - 进入项目设置
   - 找到 "Storage" 或 "Volumes" 标签页
   - 找到挂载到 `/data` 的Volume
   - 点击下载或导出，找到 `loan_bot.db` 文件并下载

3. **验证备份文件**
   - 检查文件大小（应该不为0字节）
   - 文件大小应该符合预期（通常几MB到几十MB）
   - 保存到安全位置

4. **重新启动容器**（如果需要继续使用旧容器）
   - 下载完成后，可以重新启动旧容器
   - 确保新部署验证成功后再永久停止

### 方法一：容器运行时下载（不推荐，有风险）

⚠️ **警告**：此方法可能在数据库写入时导致备份不完整。

如果必须在容器运行时下载：

1. **访问Zeabur Dashboard**
   - 登录 [Zeabur Dashboard](https://dash.zeabur.com)
   - 找到旧容器所在的项目

2. **访问Volume设置**
   - 进入项目设置
   - 找到 "Storage" 或 "Volumes" 标签页
   - 找到挂载到 `/data` 的Volume

3. **下载Volume内容**
   - 点击Volume的下载/导出按钮
   - 找到 `loan_bot.db` 文件并下载
   - ⚠️ 下载后需要验证数据完整性

4. **风险说明**
   - 如果下载时数据库正在写入，文件可能不完整
   - 建议在低峰期（使用较少时）操作
   - 备份后在新部署中验证数据完整性

### 方法二：通过容器终端下载

如果Zeabur支持SSH/终端访问：

```bash
# 1. 在Zeabur Dashboard中找到容器的终端/SSH选项
# 2. 连接到容器后，执行：

# 检查数据库文件位置
ls -lh /data/loan_bot.db

# 如果文件存在，可以：
# - 使用Zeabur的文件浏览器下载
# - 或者使用cat命令查看文件内容（不推荐，文件可能很大）
```

### 方法三：使用机器人备份命令（如果已实现）

如果旧版本机器人支持 `/backup` 命令：

1. 在Telegram中向机器人发送 `/backup` 命令
2. 机器人会发送SQL备份文件
3. 保存备份文件（注意：这是SQL格式，不是.db文件）

**注意**：如果使用SQL备份文件，需要在部署时通过 `database_backup.sql` 文件导入，而不是直接上传。

## 📤 步骤2：准备新部署

### 2.1 创建新项目并部署代码

1. **创建Git仓库**（如果还没有）
   ```bash
   git init
   git add .
   git commit -m "Initial commit"
   git remote add origin <你的仓库地址>
   git push -u origin main
   ```

2. **在Zeabur创建新项目**
   - 访问Zeabur Dashboard
   - 点击 "New Project"
   - 选择 "Import from Git"
   - 连接你的Git仓库
   - 选择仓库和分支

### 2.2 配置新部署

1. **添加Volume**
   - 在项目设置中找到 "Storage" 或 "Volumes"
   - 点击 "Add Volume"
   - 设置：
     - **Mount Path**: `/data`
     - **Size**: 至少1GB（根据数据大小调整）

2. **配置环境变量**
   ```
   BOT_TOKEN=你的机器人Token
   ADMIN_USER_IDS=你的用户ID
   DATA_DIR=/data
   ```

3. **暂不启动容器**
   - 在部署之前，我们需要先上传数据库文件
   - 可以先不点击 "Deploy"，或者先部署后再上传文件

## ⬆️ 步骤3：上传数据库文件到新部署的Volume

### 方法一：通过Zeabur Dashboard上传

1. **访问新项目的Volume设置**
   - 在Zeabur Dashboard中找到新项目
   - 进入 "Storage" 或 "Volumes" 标签页
   - 找到挂载到 `/data` 的Volume

2. **上传文件**
   - 如果Zeabur支持文件上传，点击上传按钮
   - 选择下载的 `loan_bot.db` 文件
   - 确保文件上传到 `/data/loan_bot.db` 路径

### 方法二：通过容器终端上传

1. **启动新容器**（即使没有数据库也能启动，会创建空数据库）

2. **通过SSH/终端访问容器**
   - 在Zeabur Dashboard中找到容器的终端选项
   - 连接到容器

3. **上传文件到容器**
   ```bash
   # 方法A：如果Zeabur支持文件上传到Volume
   # 直接在Dashboard中上传到Volume
   
   # 方法B：使用docker cp（如果有本地访问权限）
   # docker cp loan_bot.db <container_id>:/data/loan_bot.db
   ```

4. **验证文件存在**
   ```bash
   ls -lh /data/loan_bot.db
   # 应该能看到文件大小和权限信息
   ```

### 方法三：使用SQL备份文件（备选方案）

如果下载的是SQL备份文件（`database_backup.sql`），而不是`.db`文件：

1. **上传SQL文件到Volume**（推荐）
   - 将 `database_backup.sql` 文件上传到Volume的 `/data` 目录
   - 代码会优先检查Volume目录中的备份文件
   - 如果数据库为空，会自动导入备份数据

2. **或者放到项目根目录**（不推荐，因为会被.gitignore排除）
   - 将 `database_backup.sql` 文件放到项目根目录
   - **注意**：确保文件在 `.gitignore` 中，不要提交到Git

3. **容器启动时会自动导入**
   - 代码会在启动时按以下顺序检查备份文件：
     1. Volume目录 (`/data/database_backup.sql`)
     2. 项目根目录 (`/app/database_backup.sql`)
   - 如果数据库不存在或为空，会自动导入备份数据
   - 导入成功后备份文件会被保留（不会自动删除）

## ✅ 步骤4：验证迁移

### 4.1 检查数据库文件

通过容器终端检查：

```bash
# 进入容器终端
ls -lh /data/
# 应该看到 loan_bot.db 文件

# 检查文件大小（应该和原始文件相同）
du -h /data/loan_bot.db
```

### 4.2 启动并测试

1. **启动新容器**（如果还没启动）

2. **查看日志**
   - 在Zeabur Dashboard中查看容器日志
   - 应该看到：
     - "数据库初始化完成！" 或类似消息
     - 没有数据库相关的错误

3. **在Telegram中测试**
   - 发送 `/start` 命令
   - 检查是否能正常响应
   - 测试查询报表功能，验证数据是否正确

### 4.3 验证数据完整性

1. **测试基本功能**
   - `/report` - 查看报表（应该显示原有数据）
   - `/list_attributions` - 查看归属ID列表
   - `/list_employees` - 查看员工列表

2. **检查关键数据**
   - 流动资金余额是否正确
   - 订单数据是否完整
   - 统计数据是否一致

## 🔄 步骤5：切换流量（如果使用不同的Bot Token）

如果你的新旧部署使用不同的Bot Token：

1. **停止旧容器**
   - 在Zeabur Dashboard中停止旧项目的容器

2. **验证新容器运行正常**

3. **更新Telegram Bot配置**（如需要）
   - 在Telegram中测试新机器人是否正常工作

## ⚠️ 注意事项

### 数据安全

- **备份重要性**：在上传前确保已下载并保存数据库文件的备份
- **版本兼容性**：确保新版本代码与旧数据库Schema兼容（代码已实现自动迁移）

### Volume配置

- **路径一致性**：确保新旧部署使用相同的Volume挂载路径（`/data`）
- **文件权限**：确保数据库文件有正确的读写权限
- **文件位置**：确保文件路径为 `/data/loan_bot.db`

### 迁移时机

- **建议在低峰期进行**：避免影响正在运行的服务
- **提前测试**：如果可能，先在测试环境验证迁移流程
- **保持旧容器运行**：直到确认新部署完全正常后再停止旧容器

## 🔧 故障排查

### 问题1：无法下载Volume文件

**解决方案**：
- 检查是否有访问权限
- 尝试通过容器终端访问
- 联系Zeabur支持

### 问题2：上传后文件不存在

**解决方案**：
- 检查Volume挂载路径是否正确
- 确认文件上传到正确的路径
- 检查容器日志是否有错误信息

### 问题3：启动后数据丢失

**解决方案**：
- 检查 `DATA_DIR` 环境变量是否正确设置为 `/data`
- 验证Volume是否正确挂载
- 查看日志确认数据库初始化过程

### 问题4：Schema迁移失败

**解决方案**：
- 检查 `init_db.py` 中的迁移逻辑
- 查看日志中的具体错误信息
- 确保新版本代码支持旧数据库Schema

## 📞 需要帮助？

如果迁移过程中遇到问题：

1. 查看Zeabur容器日志
2. 检查环境变量配置
3. 验证Volume挂载状态
4. 参考 `DEPLOY.md` 中的故障排查部分

