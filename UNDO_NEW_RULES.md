# 撤销命令的新规则定义

## 📋 核心规则（已更新）

### 1. 只能撤销当天的操作 ✅

**定义**: 撤销命令只能撤销当天（根据日切时间）执行的操作，不能撤销昨天或更早的操作。

**实现方式**:
- 使用 `get_daily_period_date()` 获取当天日期
- 在 `get_last_operation()` 函数中添加日期过滤条件：`DATE(created_at) = ?`
- 只查询当天的操作记录

**提示信息**:
- 群聊: `❌ No undoable operation in this group chat today (<日期>). Note: /undo command can only undo today's operations executed in the current chat environment.`
- 私聊: `❌ 在当前私聊环境中今天（<日期>）没有可撤销的操作。提示：/undo 命令只能撤销当天在当前聊天环境（私聊或群聊）中执行的上一个操作。`

**原因**: 
- 防止误操作历史数据
- 确保数据一致性和可追溯性
- 符合日切逻辑

---

### 2. 不限制操作类型 ✅

**定义**: 撤销命令不限制操作类型，可以撤销任何类型的操作。

**实现方式**:
- 移除了操作类型检查的限制
- 对于支持数据回滚的操作类型，执行完整的数据回滚
- 对于不支持数据回滚的操作类型，仅标记为已撤销，不进行数据回滚

**支持完整数据回滚的操作类型**:
- ✅ `interest` - 利息收入
- ✅ `principal_reduction` - 本金减少
- ✅ `expense` - 开销记录
- ✅ `order_completed` - 订单完成
- ✅ `order_breach_end` - 违约完成
- ✅ `order_created` - 订单创建
- ✅ `order_state_change` - 订单状态变更

**不支持数据回滚但可标记为已撤销的操作类型**:
- ⚠️ 其他所有操作类型
- 系统会提示用户该操作类型不支持数据回滚
- 操作会被标记为已撤销，但不会进行数据回滚

**提示信息**:
- 群聊: `✅ Operation marked as undone: <操作类型> (Note: Data rollback not supported for this operation type)`
- 私聊: `✅ 已标记操作已撤销：<操作类型>（注意：此操作类型不支持数据回滚）`

**原因**:
- 提供更大的灵活性
- 允许撤销任何操作，即使不支持数据回滚
- 保持操作历史的完整性

---

### 3. 撤销只针对当前的聊天环境 ✅

**定义**: 撤销命令只能撤销在当前聊天环境（群组或私聊）中执行的操作，不能跨聊天环境撤销。

**实现方式**:
- 在 `get_last_operation()` 函数中添加 `chat_id` 过滤条件
- 双重验证：确保操作的 `chat_id` 与当前聊天环境的 `chat_id` 完全匹配
- 如果 `chat_id` 不匹配，拒绝撤销操作

**提示信息**:
- 群聊: `❌ Security check failed: Operation does not belong to this group chat. Note: /undo command can only undo operations executed in the current chat environment.`
- 私聊: `❌ 安全验证失败：操作不属于当前聊天环境。提示：/undo 命令只能撤销在当前聊天环境（私聊或群聊）中执行的操作。`

**常见场景**:
- 在群组A中执行操作，但在群组B中使用撤销 → ❌ 失败
- 在私聊中执行操作，但在群组中使用撤销 → ❌ 失败
- 在群组中执行操作，但在私聊中使用撤销 → ❌ 失败
- 在群组A中执行操作，在群组A中使用撤销 → ✅ 成功

**原因**:
- 确保数据安全性
- 防止误操作其他群组的数据
- 保持操作环境的隔离性

---

## 🔄 规则变更对比

### 变更前
1. ❌ 可以撤销任何日期的操作
2. ❌ 限制操作类型，不支持的操作类型无法撤销
3. ✅ 撤销只针对当前的聊天环境（已实现）

### 变更后
1. ✅ **只能撤销当天的操作**（新增限制）
2. ✅ **不限制操作类型**（移除限制，但部分不支持数据回滚）
3. ✅ **撤销只针对当前的聊天环境**（保持不变）

---

## 📝 使用示例

### 示例1: 撤销当天的操作 ✅
```
用户: /undo
系统: ✅ 已撤销利息收入 100.00
```

### 示例2: 尝试撤销昨天的操作 ❌
```
用户: /undo
系统: ❌ 在当前私聊环境中今天（2025-01-16）没有可撤销的操作
```

### 示例3: 撤销不支持数据回滚的操作类型 ✅
```
用户: /undo
系统: ✅ 已标记操作已撤销：operation_undo（注意：此操作类型不支持数据回滚）
```

### 示例4: 在错误的聊天环境中使用撤销 ❌
```
用户在群组A中执行操作，在群组B中使用撤销
系统: ❌ Security check failed: Operation does not belong to this group chat.
```

---

## ⚠️ 注意事项

1. **日期判断**: 使用 `get_daily_period_date()` 判断当天日期，考虑日切时间（23:00）
2. **数据回滚**: 不支持数据回滚的操作类型只会标记为已撤销，不会修改统计数据
3. **操作历史**: 所有撤销操作都会记录在操作历史中，包括不支持数据回滚的操作
4. **管理员通知**: 所有撤销操作都会通知管理员，无论是否支持数据回滚

---

**总结**: 新的规则定义提供了更严格的时间限制（只能撤销当天操作），更灵活的操作类型支持（不限制操作类型），以及保持不变的环境隔离（只针对当前聊天环境）。

