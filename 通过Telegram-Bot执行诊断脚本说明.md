# 通过 Telegram Bot 执行诊断脚本 - 使用说明

## 🎉 新功能：无需访问 Web Shell 即可执行诊断

现在你可以直接在 Telegram Bot 中运行数据不一致诊断脚本，无需登录 Zeabur Web Shell！

## 📋 使用方法

### 基本用法

在 Telegram 私聊中向 Bot 发送命令：

```
/check_mismatch
```

这会检查今天的数据不一致问题。

### 检查指定日期

```
/check_mismatch 2025-12-02
```

这会检查 2025-12-02 这一天的数据不一致问题。

## 🔐 权限要求

- ✅ **仅限管理员**：只有管理员可以使用此命令
- ✅ **私聊**：只能在私聊中使用，不能在群组中使用

## 📊 输出说明

### 1. 执行中提示

当你发送命令后，Bot 会立即回复：
```
🔍 正在检查数据不一致问题，请稍候...
```

### 2. 完整输出

脚本执行完成后，Bot 会发送完整的诊断报告，包括：
- 收入明细按类型统计
- 收入明细按归属ID统计
- 统计数据对比
- 差异分析（标出不一致的数据）
- 详细记录列表

### 3. 长输出处理

如果输出内容较长（超过 4000 字符），Bot 会自动分段发送：
- 第一段：完整显示
- 后续段：标记为 `[第 2 段]`、`[第 3 段]` 等
- 最后：发送总结，突出显示不一致的数据

### 4. 关键信息标记

Bot 会特别标记：
- `✅ 一致` - 数据一致，没有问题
- `⚠️ 不一致!` - 发现数据不一致，需要关注

## 📝 使用示例

### 示例 1：检查今天的数据

```
你: /check_mismatch

Bot: 🔍 正在检查数据不一致问题，请稍候...
Bot: [完整的诊断报告...]
```

### 示例 2：检查指定日期

```
你: /check_mismatch 2025-12-02

Bot: 🔍 正在检查数据不一致问题，请稍候...
Bot: [完整的诊断报告...]
```

### 示例 3：输出结果示例

```
📊 诊断完成

各归属ID的利息收入对比:
──────────────────────────────────────────────────────

S01:
  收入明细: 10 笔, 5,000.00 元
  统计表: 3,765.44 元
  差异: 1,234.56 元  ⚠️ 不一致! (收入明细多 1,234.56)

总计对比:
  收入明细总计: 10,000.00 元
  统计表总计: 8,765.44 元
  总差异: 1,234.56 元
  ⚠️ 不一致!
```

## ⚠️ 注意事项

1. **执行时间**：脚本执行可能需要几秒钟，请耐心等待
2. **输出长度**：如果数据量很大，输出可能会很长，Bot 会自动分段
3. **权限限制**：只有管理员可以使用此命令
4. **日期格式**：日期格式为 `YYYY-MM-DD`，例如：`2025-12-02`

## 🆚 与其他方法的对比

| 方法 | 优点 | 缺点 |
|------|------|------|
| **Telegram Bot 命令**（新） | ✅ 简单方便<br>✅ 无需登录 Web Shell<br>✅ 随时随地可用<br>✅ 自动分段显示 | ❌ 需要管理员权限<br>❌ 只能在私聊使用 |
| Zeabur Web Shell | ✅ 可以直接操作服务器<br>✅ 可以保存输出到文件 | ❌ 需要登录 Zeabur<br>❌ 需要找到 Web Shell<br>❌ 操作相对复杂 |

## 🔧 故障排查

### 问题 1：命令无响应

**可能原因**：
- 你不是管理员
- 在群组中使用了命令（应该在私聊中使用）

**解决方法**：
- 确认你是管理员
- 在私聊中发送命令

### 问题 2：执行失败

**可能原因**：
- 脚本文件不存在
- 数据库连接失败
- 日期格式错误

**解决方法**：
- 检查代码是否正确部署
- 确认数据库文件存在
- 检查日期格式是否正确（YYYY-MM-DD）

### 问题 3：输出不完整

**可能原因**：
- 数据量很大，输出被分段
- Telegram 消息长度限制

**解决方法**：
- 查看所有分段的消息
- 查看最后的总结消息

## 📞 需要帮助？

如果遇到问题：
1. 检查你是否是管理员
2. 确认在私聊中发送命令
3. 检查日期格式是否正确
4. 查看 Bot 返回的错误信息

## 🎯 快速开始

1. 打开 Telegram
2. 找到你的 Bot
3. 在私聊中发送：`/check_mismatch`
4. 等待结果返回

就这么简单！🎉

