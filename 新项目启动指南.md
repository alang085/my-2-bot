# 新项目启动指南

本指南将帮助你从头开始设置和运行这个 Telegram 订单管理机器人项目。

## 📋 目录

1. [环境准备](#环境准备)
2. [获取必要信息](#获取必要信息)
3. [项目初始化](#项目初始化)
4. [配置项目](#配置项目)
5. [初始化数据库](#初始化数据库)
6. [运行项目](#运行项目)
7. [验证安装](#验证安装)
8. [常见问题](#常见问题)

---

## 🔧 环境准备

### 1. 检查 Python 版本

确保你的系统已安装 Python 3.8 或更高版本：

```bash
python --version
# 或
python3 --version
```

**推荐版本：** Python 3.9 或更高

### 2. 创建虚拟环境（推荐）

使用虚拟环境可以避免依赖冲突：

#### Windows PowerShell
```powershell
# 创建虚拟环境
python -m venv venv

# 激活虚拟环境
.\venv\Scripts\Activate.ps1
```

#### Windows CMD
```cmd
# 创建虚拟环境
python -m venv venv

# 激活虚拟环境
venv\Scripts\activate.bat
```

#### Linux/Mac
```bash
# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate
```

激活成功后，命令行提示符前会显示 `(venv)`。

---

## 🔑 获取必要信息

### 1. 获取 Telegram Bot Token

1. 在 Telegram 中搜索 `@BotFather`
2. 发送 `/newbot` 创建新机器人
   - 输入机器人名称（例如：我的订单管理机器人）
   - 输入机器人用户名（必须以 `bot` 结尾，例如：`my_order_bot`）
3. BotFather 会返回你的 Bot Token（格式：`1234567890:ABCdefGHIjklMNOpqrsTUVwxyz`）
4. **重要：** 保存好这个 Token，不要泄露给他人

**或者使用已有机器人：**
- 发送 `/mybots` 给 BotFather
- 选择你的机器人
- 点击 `API Token` 查看 Token

### 2. 获取你的用户 ID

1. 在 Telegram 中搜索 `@userinfobot`
2. 发送任意消息
3. 机器人会回复你的用户 ID（纯数字，例如：`123456789`）
4. 记录这个 ID，稍后需要用到

**如果有多个管理员：** 重复上述步骤获取所有管理员的用户 ID

---

## 📦 项目初始化

### 方式一：克隆现有项目（如果从 Git 仓库）

```bash
git clone <仓库地址>
cd loan005.bot
```

### 方式二：使用现有项目文件

如果你已经有项目文件，直接进入项目目录：

```bash
cd loan005.bot
```

### 安装依赖

在项目根目录下运行：

```bash
pip install -r requirements.txt
```

**依赖包包括：**
- `python-telegram-bot>=20.0` - Telegram Bot API
- `pytz>=2023.3` - 时区处理
- `APScheduler>=3.10.0` - 定时任务调度

---

## ⚙️ 配置项目

### 方法一：使用配置文件（推荐）

1. **复制配置文件模板：**

```bash
# Windows PowerShell
Copy-Item user_config.example.py user_config.py

# Windows CMD
copy user_config.example.py user_config.py

# Linux/Mac
cp user_config.example.py user_config.py
```

2. **编辑 `user_config.py` 文件：**

```python
# Telegram Bot Token
BOT_TOKEN = '你的机器人Token'

# 管理员用户ID列表（多个ID用逗号分隔）
ADMIN_USER_IDS = '你的用户ID1,你的用户ID2'
```

**示例：**
```python
BOT_TOKEN = '1234567890:ABCdefGHIjklMNOpqrsTUVwxyz'
ADMIN_USER_IDS = '123456789,987654321'
```

### 方法二：使用环境变量

#### Windows PowerShell
```powershell
$env:BOT_TOKEN="你的机器人Token"
$env:ADMIN_USER_IDS="你的用户ID1,你的用户ID2"
```

#### Windows CMD
```cmd
set BOT_TOKEN=你的机器人Token
set ADMIN_USER_IDS=你的用户ID1,你的用户ID2
```

#### Linux/Mac
```bash
export BOT_TOKEN="你的机器人Token"
export ADMIN_USER_IDS="你的用户ID1,你的用户ID2"
```

**注意：** 使用环境变量时，每次打开新的终端窗口都需要重新设置。

---

## 🗄️ 初始化数据库

运行数据库初始化脚本：

```bash
python init_db.py
```

**这将创建：**
- `loan_bot.db` - SQLite 数据库文件
- 所有必需的数据表：
  - `orders` - 订单表
  - `financial_data` - 全局财务数据表
  - `grouped_data` - 按归属ID分组的财务数据表
  - `daily_data` - 日结数据表
  - `payment_accounts` - 支付账户表
  - `employees` - 员工表
  - `attributions` - 归属ID表
  - `scheduled_broadcasts` - 定时播报表
  - `expense_records` - 开销记录表

**成功输出示例：**
```
✅ 数据库初始化完成
✅ 已创建所有数据表
```

---

## 🚀 运行项目

### 启动机器人

```bash
python main.py
```

**成功启动的提示信息：**
```
🤖 机器人启动中...
📋 管理员数量: 1
📦 检查数据库...
✅ 数据库已就绪
✅ 机器人已启动，等待消息...
```

### 后台运行（可选）

#### Windows PowerShell
```powershell
Start-Process python -ArgumentList "main.py" -WindowStyle Hidden
```

#### Linux/Mac
```bash
nohup python main.py > bot.log 2>&1 &
```

---

## ✅ 验证安装

### 1. 测试私聊功能

1. 在 Telegram 中找到你的机器人（搜索你创建的用户名）
2. 点击 "开始" 或发送 `/start`
3. 机器人应该回复帮助信息

### 2. 测试群组功能

1. 创建一个 Telegram 群组
2. 将机器人添加到群组
3. 给机器人管理员权限（推荐）
4. 在群组中发送 `/create S01 A 10000` 测试创建订单

### 3. 检查数据库

确认 `loan_bot.db` 文件已创建：

```bash
# Windows PowerShell
Test-Path loan_bot.db

# Linux/Mac
ls -l loan_bot.db
```

---

## 📝 项目结构说明

```
loan005.bot/
├── main.py                 # 主程序入口
├── config.py              # 配置加载模块
├── user_config.py         # 用户配置文件（需要创建）
├── user_config.example.py # 配置文件模板
├── requirements.txt       # Python 依赖列表
├── init_db.py            # 数据库初始化脚本
├── db_operations.py      # 数据库操作模块
├── decorators.py         # 装饰器（权限、错误处理）
├── constants.py          # 常量定义
├── handlers/             # 命令处理器
│   ├── command_handlers.py
│   ├── order_handlers.py
│   ├── payment_handlers.py
│   └── ...
├── callbacks/            # 回调处理器
│   ├── main_callback.py
│   ├── order_callbacks.py
│   └── ...
└── utils/                # 工具函数
    ├── order_helpers.py
    ├── message_helpers.py
    └── ...
```

---

## ❓ 常见问题

### Q1: 提示 "BOT_TOKEN 未设置"

**解决方案：**
1. 检查是否创建了 `user_config.py` 文件
2. 确认文件中的 Token 格式正确（字符串，用引号包围）
3. 或者设置环境变量 `BOT_TOKEN`
4. 参考 `user_config.example.py` 文件格式

### Q2: 提示 "ADMIN_USER_IDS 未设置"

**解决方案：**
1. 在 `user_config.py` 中添加 `ADMIN_USER_IDS` 配置
2. 用户ID必须是纯数字，多个ID用逗号分隔
3. 或者设置环境变量 `ADMIN_USER_IDS`

### Q3: Token 无效错误

**解决方案：**
1. 检查 Token 是否完整（没有遗漏字符）
2. 在 @BotFather 中重新获取 Token
3. 确保 Token 没有被撤销
4. 确认 Token 格式正确（包含冒号）

### Q4: 模块导入错误

**解决方案：**
1. 确认已安装所有依赖：`pip install -r requirements.txt`
2. 确认在项目根目录下运行
3. 检查 Python 版本是否符合要求（3.8+）

### Q5: 数据库初始化失败

**解决方案：**
1. 检查是否有写入权限
2. 确认 SQLite 已正确安装
3. 删除旧的 `loan_bot.db` 文件后重新初始化

### Q6: 机器人无响应

**解决方案：**
1. 检查机器人是否在线（查看终端输出）
2. 确认网络连接正常
3. 检查 Token 是否正确
4. 查看终端错误信息

---

## 📚 下一步

配置完成后，你可以：

1. **查看命令帮助：** 在私聊中发送 `/start`
2. **创建订单：** 在群组中使用 `/create <归属ID> <客户A/B> <金额>`
3. **查看报表：** 在私聊中使用 `/report`
4. **搜索订单：** 在私聊中使用 `/search`

**更多文档：**
- `README.md` - 项目基本说明
- `快速开始.md` - 快速配置指南
- `指令解析文档.md` - 详细命令说明
- `代码优化总结.md` - 代码结构说明

---

## 🔒 安全提示

1. **不要将 `user_config.py` 提交到 Git 仓库**
   - 确保 `.gitignore` 中包含 `user_config.py`
   - 只提交 `user_config.example.py`

2. **保护你的 Bot Token**
   - 不要分享给他人
   - 如果泄露，立即在 @BotFather 中撤销并重新生成

3. **定期备份数据库**
   - 定期备份 `loan_bot.db` 文件
   - 可以使用 `export_db.py` 导出数据

---

## 🆘 获取帮助

如果遇到问题：

1. 查看项目文档（`README.md`、`快速开始.md` 等）
2. 检查终端错误信息
3. 查看日志输出
4. 参考 Telegram Bot API 官方文档

---

**祝你使用愉快！** 🎉



