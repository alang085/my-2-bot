# 部署执行步骤

## ⚠️ 重要：已修复敏感文件问题

`config.py` 已从 Git 跟踪中移除，但仍在 `.gitignore` 中，不会被提交。

## 🚀 执行部署

### 方法1: 使用部署脚本（推荐）

**Windows:**
```bash
deploy_to_zeabur.bat
```

**Linux/Mac:**
```bash
chmod +x deploy_to_zeabur.sh
./deploy_to_zeabur.sh
```

### 方法2: 手动执行

```bash
# 1. 检查状态
git status

# 2. 添加所有更改（config.py 会被自动忽略）
git add .

# 3. 提交更改
git commit -m "Update: Excel报表权限扩展到员工，优化代码，准备生产环境部署

- Excel报表权限扩展到员工（预览、查看、导出）
- 合并功能保持管理员权限
- 优化代码质量
- 完善测试和文档
- 准备第一次整体报表录入"

# 4. 推送到远程仓库
git push origin main
```

## ✅ 部署前最后检查

### 1. 确认敏感文件已忽略
```bash
# 应该没有输出（或显示已删除）
git ls-files config.py user_config.py
```

### 2. 确认必要文件存在
- ✅ `main.py`
- ✅ `init_db.py`
- ✅ `requirements.txt`
- ✅ `Procfile`
- ✅ `Dockerfile`
- ✅ `zeabur.json`

### 3. 确认代码测试通过
```bash
# 运行测试（可选，但推荐）
python test_all_excel_reports.py
```

## 📋 本次更新内容

### 功能更新
1. ✅ Excel报表权限扩展到员工
   - 增量报表预览：员工权限
   - 每日数据变更表：员工权限
   - 订单总表：员工权限

2. ✅ 合并功能保持管理员权限
   - 合并增量报表：仅管理员
   - 合并回调：仅管理员

3. ✅ 代码优化
   - 统一使用装饰器
   - 完善错误处理
   - 优化代码结构

### 新增文件
- `handlers/daily_changes_handlers.py` - 每日数据变更表处理器
- `callbacks/incremental_merge_callbacks.py` - 增量报表合并回调
- `utils/incremental_report_generator.py` - 增量报表生成器
- `utils/incremental_report_merger.py` - 增量报表合并器
- 多个测试脚本和文档

### 数据库更新
- 新增 `baseline_report` 表
- 新增 `incremental_merge_records` 表
- 自动迁移，不影响现有数据

## 🔍 部署后验证

### 1. 基本功能
```
/start - 查看帮助信息
```

### 2. Excel报表功能（员工权限）
```
/preview_incremental - 预览增量报表
/daily_changes - 查看每日数据变更
/ordertable - 导出订单总表
```

### 3. 合并功能（管理员权限）
```
/merge_incremental - 合并增量报表
```

### 4. 检查定时任务
- 增量报表：每天11:05自动发送
- 日切报表：每天23:00自动发送

## ⚠️ 部署后重要操作

### 1. 设置基准日期（如果未设置）

**方法1: 通过数据库**
```sql
-- 如果表已存在，更新
UPDATE baseline_report 
SET baseline_date = '2025-12-16',  -- 修改为实际日期
    updated_at = CURRENT_TIMESTAMP 
WHERE id = 1;

-- 如果表不存在，插入
INSERT INTO baseline_report (id, baseline_date) 
VALUES (1, '2025-12-16');  -- 修改为实际日期
```

**方法2: 通过命令**
```
/preview_incremental - 会自动创建基准日期
```

### 2. 验证环境变量
在 Zeabur Dashboard 中确认：
- `BOT_TOKEN` - 机器人Token
- `ADMIN_USER_IDS` - 管理员用户ID
- `DATA_DIR=/data` - 数据目录

### 3. 验证Volume配置
- Mount Path: `/data`
- Size: 1GB（或根据需要）

## 📚 相关文档

- `快速部署指南.md` - 快速部署步骤
- `部署前检查清单.md` - 详细检查清单
- `DEPLOY.md` - 完整部署指南
- `生产环境部署检查清单.md` - 生产环境检查
- `第一次整体报表录入指南.md` - 第一次录入指南

## ✅ 准备就绪

所有代码已优化，测试通过，文档完整。

**可以开始部署！**

